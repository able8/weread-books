## Java持续交付
> 张若飞

### 译者序

如果Java开发人员能够越早跳出自己的舒适区，并从宏观和细节层面了解开发软件的生命周期，就越能够快速地在开发过程中不断得到反馈和进行构建。他们无疑将会更好地跟上时代发展的潮流，更快地提升自己的业务水平。

### 前言

部署平台也有了突飞猛进的发展，云计算和容器的出现带来了许多机会和挑战。但是，有一件事始终没有发生过变化，那就是将价值交付给终端的客户。我们需要尽可能地使用所有的技能、工具和经验，将软件尽可能有效（以及有趣）地交付给用户。

架构设计
正确实现一个松耦合、高内聚的系统架构，会对持续测试和组件部署产生巨大的帮助。

作为一名Java开发者，应该早日跳出自己的舒适区，去学习更多有关架构、自动化和运维的知识。在如今的软件开发行业中，我们看到纯Java编程的职位已经变得越来越少，而许多新职位都需要掌握持续交付、平台和运维工具等知识。通过不断增加软件开发的知识和技能，你获得的将不只是更多的工作机会，还会成为一个更好的编程人员。

### 入门知识

持续交付（Continuous Delivery, CD）是一套实践和准则，能够让团队在短时间内交付有价值的、稳定的软件。

### 赋能开发者：为什么我们要持续交付

“为什么”。作为一名Java开发人员，我们为什么要将宝贵的时间用在持续交付和创建构建管道上呢？

持续、快速和高质量的反馈能够更早地发现和修复错误。这也使得问题的影响范围更小、代价更低，并且更容易被修复。

所有行业的组织都会逐渐抛弃交付周期较长的大型项目，转为采用短周期的小型团队，通过不断收集用户的反馈意见，打造能够满足客户需求并快速交付价值的产品。除了技术方面的指标，你还可以与业务团队密切合作，收集反馈，从而确定需要实现的关键绩效指标（KPI）和相关指标。

在持续交付的安全验证或者验收测试阶段，我们经常听到别人谈论“左移（Shifting Left）”原则。“左移”原则的核心思想是，将那些通常在较晚阶段完成的工作，尽早提前完成，这样可以提高交付的质量，或者降低那些在交付最后阶段发现的问题的修复成本

但是，不可靠的、碎片化的部署，会更加迅速地摧毁团队的士气。反过来，对部署代码的恐惧，又会驱使团队将大量功能集中到一个“大爆炸”的版本中，最终导致这个版本带来更多的问题。我们必须采用小批量、不断交付功能（理想情况下，甚至采用一个功能一发布的流程）的方式，来打破这种恶性循环。

### 什么是构建管道

通过工具将代码自动构建并打包成一个构件（Artifact）。在CI阶段之后，生成的构件将被提交给一系列自动化的功能测试，然后再经过人工验收测试阶段，逐步进入类似生产环境的预发布环境。

图1-1：一个常见的Java持续交付（CD）构建管道

持续集成
在管道的这一阶段中，更改了代码或者配置的软件应用会进入持续集成（CI）的流程。通过版本控制系统（VCS）中trunk或者master分支中的代码，CI会单独构建出一个构件，对其进行测试，同时也可能会使用PMD、FindBugs或者SonarQube等工具进行代码质量分析。经过一次成功的CI构建后，我们会将一份新的构件存储在一个集中式的仓库中（例如，Sonatype Nexus或者JFrog Artifactory）。


用户验收测试
在这个阶段，测试人员或者实际用户会进行探索性的手动测试。这种测试应该关注用户感知的方面，而不仅仅是执行大量的测试脚本。（通过脚本来验证功能这种重复的行为，非常适合计算机自动执行。）

预发布环境
一旦修改的代码或配置通过了验收测试，以及其他基础性的质量保证（QA）测试，那么该构件就会被部署到一个预发布环境中。这个环境通常与生产环境几乎一样，事实上某些组织会克隆一个生产环境，甚至就是在生产环境中进行测试

观察和维护
一旦代码被部署到生产环境，无论是为了创建一个商业和技术的正反馈循环，还是为了帮助调试生产环境中可能出现的问题，你都应该保持对应用进行观察，包括监控、日志和报警。

图1-2：一个使用容器技术的Java持续交付构建管道

### 总结

· 一个CD的构建管道包括本地开发、代码提交、构建、代码质量分析、打包、QA和验收测试、非功能性（系统质量）测试、发布以及观察等阶段。

### 第2章 Java开发的演化

最后，你还会了解持续交付与“人”和“软技能”有关的内容，主要是如何提高软件开发人员和运维人员之间的共享责任，例如，DevOps和站点可靠性工程（SRE）方法。


### 现代Java应用程序的需求

匠人精神

当软件稳定性和开发速度可以满足业务需要时，就算是持续交付。

人们可能还没有意识到API将成为未来技术的核心，以及每个人日常生活的一部分。API将继续在聊天机器人、虚拟助理、物联网（IoT）、移动服务等行业发展中发挥核心的作用。

应该说，2006年3月亚马逊Web服务（AWS）的发布，正式揭开了云计算革命的序幕。

### Java部署平台的演化

Java原本的打包格式是Java应用程序归档（JAR）文件，它可以包含依赖库的代码或者一个可运行的构件。

尽管Linux容器技术已经存在很长一段时间了，但2013年3月Docker的出现才让大众认识到了这项技术。容器的核心是Linux中的各项技术，例如cgroups、命名空间和（pivot）根文件系统。

### DevOps、SRE和发布工程

DevOps并不只是代表了“开发”和“运维”的结合，用“Business-Development-QA-Security-Operations”（BizDevQaSecOps）这个词可能更加合适，但是实在太拗口了。

DevOps的核心是一套软件开发和交付的理念，它强调产品管理、软件开发和运维/系统管理员团队之间的沟通和协作，并且需要与业务目标紧密结合。DevOps通过软件集成、测试、部署和基础设施变更等流程的自动化和实时监控，建立一种文化（和相关的实践方式），让人们相信可以更快、更频繁、更可靠地构建、测试和发布软件。

DevOps是开发和运维（以及更多方面）的一个结合

通常，一个SRE团队会负责可用性、延迟、性能、效率、变更管理、监控、紧急响应和容量规划等内容。

Google SRE团队的一个关键特征是，每个工程师最多只负责50%!的(MISSING)运维工作，或者是他们口中的“苦活累活”，其余的时间都应该花在设计和构建各种自动化系统和配套工具上。

在理想情况下，人们应该永远不需要理解任何报警内容，应该由编写的软件来代劳，你只需要在应该采取措施时收到相应的通知。因此，SRE指出只有三种有效的监控输出。
报警
表示人们必须立刻进行操作。一些故障正在或者即将发生，需要有人立即做出操作来改善情况。

根据Google SRE的介绍，发布工程师需要对多个领域具有深入的了解，包括开发、配置管理、测试集成、系统管理和客户支持。

Google SRE的工作手册根据所需的技能组合，总结了以下几个基本原则：
· 可重复构建
· 自动化构建
· 自动化测试
· 自动化部署
· 小型部署

Google是第一个采用容器化技术来实现快速部署和灵活编排服务的公司；

· 增加开发、QA和运维（甚至可以说是整个组织）的共享责任，对于成功实施持续交付至关重要。

· 软件构建、部署和运维指标的定义、收集和分析，对于持续交付至关重要。它们可以帮助组织了解系统的当前情况以及成功目标，并帮助记录和监控实现这一目标的过程。
· 自动化对于可靠地构建、测试和部署软件至关重要。

Netflix的全周期开发人员

### 优秀架构的基础

松耦合系统指的是系统中每个组件很少知道或者不知道其他独立组件的定义。松耦合系统的一个明显优点是，其中的组件可以被其他提供相同功能的组件替代。编程中的松耦合，通常被理解为封装或者信息隐藏。

具有高内聚的模块往往表现更好，因为高内聚可以带来更好的稳定性、可靠性、可重用性和可理解性。

如果在端到端测试中确实发生了不可避免的问题，高内聚的系统通常会更加容易诊断和调试，因为功能在逻辑上都是有关联的。

### 面向业务敏捷的架构

架构不好的另一个隐性成本是，你不得不花费大量时间来修补系统，而没有时间创新。如果你的时间都像“打地鼠”一样用来解决各种软件bug，而不是开发新的功能，那么你肯定知道架构是有问题的。良好的软件架构会降低bug出现的可能，并且降低bug带来的负面后果，这样的系统会把错误“包裹”起来，并且能够通过架构所提供的机制，用最小的成本来解决任何问题。良好的架构也更加鼓励创新，因为它更清楚需要如何来支持创新，架构本身也可以成为创新的催化剂，让你看到隐藏在表面之下的机会。

### 部署平台和架构

· 使用声明式格式来建立自动化，最大限度减少新人加入项目的时间和成本。

· 适于部署在现代的云平台上，最大限度减少对服务器和系统管理的需要。
· 最大限度地减少开发环境和生产环境之间的差异，使持续部署实现最大的灵活性。

3．配置：在环境中存储配置
Twelve-Factor App建议通过环境变量将配置信息注入应用程序。实际上，许多Java开发人员更喜欢使用配置文件来管理这些变量，而且在构建包含密码的VM或者容器时，通过环境变量来指定密码可能会存在潜在的安全问题。

将非敏感的配置数据存储在Spring Cloud Config（基于Git或Consul）等远程服务中，并且将密码存储在HashiCorp的Vault服务中，既可以满足Twelve-Factor的建议，也符合当前的最佳实践。

了解赛车的运作方式会让你成为更好的赛车手，同样，程序员如果理解计算机硬件的工作原理也会有助于编程。你不一定需要获得计算机科学学位或者成为一名硬件工程师，但是你确实需要了解硬件的工作原理，并在设计软件时考虑这一点。

### 越来越小的服务

单体应用程序面临以下三个限制因素：
· 无法快速扩展开发工作。
· 无法隔离子系统，实现独立部署。
· 无法在运维层面上扩展应用程序内部的子系统（隔离、弹性扩展以及按需配置）。

在开发单体应用程序时，所有开发人员都不得不“拥挤在”同一个代码库中。这会导致开发人员必须了解整个代码库，才能逐渐理解正确的上下文。在开发过程中，代码合并冲突几乎是不可避免的，这会导致大量的返工和时间的浪费。

从单体程序中拆分模块，再将这些模块构建为独立的子系统，可以带来更清晰的边界和接口，有助于开发人员理解上下文。服务的独立性也有助于分配相关负责的开发人员。

如果将应用程序设计为一组松耦合、高内聚的子系统，那么可伸缩的能力就会变强。一个承担高负载的子系统，应该可以独立于其他服务独立进行伸缩。

构建遵循UNIX单一责任原则的小型服务，具有明显的好处。如果你设计的服务和工具可以完成一件事并且做得很好，那么你就能很容易地将这些系统组合起来，从而提供更复杂的功能，并且系统的部署和维护也会更加容易。Netflix、eBay和Spotify等大型企业也公开介绍过如何构建小型的微服务架构。

· 对于无服务器，还可以由开发人员编写一些服务端逻辑，但与传统的架构不同，代码运行在无状态的计算容器中，由事件触发、短暂存活（可能仅能调用一次），并且完全由第三方管理。我们将这种方式称为函数即服务（FaaS）。

### 总结

· 软件开发领域出现了一种新的趋势，即设计由多个小型的、可独立部署的（微）服务组成的系统。由于高内聚和松耦合的特性，这些系统会更加适于持续交付。同时，这些系统也需要通过持续交付来保证不断满足新的功能性和非功能性需求，同时避免系统复杂度的急剧增长。

### 传统的基础设施平台

中间件
它是一个位于各个应用软件“之间”的软件，目标是支持和简化复杂的分布式应用程序。

### 云平台

混合云
这是传统的私有虚拟化基础设施与公有云产品的混合产物。主要的公有云服务商也开始为企业提供混合云（或者帮助企业迁移到云服务）的产品

持续交付服务
你会越来越多地看到，虚拟化和云服务商正在提供开箱即用的CD解决方案，例如集成Jenkins的解决方案，

云计算的好处
云计算基础设施带给开发人员的一个核心优势是，一切都是可编程的。你可以将所有的编程知识和技能应用在基础设施上。

· 通过使用HashiCorp Terraform、Ansible或者Puppet等工具，尽可能（理想情况下，最好完全）通过编程方式来管理云平台。

### 容器（Docker）

容器技术
从根本上来说，容器提供了操作系统级别的虚拟化，虽然一台机器上的所有容器都共享一个操作系统内核，但每个容器都有独立的进程和网络命名空间用于分配和控制CPU和内存等资源的控制组（cgroup），以及与底层主机rootfs不同的根文件系统。

### Kubernetes

所有主流的云服务厂商现在都提供完全托管的Kubernetes产品，因此我们强烈建议你不要运行自己的Kubernetes集群，尤其是如果你的团队规模较小，比如少于100名开发人员。云服务商拥有更多运行平台的专业知识和运营经验，能够保障平台的SLA，

### 使用基础设施即代码

我们推荐使用HashiCorp的Terraform来管理云环境和相关配置项（块存储、网络及其他云服务等），以及使用Red Hat的Ansible来管理配置和进行机器实例安装。


### 分解构建过程

最基础的层面来看，你编写的Java代码必须首先被编译为Java字节码，然后才能在Java虚拟机（JVM）上执行。但是，任何复杂的Java应用程序都需要依赖其他外部的东西，其中包括几乎所有地方都要用到的第三方库

测试
使用合适的单元测试框架来测试编译后的源代码。这些测试不需要将代码打包或者部署。
打包
将已编译的代码打包为可分发的格式，例如JAR文件。
确认
检查集成测试的运行结果，确保系统满足质量标准。
安装
将软件包安装到本地仓库中，以便在本地环境中用作其他项目的依赖项。

部署
在构建环境中完成部署，将最终的打包构件复制到远程仓库，以便与其他开发人员和项目共享。

### Java构建工具概述

Gradle
Gradle是一个开源的构建自动化系统，它借鉴了Apache Ant和Apache Maven的概念，并引入了基于Groovy的领域特定语言（DSL），来代替Apache Maven声明式的XML配置。Gradle专门为大型的多项目构建而设计，它通过智能判断构建树的哪些部分是最新的来支持增量式构建，即不需要构建某些重复的任务

### Linux、Bash和基本的CLI命令

netstat
查看（虚拟）机器上所有的网络连接。
iostat
列出连接到（虚拟）机器的所有块设备（磁盘驱动）的I/O统计。
dig or nslookup
提供DNS地址信息。
ping
检查是否可以通过网络访问某个IP或者域名。


### 编写基础脚本

示例6-17：使用xargs下载urls.txt文件中指定的多个文件
￼
    $ xargs -n 1 curl -O < urls.txt

### 总结

· 在本地开发中使用像Vagrant这样的工具，创建保持一致且可重复创建的VM。

· 使用AWS SAM Local中的工具，支持在本地开发FaaS代码和相关基础设施。

### 为什么要持续集成

持续集成（CI）指的是我们经常将新的或者改动后的代码，集成到已有的代码仓库中，同时将所有本地的开发代码，定期合并到一个共享的主线或者主干（trunk）分支中。

CI的主要目的是防止出现集成问题

在如今的CI中，开发团队通常会使用构建服务器来完成构建、自动化测试、验证这一套流程。除了执行单元测试和集成测试之外，构建服务器还可以运行静态或动态的代码检查、测量和评估性能、进行基础的安全校验，以及从源代码中提取和格式化文档。

持续集成以及持续质量保证，目的是为了提高软件的可重复性和稳定性，以及软件的交付速度。在传统的软件交付方法中，测试和质量保证（大部分是手动）是在主要代码编写完成之后才进行的，但是CI有可能在开发周期的早期阶段就发现问题，并提供最佳的实践指导。

### 如何实施CI

一个自动化的构建
你需要通过本地的命令行工具和远程的持续集成环境（构建服务器），自动化运行整个构建流程。

### Git入门

Hub是一个由GitHub团队编写的命令行工具，它对Git进行了封装，提供了额外的功能和扩展命令，使得GitHub变得更容易使用。你可以从git-hub.com/github/hub下载Hub。

Gitflow是一个Git工作流，由Vincent Driessen首次在nvie发表并受到欢迎。Gitflow工作流围绕项目发布定义了严格的分支模型，对于大型团队共享单个代码库的协作非常有用。Gitflow也非常适合已经安排了发布周期的项目，或者希望通过发布列车模式批量部署功能的项目。

Gitflow使用两个分支来记录项目的历史。主分支（master）用来存储正式发布的历史（理想情况下，每次master提交都要包含一个发布版本号），而开发分支（develop）充当各个功能的集成分支，并且包含项目完整的历史记录。

一旦develop分支包含了足够发布的功能（或者临近某次迭代的发布日期），你就可以从开发分支fork出一个release分支。创建release分支意味着将开始下一个发布周期，从现在开始，除了bug修复、文档生成或者其他跟发布有关的变更内容，其他任何新的功能都不能再进入此次发布。当发布内容做好部署准备之后，release分支将合并到master分支，并标记为一个新版本号。除此之外，它还应该被合并回develop分支，因为后者可能在发布过程中也有了新的变更内容。通过使用一个专门发布的分支，一个团队可以结束当前的发布版本，而另一个团队又可以继续开发下一个版本的功能。

### 发动你的团队

在团队中需要强制执行的一个规则是，任何构建失败都应该立即通知（通过仪表板或者诸如Slack之类的IM工具）到相关负责人，要求他们必须立即解决问题。如果他们无法解决问题，那么必须将问题升级，或者要求其他相关团队提供帮助。

### 总结

· 当构建失败时，团队最高优先级的工作应该是解决当前问题。永远不要在构建失败的版本上再提交更多的代码。一旦人们认为构建服务器不可靠，对工作流程和代码质量的遵守也将迅速下降，最终导致出现更严重的问题。

### 分离部署和发布

分离部署和发布
很多人将部署和发布看作同义词。但是，在持续交付的场景下，它们代表着不同的内容。
部署
它是一个技术术语，指的是在生产环境中使用某个服务新的二进制包的行为。
发布
它是一个业务术语，指的是向用户提供某个指定功能的行为。

### 部署应用程序

提供健康检查端点
健康检查端点已经变得非常普遍，许多工具和框架都可以自动生成健康检查端点，甚至不需要你来创建它们。

· 部署新的实例
· 停止旧的实例
· 重新路由

本章前面介绍的“滚动部署”策略就可以用如下几个动作来表示：
1．更新路由，排除一个已有的实例。
2．停止该实例。
3．部署一个新的实例。
4．更新路由，重新引入该实例。
5．重复操作其他所有实例。

1．部署所有新的实例。
2．更新路由指向新的实例。
3．停止所有旧的实例。

### 发布功能

自2016年年底以来，人们开始越来越关注服务网格，这是一个专用的基础设施层，用来让服务与服务之间的通信变得可靠、安全以及快速。

功能开关
功能开关本质上是一组配置选项，用来确定对于一个特定的请求，是否应该向用户公开某个指定的功能。由于它们都只是配置选项，所以它们在不同的环境中可以具有不同的值，因此你可以在测试环境中访问所有的新功能，然后在生产环境中隐藏这些功能，直到它们已经完全准备好。
此外，与其他配置选项一样，你无须重新部署服务就可以修改它们（请参考本章后面的“管理配置和敏感信息”一节）。

semver版本号有三个用点分隔的数字：MAJOR.MINOR.PATCH。当发布库、框架或者工具的新版本时，通常只允许增加这三个数字中的其中一个。

### 管理配置和敏感信息

“打包式”配置
配置应用程序最简单的方法，就是将配置文件与应用程序打包到一起。此外，你还可以将配置文件与代码保存在同一个代码库中，从而跟踪配置的变更记录。这种方式意味着无须任何其他操作，就可以确保应用程序和配置同时被部署，因此方便易行。

基于Spring Boot的项目使用了applications.properties配置文件

初看上去，这种打包配置文件的方法好像只允许有一组配置，不能为不同环境（如测试环境和生产环境）分别使用不同的配置。但是，你打包的配置文件其实可以包含多个配置项或者profile，然后应用程序可以根据参数或者变量指定的环境，来选择使用其中哪一组配置

打包配置还有另一个缺点，由于配置文件是在代码库中进行管理的，因此只有开发人员才能对其进行更改。这对某些配置项（如数据库的连接池参数）有优势，但是在大多数情况下，你可能希望由团队中的其他成员来更改配置。

如何实施外部配置取决于将其置于外部的原因，甚至可能需要针对不同情况采取不同的方案。在Extended Java Shop中，我们为功能开关服务使用了外部配置。虽然可以将功能开关作为application.properties文件（Shopfront服务）中的另一个参数，但是我们决定稍微花点时间，创建一个独立的服务，这样编辑配置时就无须再更改代码。

外部配置还包括在实例中设置环境变量，或者在指定位置建立配置文件等多种形式。

Kubernetes会通过文件或者环境变量将密钥提供给它们。当应用程序读取这些文件或环境变量时，密钥会被自动解密，这样应用程序就可以正常使用它们了。

### 为什么要测试软件

验证软件的质量分为测试功能性需求和测试非功能性需求，其中非功能性需求也被称为跨功能性属性或者系统质量属性。在我们介绍CD管道中的功能性需求测试之前，你首先需要了解测试的各种类型和观点。

### 端到端测试

人为交易的下一个级别是端到端测试。端到端测试与人为交易只是在目标环境上不同，与人为交易类似，端到端测试也会在整个系统上执行，包括依赖的外部组件。但是，与人为交易不同，端到端测试是在专用的测试环境中执行的，而不是在真实的、面向用户的生产环境中。由于端到端测试不会影响到真实的用户，所以你可以更积极地使用它们，在测试中执行更多的操作或者让环境满足你的测试需求。

为了确保每个端到端测试都是有价值的，你应该站在用户的角度，以用户实际使用系统的方式来编写测试（例如，“一个第一次购买某个商品的客户”或者“一个需要审查上季度税收余额的会计师”）。这会让我们对用户最重视的功能拥有信心，同时将其余部分交给其他类型的测试。

端到端测试是一种不全面、高成本的测试方案。一个端到端测试无法检查系统的行为、需要很长时间执行，并且失败概率较高，因此如果测试套件以端到端为主，必然会导致测试覆盖率差、执行时间慢和效果不确定的结果。

### 集成测试

集成测试
集成测试是另一个不同人有不同理解的术语。有些人认为当所有组件组合在一起时，系统就是“集成的”，因此认为“集成测试”应该包含所有的组件。这其实是所谓的端到端测试。

最重要的是，为了测试与外部组件的集成，你不需要测试整个应用程序，只需测试与外部组件连接的点。这不仅可以让你更好地控制测试，还可以使测试更小、更快。

### 自上而下的测试和自下而上的测试

自上而下的测试
自上而下的测试迫使你优先考虑用户体验。你需要首先确定端到端测试和验收测试，分析与其他系统之间的交互需求和限制，并且检查环境是否允许你做想做的事情。

自下而上的测试
从某种程度上讲，自下而上的测试更容易执行。你可能无法想象出整个测试套件的样子，或者也不知道如何将所有组件组合在一起，但是你可以先从知道的开始。也许你对编写一个实现某个功能的类充满信心，那么不妨先从这里开始。

### 总结

用户体验的另一半取决于非功能性的需求，也是下一章我们要介绍的内容。无论你的应用程序如何“正确”，如果它运行缓慢或者经常宕机，用户也不会感到高兴。

### 架构质量

性能和压力测试
知道应用程序及其各个组件的性能特点非常有必要。因此，性能和压力测试是一个必须掌握的重要技能。压力测试既可以在应用程序级别运行，覆盖整个系统，也可以在模块级别运行，覆盖单个服务或者功能。如果能够有效地将二者结合起来，你就可以快速发现单个组件以及整体用户体验的性能趋势。

使用Apache Benchmark进行基本的性能测试
Apache Bench ab工具是一个非常易于使用的性能基准测试工具。它是一个命令行（CLI）工具，通过向指定URL生成大量的请求，然后将相关的性能指标返回给终端。虽然它不是很灵活，但是当你需要快速进行性能测试时，它是一个非常不错的工具。

终端输入ab即可查看可用的参数列表。最常用的-n参数用来指定基准测试会话要执行的请求数，-c参数表示可执行的并发请求数，以及目标的URL。例如，如果你要对Google进行一次性能测试，一共执行10次请求，每次执行2个，可以运行示例12-8所示的命令。

Apache Bench工具非常适合快速的性能测试，但是它缺乏对虚拟用户（发起请求）的配置，也无法创建更复杂的断言。

在我的从业经历中，许多团队认为自己进行了性能测试，但经过仔细检查之后才发现，测试结果向他们撒了谎。基准测试的问题在于，只有在完全相同条件下的测试结果才能用来进行对比。如果你的性能测试环境与生产环境不同，那么性能测试环境下的测试结果，就无法适用于生产环境。

大多数从性能测试获益的团队，其实并不关心基准测试中的某个值，而是通过基准测试来观察是否有意外的变化。当基准测试出现上升或者下降，但是又没有明显的原因时，你就需要开始调查原因了。

### 混乱测试

面向失败设计背后的主要思想是承认任何事情都会出错，因此你需要确保应用程序和基础设施能够处理失败的情况。

3．引入反映真实世界事件的变量，例如崩溃的服务器、发生故障的硬盘驱动器、断开的网络连接等。
4．试着通过寻找对照组和实验组之间稳定状态的差异，来反驳这一假设。
破坏稳定状态越困难，我们对系统稳定性的信心就越大。

### 总结

如何通过监控、日志和跟踪来观察你的系统。

### 可观察性和持续交付

我们希望监控：应用程序、网络和机器

如何观察：监控、日志和跟踪

跟踪
跟踪会捕获请求在遍历（分布式）系统时整个的流转过程，并收集关键节点的元数据和时间耗费。跟踪的例子包括通过API网关的流量、应用程序的请求处理，以及对数据库的查询处理。

· 必须不断地维护报警，如果收到的报警没有意义或者不需要人为干预，那么必须予以纠正或者删除。

### 面向可观察性的系统设计

￼从设计和构建应用程序的第一天就考虑监控

### 指标

Spring Boot Actuator
Spring Boot Actuator是Spring Boot的一个子项目（http://bit.ly/2zzH0BE），它提供了一些应用程序用于生产环境的功能。在Spring Boot应用程序中配置Actuator后，你可以通过调用各种公开的HTTP端点与应用程序进行交互，以及监控应用程序的运行状况、Bean详细信息、版本详细信息、配置、日志详细信息等方面。


· 始终暴露核心JVM的内部指标，例如，堆外和堆内内存的使用情况、垃圾收集器（GC）的运行频率，以及线程的详细信息，包括线程数、当前状态和CPU使用情况。大多数现代的指标框架都内置了这些功能，只需要启用相应的功能即可。

· 报告错误和异常的详细情况。例如，当用户调用某个REST API时，我们需要知道返回HTTP 5xx状态码的请求数量、调用关键第三方依赖服务时出现异常的数量，以及返回给最终用户的异常数量（你应该尽可能减少这些数量）。

### 日志

· 不要将每个细节都记录到日志中。这不仅会降低性能，还会给日志带来很多噪声。如果这样做，将来的代码维护可能不得不修改所有记录日志的地方。
· 相反，请记录下重要的细节信息，特别是整个应用程序的核心处理流程或者分支，因为这有助于调试一些奇怪的问题。

· 考虑对结构化的日志使用JSON格式。这样日志更容易被解析到一个外部的、集中式的日志聚合平台。

### 请求跟踪

图13-2：分解一个请求的跟踪过程，展示了与请求处理相关的父span及子span

### 总结

· 跟踪用于了解请求在经过（分布式）系统时的流向，并且收集关键点的元数据和耗时。

### 持续交付能力

如果我们更深入地了解持续交付的能力，你会发现以下几个要点：
· 对生产环境中的所有构件使用版本控制。
· 自动化部署过程。
· 实现持续集成。
· 使用基于主干的开发方法。
· 实现自动化测试。
· 支持测试数据管理。
· 尽早考虑安全问题。
· 实现持续集成。

### 开展持续交付

第一个阶段是用版本控制来管理一切资源。这种方法在Accelerate一书中也得到了支持，研究表明，版本控制能够提高软件交付的效能，“应用程序代码、系统配置、应用程序配置以及构建和配置脚本”都应存储在版本控制系统中。这不仅可以提高持续交付的效能，还可以提高部署的稳定性。

### 测量持续交付

更新失败率
部署多少次更新之后会出现某种故障。

### 增加推广范围：领导变革

在组织内推动持续交付可能会面临很大的挑战，尤其是当现有交付流程已经存在了一段时间，或者组织还没有感受到必须变革的痛苦（想一想Blockbuster与Netflix）。


### 第15章 持续交付和持续改进

在结束本书之前，你需要了解如何将持续交付的理念推广到整个组织中，以及如何保持持续性的改进。

### 从现在开始

如今，对软件开发人员（尤其是技术主管）的关键要求是要随时了解新的技术、工具和实践方法。从书本中学习、定期阅读博客、观看在线内容和参加会议，都可以让你不断进步。只有当你将所学知识与当前实际情况相结合时，你和团队才可能决定最佳的实践方式，向用户交付更有价值的软件，以及体会构建系统的乐趣。

### 持续交付价值（最重要的目标）

我们最重要的任务是通过快速和持续地交付有价值的软件，来满足客户的需求。

团队中的每个人都应该专注于持续交付有价值的软件，而CD本身的实践可以成为组织变革的催化剂。

### 促进快速反馈和实验

持续、快速和高质量的反馈，为发现和纠正错误提供了早期的机会。从开发人员的角度来看，快速反馈的一个明显优势是降低了上下文切换的成本，同时降低了理解功能片段、底层代码和配置的认知成本。

### 总结

· 在21世纪初期，你可以完全专注于编写Java代码，但是现在你还必须具备一些曾经属于运维领域的技能（或者至少能够理解这些技术）。

· 如果你希望在整个组织中推广持续交付，有两种主要方法：知识分享和成果展示。

### 关于封面

O'Reilly出版的图书的封面上的许多动物都濒临灭绝，它们对我们的世界很重要。

### 推荐语

■你将学会如何设计能在不同平台上持续交付Java应用程序的架构。
■你将学会如何构建应用程序构件，包括胖JAR文件、虚拟机镜像，以及操作系统容器（Docker)镜像。
■你将学会如何使用Jenkins、PMD和FindSecBug等持续集成工具自动化地进行代码质量检查。
■你将学会如何创建一个复杂的构建管道，以及如何设计独立的部署和发布流程。
■你将了解为什么功能测试和系统质量属性测试对于开发和交付非常重要。
■你将学会如何在本地有效地构建和测试应用程序，以及监控生产环境中运行的应用程序。