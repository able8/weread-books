## 云计算原理与实践
> 王伟

### 内容提要

云计算的三大认识角度（商业模式、计算范式、实现方式）、四个关键技术（计算、存储、网络、安全）、四种开发运维维度（云原生应用、云操作系统、云端软件、云计算运维），以及三大应用场景（桌面云、软件开发云、大数据与人工智能）。

### 丛书序二

如何获取、存储、分析、应用这些大数据将是这个时代最热门的话题。

2018年初，华为公司提出新的愿景与使命，即“把数字世界带入每个人、每个家庭、每个组织，构建万物互联的智能世界”，它承载了华为公司的历史使命和社会责任。

### 前言

“云计算”一词出现在2006年左右。当时谷歌（Google）公司的CEO施密特（Eric Schmidt）在一次会议上提出了“云计算”这个概念。如果说是谷歌为云计算命名，那么亚马逊（Amazon）公司则为云计算明确了商业模式。亚马逊在谷歌提出云计算的概念后不久，就正式推出了 EC2云计算服务模式。从此之后各种有关云计算的概念层出不穷，“云计算”开始流行。

云计算技术使大量的硬件资源通过虚拟化技术结合成一个有机整体，再通过数据传输、负载均衡等技术来相互依赖、相互作用，完成预设功能，形成一个标准概念上的“系统”。这个系统的特征，是在物理上分散，在逻辑上集中，即所谓的分布式集中。

；二是通过对不同资源（硬件、应用）进行调度，我们可以基于一个云平台提供多种服务，即各种IaaS、PaaS和 SaaS，以及XaaS（一切皆为服务），满足各类用户的需求。

云计算平台是一种新的计算资源的使用和管理思路。

云计算的出现，创新性地以“分布式集中”的方式，将分散的廉价计算资源组合在一起，发挥“群体”的功能，来应对大用户和大数据的压力，从而形成了新的“机器管理机器”的思路，在技术实现上有完整的体系架构。

分布式系统通过网络将物理上分散的计算资源连接起来解决问题，用网络技术就可以解决分布式系统中的“距离”问题。然后，在网络协同的基础之上建立资源的调度、存储体系，为上层开发打基础。这样，我们就可以针对“计算”“通信”“存储”和“管理”提供一个实现云计算的“通用”方案。

### 1.1 初识云计算

2006年8月，在圣何塞举办的SES（捜索引擎战略）大会上，时任谷歌（Google）公司首席执行官（CEO）的施密特（Eric Schmidt）在回答一个有关互联网的问题时提出了“云计算”这个概念。在施密特态度鲜明地提出“云计算”一词的几周后，亚马逊（Amazon）公司推出了EC2计算云服务。云计算自此出现，从此之后各种有关“云计算”的概念层出不穷，“云计算”开始流行。

云计算是通过互联网从集中的服务器交付个人应用（E-mail、文档处理和演示文稿）和商业应用（销售管理、客户服务和财务管理）。这些服务器共享资源（如存储和处理能力），通过共享，资源能得到更有效的利用，而成本也可以降低80%!～(MISSING)90%!。(MISSING)

对于云计算来说，其提供的主要服务是三种：基础设施即服务（IaaS），提供硬件资源，类似于传统模式下的 CPU、存储器和 I/O；平台即服务（PaaS），提供软件运行的环境，类似于传统编程模式下的操作系统和编程框架；软件即服务（SaaS），提供应用软件功能，类似于传统模式下的应用软件。在云计算模式下，用户不再购买或者买断某种硬件、系统软件或应用软件而成为这些资源的拥有者，而是购买资源的使用时间，按照使用时长付费的计费模式进行消费。

对于用户来说，云计算屏蔽了 IT 的所有细节，用户无须对云端所提供服务的技术基础设施有任何了解或任何控制，甚至根本不用知道提供服务的系统配置和地理位置，只需要“打开开关”（接上网络），坐享其成即可。

云计算描述的是一种新的补给、消费、交付IT服务的模式，该模式基于互联网协议，且不可避免地涉及动态可伸缩且常常是虚拟化了的资源的配置。从某种程度上说，云计算是人们追求对远程计算资源的易访问性的一个副产品。

大型主机的一个特点就是资源集中，计算、存储集中，这是集中计算模式的典型代表。使用大型主机的企业不需要像如今的互联网企业一样单独维护成百上千台服务器，而是把企业的各种业务集中部署，统一管理。主机的用户大都采用终端的模式与主机连接，本地不进行数据的处理和存储，也不需要进行诸如补丁管理、防火墙保护和病毒防范等措施。其实主机系统就是最早的“云”，只不过这些云是面向专门业务、专用网络和特定领域的。

主机计算的用户通常是大型机构，并为关键应用所准备，如人口普查、消费统计、ERP、财务交易等；而云计算则面向普罗大众，可以运行各种各样的大、中、小型应用程序。

分布式计算依赖于分布式系统。分布式系统由通过网络连接的多台计算机组成。每台计算机都拥有独立的处理器及内存。这些计算机互相协作，共同完成一个目标或者计算任务。

在当今的网络时代，非分布式计算的应用已经很少了，只有部分单机运行的程序属于这一范畴，例如文字处理、单机游戏等。

SaaS全称为Software as a service，中文译为“软件即服务”。其实它所表达的也是一种计算模式，就是把软件作为服务。它是一种通过Internet来提供软件的模式，厂商将应用软件统一部署在自己的服务器上，客户可以根据自己的实际需求，通过互联网向厂商订购所需的软件应用服务，按定购的服务多少和时间长短向厂商支付费用，并通过互联网获得厂商提供的服务。用户不用再购买软件，而改为向提供商租用基于Web的软件，来管理企业经营活动，且无须对软件进行维护，服务提供商会全权管理和维护软件。软件厂商在向客户提供互联网应用的同时，也提供软件的离线操作和本地数据存储，让用户随时随地都可以使用其订购的软件和服务。

SaaS 是最重大的一个转变。这种模式把一次性的软件购买收入变成了持续的服务收入，软件提供商不再计算卖了多少份拷贝，而是需要时刻注意有多少付费用户。因此，软件提供商会密切关注自身的服务质量，并对自己的服务功能进行不断地改进，提升自身竞争力。这种模式可以减少盗版并保护知识产权，因为所有的代码都在服务提供商处，用户无法获取，也无法进行软件破解、反编译。

云计算提供的基本服务有三种：一是硬件资源服务；二是运行环境服务；三是应用软件服务。那么用户也可用至少三种方式来使用云平台：一是利用云计算（平台）来保存数据（使用云环境所提供的硬件资源）；二是在云计算平台上运行程序（使用云环境的运行环境）；三是使用云平台上面的应用服务（使用云上布置的应用软件服务，如地图、搜索、邮件等）。

云计算的另外一个重要优势是弹性资源配给。云上面的资源都具有所谓的弹性，即需要多的时候就多，需要少的时候就少。

从而保证既能够满足任何时候任何客户的需求暴增，同时又避免在客户需求低迷时的资源浪费。

总体来看，云计算至少有以下四个优势：按需供应的无限计算资源；无须事先花钱就能使用的IT架构；基于短期的按需付费的资源使用；单机难以提供的事务处理环境。

① 服务应该是随时随地可接入。用户可以在任何时间、任何地点，通过任何可以连接网络的设备来使用服务，而无须考虑应用程序的安装问题，也无须关心这些服务的实现细节。② 服务应永远在线。偶发问题可能出现，但一个真正的云计算服务应时刻保证其可用性和可靠性，即保证随时可通过网络的接入，并正常提供服务。③ 服务拥有足够大的用户群。这就是所谓的“多租赁”，由一个基础平台向多个用户提供服务的“租赁”。

在云计算的发展历史上，一个极为重要的角色是网上书店亚马逊公司。互联网泡沫破裂后，很多数据中心因效率低、成本高、风险大而被迫倒闭

当时，亚马逊公司的数据中心利用率仅为10%!左(MISSING)右，从而导致成本的居高不下，经营处于岌岌可危的状态。经过研究，亚马逊公司发现，采用新的统一的云架构可以带来可观的效率提升。于是，亚马逊公司在 2005 年在其内部首先实施了亚马逊 Web 服务（AWS）效用计算模式。之后，亚马逊公司决定将自己的云计算提供给外部的客户，并在 2006 年开始将 AWS 作为效用计算向外部客户提供。

必要的带宽是云计算普及的一个必要条件。既然把计算和存储都放在了网络的另一侧，那就必然需要用户能够方便地访问到这些数据。

事实上，商业上著名的两个云计算平台——亚马逊公司的AWS和谷歌公司的App Engine都是因处理大数据而催生的。

提高资源利用率，节能降耗：云计算（严格来说是虚拟化）可以将服务器利用率从15%!提(MISSING)高到60%!甚(MISSING)至更高，从而降低单位计算任务的能耗。降低信息系统的维护成本：维护都在一个地点，由专门人员完成。提升 IT 资产的安全态势：安全问题全部集中在一处解决，比分散在无数用户的业务所在地容易得多。提升信息系统的灾备能力：云计算供应商可以为灾备进行集中投资和管理。总而言之，推动云计算出现和发展的动力就是节省、灵活、方便、弹性、无限、按用量计费。

### 1.7 复习材料

GitHub是由克里斯·万斯特拉斯（Chris Wanstrath）、海伊特（P.J.Hyett）与汤姆·普雷斯顿·沃纳（TomPreston-Werner）三位开发者在2008年4月创办，主要提供基于Git的版本托管服务。GitHub目前已经成为最好用的免费开源项目托管站点。

### 2.1 分布式计算概述

集中式计算完全依赖于一台大型的中心计算机的处理能力，这台中心计算机称为主机（Host 或mainframe），与中心计算机相连的终端设备具有各不相同非常低的计算能力。

分布式计算就是将计算任务分摊到大量的计算节点上，一起完成海量的计算任务。而分布式计算的原理和并行计算类似，就是将一个复杂庞大的计算任务适当划分为一个个小任务，任务并行执行，只不过分布式计算会将这些任务分配到不同的计算节点上，每个计算节点只需要完成自己的计算任务即可，可以有效分担海量的计算任务。

分布式计算中计算任务是分摊到各个节点上的。该算法着重解决的是能否分配任务，或如何分配任务的问题。

例如获取对方的计算结果等。一般有两种解决方案：一种是利用消息队列，将节点之间的依赖变成节点之间的消息传递；第二种是利用分布式存储系统，我们可以将节点的执行结果暂时存放在数据库中，其他节点等待或从数据库中获取数据。无论哪种方式只要符合实际需求都是可行的。

### 3.5 实践：OpenStack

OpenStack 提供了一个通用的平台来管理云计算里面的计算（服务器）、存储和网络，甚至应用资源。

OpenStack 官方网站这样描述这个框架：“创建私有云和公有云的开源软件”，以及“OpenStack软件是一个大规模云操作系统”。

在OpenStack云平台上，用户可以做到以下几个方面：充分利用物理服务器、虚拟服务器、网络和存储系统资源；通过租户、配额和用户角色高效管理云资源；提供一个对底层透明的通用的资源控制接口。

### 第4章 虚拟化技术

可以说，没有虚拟化，就没有云和云计算。

### 4.1 虚拟化的定义

大多数服务器的容量利用率不足 15%!，(MISSING)这不仅导致了服务器数量剧增，还增加了部署复杂性。实现服务器虚拟化后，多个操作系统可以作为虚拟机在单台物理服务器上运行，并且每个操作系统都可以访问底层服务器的计算资源，从而解决了效率低下问题。将服务器集群聚合为一项整合资源，可以提高整体效率并降低成本。服务器虚拟化还可以加快工作负载部署速度、提高应用性能并改善可用性。

企业可以快速轻松地向分支机构、外包员工、海外员工以及使用平板电脑的移动工作人员交付虚拟化桌面和应用，从而降低成本并改进服务。

### 4.6 实践：KVM虚拟化技术

KVM的全称是Kernel Virtual Machine，即内核虚拟机。KVM最初是由一个以色列的创业公司Qumranet开发的，是它们的VDI产品的虚拟机。为了简化开发，KVM的开发人员并没有选择从底层开始新写一个 Hypervisor，而是选择基于 Linux 内核，通过加载新的模块使 Linux 内核变成一个Hypervisor

首先查看主机硬件是否支持虚拟化。使用如下命令：grep -E '(vmx|svm)' /proc/cpuinfo若输出结果显示vmx或svm标识，则表示硬件支持KVM虚拟化；反之则不支持，后续步骤无法进行。

### 4.7 轻量级虚拟化

LXC指Linux Containers，其功能通过Cgroups以及Linux命名空间实现，它也是第一套完整的Linux容器管理实现方案。在

Docker项目最初是由一家名为DotCloud的平台（即服务厂商）打造的，后来该公司更名为Docker。Docker在起步阶段使用LXC，而后利用自己的Libcontainer库将其替换下来。与其他容器平台不同，Docker引入了一整套与容器管理相关的生态系统。其中包括一套高效的分层式容器镜像模型、一套全局及本地容器注册表、一个精简化REST API以及一套命令行界面等。

### 5.4 实践：分布式存储系统Ceph

① 统一：意味着Ceph可以以一套存储系统同时提供“对象存储”“块存储”和“文件系统”三种功能，以满足不同应用的需求。

② 分布式：意味着无中心结构和系统规模的无限（至少理论上没有限制）扩展。在实践当中，Ceph可以被部署于成千上万台服务器上。

高可靠性：针对存储系统中的数据而言，即尽可能保证数据不会丢失，也包括数据写入过程中的可靠性，即在用户将数据写入Ceph存储系统的过程中，不会因为意外情况造成数据丢失。

高度自动化：指数据的自动复制、自动均衡、自动故障检测和自动故障恢复。总体而言，这些自动化特性既保证了系统的高度可靠，也保障了在系统规模扩大之后，其运维难度仍能保持在一个相对较低的水平。

高可扩展性：指系统规模和存储容量的可扩展，也包括随着系统节点数增加聚合数据访问带宽的线性扩展，还包括基于功能丰富强大的底层API提供多种功能、支持多种应用的功能性可扩展。

### 6.1 基本概念

现代云计算网络架构从基础设施的构建、网络行为的控制、网络资源的虚拟化到网络功能的管理都做出了一系列解决方案的革新。

交换机（Switch）：作为网络中间节点的一类网络设备，负责将网络数据包在不同端口间转发。可工作在 OSI 模型的第2层或第3层。路由器（Router）：工作于网络层，负责将数据包从源IP向目的IP转发的网络设备。

数据平面（Data Plane）：网络系统中承载数据流量的抽象组件。控制平面（Control Plane）：构建于数据平面之上，网络系统中负责流量转发的逻辑控制的抽象组件。管理平面（Management Plane）：构建于数据平面与控制平面之上，网络系统中直接面向网络管理人员操作的抽象接口组件。

覆盖网络（Overlay Network）是一种在原有网络基础上构建的网络连接抽象及管理的技术。覆盖网络中的节点可以被认为是通过虚拟或逻辑链路相连，其中每个链路对应一条路径（Path）。节点之间也可能通过下层网络中的多个物理连接相连。例如 P2P 网络或 Client/Server 应用这类分布式系统都可视为覆盖网络，因为它们的节点都运行在因特网之上。覆盖网络通常的实现方法是在原有网络的基础上构建隧道（tunnel）。目前常用于构建隧道的网络协议有如下几种。

GRE的实质是创建一个类似于虚拟专用网络（VPN）的专用的、点对点的网络连接。

### 6.2 数据中心网络：云计算的骨架

Mininet是一款基于Python和Linux网络命名空间实现的轻量级网络仿真工具。由于其默认支持OpenFlow实现，经常被用于与软件定义网络相关的网络仿真实验中。

### 6.3 网络虚拟化

构成网络的核心是交换机、路由器以及诸多的网络中间盒。而这些设备的制造规范大多为Cisco、Broadcom等通信厂商所垄断，并不具有开放性与扩展性。因此，长期以来，网络设备的硬件规范和软件规范都十分闭塞。尤其是对于路由协议等标准的支持，用户并没有主导权。

网络功能的扩展与结构的复杂化，使得传统基于IP的简洁网络架构日益臃肿且越来越无法满足高效、灵活的业务承载需求。软件定义网络（Software Defined Networking，SDN）技术是一种新型的网络解决方案，其将网络的控制平面与数据平面分离的理念为网络的发展提供了新的可能。SDN 通过将网络中的数据平面和控制平面分离开来，实现对网络设备的灵活控制。

由于网络设备的所有控制逻辑已经被集中在SDN的中心控制器中，使得网络的灵活性和可控性得到显著增强，编程者可以在控制器上编写策略，例如负载均衡、防火墙、网络地址转换、虚拟专用网络等功能，进而控制下层的设备。可以说，SDN本质上是通过虚拟化及其API暴露硬件的可操控成分，来实现硬件的按需管理，体现了网络管理可编程的思想和核心特性。

### 6.5 实践：用Mininet搭建OpenFlow实验环境

Mininet是一个软件工具，可以借助它在一台计算机上仿真整个的OpenFlow网络。Mininet使用轻量级的基于进程的虚拟化技术（Linux 网络命名空间和 Linux 容器架构），能够在单一的操作系统内核上运行多个主机和交换机（如4096个），它能够创建内核级的和用户空间的OpenFlow交换机、用于控制交换机的控制器和主机，主机之间还可以通过仿真网络进行通信。Mininet使用成对的虚拟以太网卡（Virtual Ethernet，Veth）连接交换机和主机，极大地简化了初始阶段的开发、排错、测试和部署过程。

### 第8章 云原生应用的开发

2015年，谷歌成立了云原生计算基金会（CNCF），目前基金会包括Box、华为、思科、Docker、eBay、IBM、英特尔、红帽、Twitter、VMware、三星等70多家成员，云原生（CloudNative）开始成为应用云化开发的主流方式。云原生是一套技术体系和一套方法论，是从内到外的整体变革，主要包括DevOps、持续交付、微服务、敏捷基础设施、康威定律等，以及根据商业能力对公司进行重组的能力，既包含技术也包含管理，可以说是一系列云技术和企业管理方法的集合，通过实践及与其他工具相结合可以更好地帮助用户实现数字化转型。

### 8.1 云原生的相关概念

云原生的主旨是构建运行在云端的应用程序，致力于使应用程序能够最大限度地利用云计算技术特性的优势，提供更加优质的应用服务。

云原生也是一种构建和运行应用程序的方法，它充分利用了云计算的优势，重点关注如何在云计算交付模式下创建和部署应用程序。

云原生与传统云计算最大的区别在于，传统云计算关注的是如何提供性价比最高的计算、存储、网络资源，而云原生关注的是如何让产品能够支持快速验证业务模式，如何简化复杂的开发流程、提升研发效率，如何保障产品的高可用性让业务无须承受成长之痛，如何实现大规模弹性伸缩轻松应对业务爆发等。

云原生可以改进应用开发的效率，改变企业的组织结构，甚至会在文化层面上直接影响一个公司的决策。另外，云原生也很好解释了云上运行的应用应该具备什么样的架构特性——敏捷性、可扩展性、故障可恢复性。

云原生应用应该具备以下几个关键词：敏捷，可靠，高弹性，易扩展，故障隔离保护，不中断业务持续更新。

应该避免自己亲自去构建应用程序。因此，云原生的首要原则是“云端优先”：寻找云服务模型中可用的功能，并尽可能使用最适合需求的、最有价值的服务，最终将需要自己维护的软件数量减少到最低的、合理的水平。例如，现在很多云服务商都提供了应用程序服务器、数据库、持续集成平台、数据分析服务、人工智能服务、缓存、负载平衡等服务，甚至还有围绕这些服务再构建定制的软件服务，这些都属于云服务的范畴，都可以直接用来开发云原生应用。

基于云计算的开发模式也要考虑如何保证基础资源的提供能够根据代码自动实现需求，并记录变更，保证环境的一致性。使用软件工程中的原则、实践和工具来提供基础资源的生命周期管理，意味着工作人员可以更频繁地构建更强可控或更稳定的基础设施，开发人员可以随时使用一套基础设施来服务于开发、测试、联调和灰度上线等需求。

技术人员部署服务器、管理服务器模板、更新服务器和定义基础设施的模式都是通过代码来完成的，并且是自动化的，不能通过手工安装或克隆的方式来管理服务器资源。运维人员和开发人员一起以资源配置的应用代码为中心，而不再是一台台机器。基础设施通过代码来更改、测试，在每次变更后执行测试的自动化流程中，确保能维持稳定的基础设施服务。

持续集成是指开发人员每提交一次改动，就立刻进行构建和自动化测试，确保业务应用和服务能符合预期，从而可以确定新代码和原有代码能否正确地集成在一起。持续交付是指软件发布的能力，在持续集成完成之后，能够提供到预发布之类的系统上，达到生产环境的条件。持续部署是指使用完全的自动化过程来把每个变更自动提交到测试环境中，然后将应用安全地部署到产品环境中，打通开发、测试、生产的各个环节，自动持续、增量地交付产品，

DevOps从字面上理解只是Dev（开发人员）+ Ops（运维人员），实际上它是一组过程、方法与系统的统称。DevOps 的概念从 2009 年首次提出发展到现在，内容非常丰富，有理论也有实践，包括组织形式、自动化、精益、反馈和分享等不同方面。

（1）组织架构、企业文化与理念等，需要自上而下设计，用于促进开发部门、运维部门和质量保障部门之间的沟通、协作与整合。简单而言，组织形式类似于系统分层设计。（2）自动化是指所有的操作都不需要人工参与，全部依赖系统自动完成，例如上述的持续交付过程必须实现自动化才有可能完成快速迭代。（3）DevOps的出现是由于软件行业日益清晰地认识到，为了按时交付软件产品和服务，开发部门和运维部门必须紧密合作。总之，DevOps强调的是高效组织团队之间如何通过自动化的工具协作和沟通来完成软件的生命周期管理，从而更快、更频繁地交付更稳定的软件，如图8.3所示。

① 单体架构在需求越来越多的时候无法满足其变更要求，开发人员对大量代码的变更会越来越困难，同时也无法很好地评估风险，所以迭代速度慢。② 系统经常会因为某处业务瓶颈导致整个业务瘫痪，架构无法扩展，木桶效应严重，无法满足业务的可用性要求。③ 整体组织效率低下，无法很好地利用资源，存在大量的浪费。

2008 年因为全站瘫痪被迫停业3天后，Netflix公司痛下决心改造，经过近 10 年的努力，实现了从单架构到微服务全球化的变迁，业务达到千倍增长（见图8.4），并产生了一系列的最佳实践。

①微服务是一种架构风格，也是一种服务；②微服务的颗粒比较小，一个大型复杂软件应用由多个微服务组成，例如Netflix目前由500多个微服务组成；③它采用 UNIX 的设计哲学——每种服务只做一件事，是一种松耦合的、能够被独立开发和部署的无状态化服务（独立扩展、升级和可替换）。

由微服务的定义分析可知，一个微服务基本是一个能独立发布的应用服务，因此可以作为独立组件升级、灰度或复用等，对整个大应用的影响也较小。每个服务可以由专门的组织来单独完成，依赖方只要定好输入和输出口即可完全开发，甚至整个团队的组织架构也会更精简，因此沟通成本低、效率高。

根据业务的需求，不同的服务可以根据业务特性进行不同的技术选型，是计算密集型还是I/O密集型应用都可以依赖不同的语言编程模型，各团队可以根据本身的特色独自运作。服务在压力较大时，也可以有更多容错或限流服务。微服务架构确实有很多吸引人的地方，然而它的引入也是有成本的，它并不是“银弹”，使用它会引入更多技术挑战，例如性能延迟、分布式事务、集成测试、故障诊断等。企业需要根据业务的不同阶段进行合理的引入，不能完全为了微服务而“微服务”。

从宏观概念上讲，云原生是不同思想的集合，集目前各种热门技术之大成，根据云原生的内容，可对应图8.6所示的几个关键技术。

在实际的云原生开发过程中，团队需要一个构建和运行云原生应用程序的平台，这个平台需要具有高度自动化和集成化的特点。从具体的技术手段来说，它会涉及微服务、DevOps、持续集成（Continuous Integration，CI）与持续交付（Continuous Delivery，CD）、容器等技术。

1.微服务技术
如前所述，微服务将应用程序开发为一系列小型服务的体系结构，每个服务都实现独立的业务功能，运行在自己的进程中，并通过HTTP API或消息传递进行通信。每个微服务都可以独立于应用程序中的其他服务进行部署、升级、扩展和重新启动，通常作为自动化系统的一部分，能够在不影响最终用户的情况下频繁更新现场应用程序。

图8.6 云原生应用的关键技术

微服务领域有一个著名的“康威定律”：设计系统的组织、最终产生的设计等同于组织之内、之间的沟通结构。这意味着设计系统的企业生产的设计等同于企业内的沟通结构。

简单地说，企业结构等于系统设计

DevOps技术通过自动化软件交付和架构变更的流程，使得构建、测试、发布软件能够更加地快捷、频繁和可靠，

可以把 DevOps 看作开发（软件工程）、技术运营和质量保障（QA）三者的交集。

需要频繁交付的企业可能更需要了解DevOps。如果一个组织要生产面向多种用户、具备多样功能的应用程序，其部署周期必然会很短。这种能力也被称为持续部署，并且经常与精益创业方法联系起来

DevOps的引入对产品交付、测试、功能开发和维护起到意义深远的影响。在缺乏DevOps能力的组织中，开发与运营之间存在着信息“鸿沟”。例如运营人员要求更好的可靠性和安全性，开发人员希望基础设施响应更快，而业务人员的需求则是更快地将更多的特性发布给最终用户使用。这种信息鸿沟就是最常出问题的地方。

DevOps 经常被描述为“开发团队与运营团队之间更具协作性、更高效的关系”。由于团队间协作关系的改善，整个组织的效率因此得到提升，伴随而来的生产环境的风险也得到降低。

容器技术与虚拟机技术相比，拥有更高的资源使用效率，因为它并不需要为每个应用分配单独的操作系统，所以实例规模更小、创建和迁移速度也更快。

容器化最大的好处是保持运行环境的一致性，只要应用可以打包成容器镜像（通常使用 Docker容器），就可以一次编译后，在各处运行。

充分利用云计算技术的优势：采用云端优先策略，从云服务中获取最大价值；实现快速、敏捷、频繁的交付模式；通过技术创新更多地扩展云计算技术的边界。

DevOps、持续交付对应更快的上线速度，即敏捷性；微服务对应可扩展性及故障可恢复性；敏捷基础设施实现了扩展能力的资源层支持；

### 8.2 云原生应用开发实践的12要素

它就是开发云原生应用的“12要素”。“12要素”英文全称是The Twelve-Factor App，最初由Heroku的工程师整理，是集体智慧的总结，其内容如图8.9所示。
根据基于云的软件开发模式，12要素比较贴切地描述了软件应用的原型，并诠释了使用原生云应用架构的原因

这些约定非常重要，从无状态共享到水平扩展，从松耦合架构关系到部署环境，都会用到。基于12要素的上下文关联，软件生产就变成了一个个单一的部署单元；多个联合部署的单元组成一个应用，多个应用之间的关联就可以组成一个复杂的分布式系统应用。

尽管每个应用只对应一个代码库，但可以同时存在多份部署。每份部署相当于运行了一个应用的实例。通常会有一个生产环境、一个或多个预发布环境。此外，每个开发人员都会在自己的本地环境运行一个应用实例，这些都相当于一份部署。

12要素原则下的应用程序不会隐式依赖系统级的类库。它一定通过“依赖清单”，确切地声明所有依赖项。

3.在环境中存储配置
通常，应用的配置在不同部署（预发布、生产环境、开发环境等）间会有很大差异，如下所示。
数据库、Memcached，以及其他后端服务的配置。
第三方服务的证书，如Amazon S3、Twitter等。
每份部署特有的配置，如域名等。

12要素推荐将应用的配置存储于环境变量中（env vars，env）。环境变量可以非常方便地在不同的部署间做修改，却不用改一行代码；与配置文件不同，不小心把它们签入代码库的概率微乎其微；与一些传统的解决配置问题的机制（例如Java的属性配置文件）相比，环境变量与语言和系统无关。配置管理的另一个方面是分组。有时应用会将配置按照特定部署进行分组（或叫做“环境”），例如Rails中的development、test和production环境。这种方法无法轻易扩展，更多部署意味着更多新的环境，例如staging或qa。随着项目的不断深入，开发人员可能还会添加他们自己的环境，例如joes-staging，这将导致各种配置组合的激增，从而给管理部署增加了很多不确定因素。

（1）构建阶段是指将代码仓库转化为可执行包的过程。构建时会使用指定版本的代码，获取和打包依赖项，编译成二进制文件和资源文件。

（2）发布阶段会将构建的结果和当前部署所需配置相结合，并能够立刻在运行环境中投入使用。

（3）运行阶段（或者说“运行时”）是指针对选定的发布版本，在执行环境中启动一系列应用程序进程。

### 8.3 云原生应用开发

原则：云服务优先策略（Cloud-First）。描述：在评估技术解决方案中的服务或组件时，首先要考察目前市面上是否有可用的云服务功能，并优先考虑使用最适合用户需求的云服务。理由：将需要自己负责全新开发的软件模块数量降到最低、最合理水平。例如可以直接利用云端的应用程序平台、数据库、持续集成、持续交付、数据分析服务、缓存服务、负载平衡服务等云服务功能，开发团队仅围绕这些服务构建定制化的软件，将主要的开发精力聚焦在业务功能的实现上。

原则：基础设施即代码（Infrastructure as Code，IaC）。描述：以处理应用程序代码相同的方式来管理基础设施配置以及工作流的定义。理由：通过 API 的方式来构建环境，提供管理和执行运行环境工作流的工具，这使得环境配置可以视为软件功能的一部分。通过管理环境配置代码和应用程序代码，可以获得更好的总体配置管理体验。整个运行时环境都可以用版本化的方式进行管理。

需要使用支持IaC的工具；需要为应用软件及其运行环境编写相应的测试脚本；环境的准备和配置不可以通过手动操作的方式进行。

描述：力求在开发运维过程中做到从构建到发布的全自动化。理由：实现软件构建、环境准备、测试和部署的自动化能力可以使得产品在加速市场化的过程中占据绝对的优势。

而2018年的云原生生态圈的发展包括了以下几个方向：Service Mesh，在Kubernetes上践行微服务架构进行服务治理所必需的组件；Serverless，以FaaS（Function as a Service）为代表的无服务器架构越来越流行；加强数据和智能服务承载能力，例如在 Kubernetes上运行大数据和人工智能应用；简化应用部署与运维，包括云应用的监控与日志收集分析等。Kubernetes 是云原生哲学的体现，通过容器技术和抽象的IaaS接口，屏蔽了底层基础设施的细节和差异，可实现多环境部署并在多环境之间灵活迁移。这样一方面可以实现跨域、多环境的高可用多活灾备，另一方面帮助用户不必被某个云厂商、底层环境所绑定。Kubernetes已经成为PaaS层的重要组成部分，为开发者提供了一种应用程序部署的简单方法。

### 8.5 本章小结

云原生是一种构建和运行应用程序的方法，充分利用了云计算的优势，能够让企业更敏捷地进行创新，以更快速地向市场推广产品和服务。

### 8.6 复习材料

Node.js是一个基于Chrome V8引擎的JavaScript运行环境。Node.js使用了一个事件驱动、非阻塞式I/O的模型，既轻量又高效。Node.js的包管理器npm是全球最大的开源库生态系统

### 9.3 云操作系统概述

云操作系统是指构架于服务器、存储、网络等基础硬件资源和单机操作系统、中间件、数据库等基础软件之上，管理海量的基础硬件、软件资源的云平台综合管理系统。它主要有三个作用，一是管理和驱动海量服务器、存储等基础硬件，将一个数据中心的硬件资源逻辑上整合成一台服务器；二是为云应用软件提供统一、标准的接口；三是管理海量的计算任务以及资源调配和迁移。

### 第11章 云计算运维

超大的规模和超高的复杂度给服务的可靠性、可用性和性能都带来了极大的挑战。近年来，利用人工智能技术解决大规模在线系统服务的运维问题，成为众多云服务与产品的发展趋势。

### 11.1 云服务环境的监控

没有告警机制，云平台在使用过程出现的故障就不能得到及时的处理。这些弊端必然会影响云平台用户的体验。

监控作为云平台中云服务稳定性支持方面的一个重要角色，它能为云平台中的资源调度、故障检测及分析预测等提供强有力的支持，对云平台中云服务质量的提高有着非常重要的作用。为了使运营者能对云平台的总体运行情况有比较清晰的了解和把握，同时便于云平台中资源性能及可用性的及时优化，确保云平台能顺利地为用户提供服务，需要一个高可靠、稳定的监控系统对云平台进行实时监控。通过监控软件，对系统中的重要资源进行监控，发现系统存在的问题及其具体节点，在云平台中的主机或服务发生故障时能主动及时地向系统管理员发出警报，管理员就可以在最短的时间内对系统进行调整恢复，并利用监控得到的数据分析云平台的瓶颈，为云平台的负载均衡提供可靠的支撑。

能从负载、CPU、内存、存储和网络等几个方面对物理节点进行监控。可对云平台中所有物理节点按集群分组并进行监控。可对监控得到的数据进行完整持久保存，以便系统管理员查询及分析，针对一些常见问题提出解决方案和提供历史数据支持。监控系统在发现云平台出现故障时，能及时判断故障的等级并在管理界面提示管理员或发出告警信息通知管理员。对操作系统中特定进程的流量进行监控，确保云平台中网络的通畅。

### 11.2 云监控解决方案

Nagios是一款开源的免费网络监视工具，能有效地监控Windows、Linux和UNIX的主机状态，交换机、路由器等网络设置，以及打印机等设备。在系统或服务状态异常时，它能发出邮件或短信报警，第一时间通知网站运维人员，在状态恢复后同样发出正常的邮件或短信通知。

Zabbix 是一个基于 Web 界面的提供分布式系统监视以及网络监视功能的企业级的开源解决方案。Zabbix能监视各种网络参数，保证服务器系统的安全运营，其提供的通知机制可以令系统管理员快速定位并解决存在的各种问题。Zabbix由两部分构成：Zabbix server与可选组件Zabbix agent。Zabbix server可以通过SNMP、Zabbixagent、ping和端口监视等方法提供对远程服务器、网络状态的监视和数据收集等功能，并且可以运行在Linux、Solaris、HP-UX、AIX、FreeBSD、OpenBSD和OS X等平台上。

Ntop是一种既灵活又功能齐全的用于监控和解决局域网问题的工具。Ntop显示网络的使用情况比其他的网络管理软件更加直观、详细，甚至可以列出每个节点计算机的网络带宽利用率。它同时还提供命令行输入和Web页面，可应用于嵌入式Web服务。Ntop主要包含以下功能：

谈到容器，大部分用户首先会想到LXC（Linux Container），它是一种内核虚拟化技术，是一种操作系统层次上的资源的虚拟化。在 Docker 出现之前，已经有一些公司在使用 LXC 技术。容器技术的使用，大大提升了资源利用率，降低了成本。直接使用 LXC会有些复杂，导致企业使用容器技术具有一定的门槛，而Docker的出现则改变了这一局面。Docker对容器底层的复杂技术做了一个封装，大大降低了使用复杂性，从而降低了使用容器技术的门槛。Docker 给出了一些基本的规范和接口，用户只需熟悉Docker的接口，就能够轻松玩转容器技术。所以Docker的出现大大加快了容器技术的使用普及度，甚至被业界看作容器的规范。

运行Dockerstats命令可以访问运行在用户主机上的所有容器的CPU、内存、网络和磁盘利用率

Docker stats命令实际上是一个对stats应用程序接口（API）端点的命令行界面，stats API暴露了stats命令所有的信息。若要亲自查看，可以运行以下命令：curl --unix-socket /var/run/Docker.sock http:/containers/container_name/stats从输出中可以看到，会有更多的返回信息，它们都使用JSON Array封装，并且可以被第三方工具所接纳。

### 11.3 智能运维

不同于自动化运维依赖人工生成规则，智能运维强调由机器学习算法自动地从海量运维数据（包括事件本身以及运维人员的人工处理日志）中不断地学习、提炼并总结规则。即智能运维在自动化运维的基础上增加了一个基于机器学习的大脑，指挥着监测系统采集大脑决策所需的数据，做出分析、决策并指挥自动化脚本去执行大脑的决策，从而达到运维系统的整体目标。Gartner Report 预测AIOps 的全球部署率将从2017年的10%!增(MISSING)加到2020年的50%!。(MISSING)

职责：运用机器帮助运维人员完成基础性和重复性的基层运维工作；人工处理机器不能处理好的运维难题；基于经验对于较为复杂的运维问题给出最终决策——不断训练机器。

特征：良好的开发语言基础、大数据处理技术能力。职责：数据采集、自动化处理、实现和运用算法等。

### 12.1 桌面云概述

桌面云（Desktop Cloud）：桌面云是一种通过网络将可伸缩的、弹性的共享物理或虚拟资源池按需供应和交付桌面的模式，桌面操作系统运行于共享物理或虚拟资源池，本质上是一种基于云计算的桌面交付模式。在该模式下，通过将计算机桌面进行虚拟化，把个人计算环境集中存储于数据中心，为用户提供按需分配、快速交付的桌面。用户使用终端设备通过网络访问该桌面。

### 12.3 桌面云典型应用案例

传统PC办公桌面存在多种弊端，例如PC桌面对外设难以管控；数据本地存放造成安全隐患；易损坏，可靠性低；分散存储难以监控管理；高能耗、高排放，总体拥有成本高。鉴于以上原因，本项目期望通过借助桌面云技术，建设一套高度信息安全、高可靠、设备轻型化、绿色节能的办公桌面系统。

××监狱新一代基础架构桌面云平台的建成，为××监狱构建新一代高度信息安全、高可靠、设备轻型化、绿色节能的办公桌面系统提供了基础保障，提升了整体IT体系的运维管理能力和效率，同时满足××监狱内外网物理隔离、快速切换、客户端免维护且不驻留数据的业务需求。

### 第13章 软件开发云

DevCloud是集华为研发实践、前沿研发理念、先进研发工具为一体的一站式云端 DevOps平台，为企业及开发者端到端的覆盖软件开发全生命周期的研发工具链服务，以提升软件交付的质量与效率。

### 13.1 软件开发云的概念

（1）云计算提供了近乎无限量的基础设施资源，而且在任何时候都可以立即获得

（2）云计算提供了全新的基础设施资源成本模式，从原来的一次购买变成了按需付费，只需要为自己具体使用的基础设施资源量付费。

（3）云计算让基础设施资源“可编程”。

（1）利用IaaS平台提高开发和测试人员获取基础设施的效率。

（2）利用 DevOps思想和可编程的IaaS资源融合软件开发的各个阶段，打破原来存在的人为割裂，加大整个流程的迭代速度。如前面所述，软件开发过程中一般包括开发、测试、验收和生产几个阶段，每个阶段都可以有自己独立的运行环境，而且每个阶段是由各自独立的人员来负责。在云时代，所有的基础设施和应用程序的运行环境都可以通过自动化流程一体化管理，且所有的部署、交付工作都是自动化完成。因为是一体化管理，各个环境的不一致性就能得到很好的控制，可以极大地避免环境问题导致的开发流程受阻。与此同时，开发人员可以利用IaaS公有云提供的大量低成本资源，更容易地在开发、测试和验收环境中模拟出更多原来只能在生产环境中出现的场景，如大规模的流量压力、大量用户同时在线等。这样可以更早发现系统的性能瓶颈以及设计和实现的缺陷。

（3）通过直接使用大量的通用云服务来减少工作量，加速软件上线周期。毫无疑问，通过直接复用IaaS服务商提供的如数据库服务、监控服务等服务，大大加速了开发和测试流程。当然，要想在开发和测试中利用好这些通用云服务，最好是把自己的开发测试体系和云紧密联系起来。

### 13.5 本章小结

通过软件开发云，可以方便地让用户开展包括项目管理、代码托管、代码检查、编译构建、测试、部署、发布、流水线、Cloud IDE等服务。

### 14.2 初识人工智能

人工智能系统必须以人为本。这些系统是人类设计出的机器，应该按照人类设定的程序逻辑或软件算法通过人类发明的芯片等硬件载体来运行或工作。通过对数据的采集、加工、处理、分析和挖掘，形成有价值的信息流和知识模型，来为人类提供延伸人类能力的服务，以此实现对人类期望的一些“智能行为”的模拟。

人工智能系统应能借助传感器等器件具备对外界环境（包括人类）进行感知的能力，可以像人一样通过视觉、听觉、嗅觉、触觉等接收来自环境的各种信息，并且能够对外界输入产生文字、语音、表情、动作（控制执行机构）等各种类型的反应。借助按钮、键盘、鼠标、屏幕、手势、体态、表情、力反馈、虚拟现实/增强现实等方式，人与机器间可以互动，使机器设备能够越来越“理解”人类乃至与人类共同协作、优势互补。如此以来，人工智能系统就能够帮助人类做人类不擅长、不喜欢但机器能够完成的工作，而人类则适合做更需要创造性、洞察力、想象力、灵活性、多变性乃至用心领悟或需要感情的一些工作。

自动驾驶就是一个典型的使用AI提升汽车智能水平的例子

### 14.3 云计算、大数据与人工智能的关系

AI的兴起，是云计算、大数据演进和成熟的必然结果。AI的核心不仅仅是算法，更是学习，尤其是在大数据环境下充分发挥大数据碎片化认知的优势，降低认知难度，最终实现“数据有价值”的人工智能。做个形象的比喻，如果说云计算是大数据的土壤，那么大数据就是 AI 生长所需要的水分和肥料，而AI就是最终在云计算和大数据的呵护下盛开的花朵。

云计算聚焦在IT基础设施上，负责搭建起资源能够动态调配的“哪里需要到哪里去”的新型舞台；大数据关注于计算能力和存储能力的提升，负责让演出能够以更低的成本和更高的效率去完成；AI则是舞台上的表演者，最终呈献给人们精彩的节目——更高级、更智能化的应用。可以预见的是，在云计算和大数据的有力支撑下，AI 的未来必然是一场光彩夺目的大戏，值得人们期待；而云计算和大数据则会老当益壮，在万物互联的时代持久地散发出独特的魅力。