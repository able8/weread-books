## 跟老男孩学Linux运维：MySQL入门与提高实践
> 老男孩

### 前言

所有互联网网站最大的瓶颈就是企业的后端数据库，而MySQL更是重中之重，谁掌握了数据库技术，谁就能轻松拿到高薪，并且数据库管理岗位比其他岗位更受企业重视，因为数据安全是企业最重要的生命线，没有之一。

老男孩发现很多Linux运维人员以及大部分开发人员，都对数据库的技术一知半解，只停留在基本的安装和SQL简单使用上，更要命的是大家都觉得数据库很重要，但是在工作中又都很惧怕数据库的管理和维护。

### 第1章 数据库介绍与分类

数据库（Database）就是一个存放计算机数据的仓库，该仓库按照一定的数据结构（数据结构是指数据的组织形式或数据之间的联系）对数据进行组织和存储，我们可以通过数据库提供的多种方法来管理其中的数据。

关系型数据库模型可将复杂的数据结构归结为简单的二元关系（即二维表格形式）。例如，老男孩IT教育某一期的学生表格（见表1-1）关系就是一个二元关系。在关系型数据库中，对数据的操作几乎全部建立在一个或多个关系表格上，通过对这些关联的表格进行分类、合并、连接或选取等运算来实现对数据的管理。

数据库中的每个列（或称字段）都有相应的数据类型，数据类型定义每个列存储数据的类别

redis、MongoDB等新兴的NoSQL数据库，也逐渐受到各类公司的欢迎和追捧。NoSQL数据库没有标准的查询语言（SQL），因此进行数据库查询需要制定数据模型。许多NoSQL数据库都有REST式的数据接口或者查询API。

面向文档（document-oriented）的数据库可以看作键值数据库的升级版，允许之间嵌套键值。而且面向文档（document-oriented）的数据库比键值数据库的查询更高效。

目前MySQL被广泛地应用于各大中小型网站中。由于其具有体积小、速度快、总体拥有成本低，且开放源码等特点，因此许多大中小型网站选择它作为网站数据库，从而降低网站总体拥有成本，甚至国内知名的淘宝网也选择弃用Oracle而更换成更为开放的MySQL。

Memcached是一种纯内存缓存系统，把经常存取的对象或数据缓存在Memcached的内存中，程序通过API的方式存取这些被缓存的数据，Memcached里面的数据就像一张巨大的HASH表，数据以key-value对的方式存在。Memcached通过缓存经常被存取的对象或数据，从而减轻频繁读取数据库的压力，提高网站的响应速度，构建出速度更快的可扩展的Web应用。

由于Memcached为纯内存缓存软件，一旦重启，所有的数据都会丢失

Memcachedb非常适合需要超高性能读写速度、持久化保存的应用场景，但是最近几年其正逐渐被其他的持久化产品所替代，例如redis。

区别是redis会周期性地把更新的数据写入磁盘或者把修改操作写入追加的记录文件中，并且在此基础之上实现master-slave（主从）复制。

￼模式自由（schema-free），这意味着对于存储在MongoDB数据库中的文件，我们不需要知道它的任何结构定义。如果需要，你完全可以把不同结构的文件存储在同一个数据库里。

Apache Cassandra是一套开源分布式key-value存储系统。它最初由Facebook开发，用于储存特别大的数据。Facebook目前使用的正是此系统。
Cassandra的主要特性如下所示。
￼分布式。
￼基于列的结构化。
￼高伸展性。

对Cassandra的一个写操作，会被复制到其他节点上去，对Cassandra的读操作，也会被路由到某个节点上去读取。对于一个Cassandra群集来说，扩展性能是比较简单的事情，只管在群集里面添加节点就可以了。

### 第2章 MySQL数据库入门知识介绍

￼MySQL性能卓越，服务稳定，很少出现异常宕机的情况。
￼MySQL开放源代码且无版权制约，自主性强，使用成本低。
￼MySQL历史悠久，社区及用户非常活跃，遇到问题，可以寻求帮助。
￼MySQL软件体积小，安装使用简单，并且易于维护，安装及维护成本低。
￼MySQL品牌口碑效应好，使得企业无须考虑即可直接用之。

MySQL 5.1是当前的稳定发布系列版本。只针对漏洞修复重新发布；没有增加会影响稳定性的新功能。

据官方讲，MySQL 5.6是有史以来最好的版本，是世界上使用最广的开源数据库

### 第3章 MySQL数据库安装方法及安装实践

yum方式安装MySQL数据库时，只需要执行一个命令“yum install mysql-server -y”即可，yum方式的安装原理是在执行yum安装命令之后，其会自动从yum源地址下载相应名称的MySQL数据库rpm包，然后到系统上安装，并自动解决各种软件包之间的依赖问题。这是一个非常不错的安装软件的方式，不仅仅是针对MySQL，安装其他软件也是如此。

### 第4章 MySQL多实例数据库企业级应用实践

MySQL多实例就是在一台服务器上同时开启多个不同的服务端口（如3306、3307），同时运行多个MySQL服务进程，这些服务进程通过不同的socket监听不同的服务端口来提供服务。
这些MySQL多实例共用一套MySQL安装程序，使用不同的my.cnf配置文件、启动程序（也可以相同）和数据文件。在提供服务时，多实例MySQL在逻辑上看起来是各自独立的，它们根据配置文件的对应设定值来获得服务器相应数量的硬件资源。

MySQL多实例有它的好处，也有其弊端，比如，会存在资源互相抢占的问题。当某个数据库实例并发很高或者有SQL慢查询时，整个实例会消耗大量的系统CPU、磁盘I/O等资源，导致服务器上的其他数据库实例提供服务的质量一起下降。

“mkdir -p /data/{3306,3307}/data”相当于“mkdir -p /data/3306/data; mkdir -p /data/3307/data”的两条命令。

### 第5章 MySQL常用管理基础知识实践

这条命令是把数据库自带的启动脚本，复制到/etc/init.d/目录实现管理MySQL服务的启动和停止。

常用的管理命令有mysql、mysqladmin、mysqldump、mysqlbinlog, mysql是登录MySQL最常用的客户端程序（有一些程序员也会使用类似phpmyadmin或者Navicat等的客户端管理软件）。

本地连接数据库常用的方式一般是Socket连接方式，特别是多实例本地MySQL登录，本书就首推socket的连接方式，命令如下：
￼
        mysql -uroot -poldboy123 -S /tmp/mysql.sock

mysql -uroot      #<==刚装完系统无密码情况下的登录方式。不要密码。￼
        3  mysql -uroot -p  #<==这里是标准的dba命令行登录命令，交互式输入密码可有效防止密码泄露。￼


        mysql -uroot -p -h 127.0.0.1 -P3306￼

￼删除无用的mysql库内的用户账号，只保留root@localhost以及root@127.0.0.1。
￼删除默认的test数据库。
￼增加用户的时候，授权的权限应尽量最小，允许访问的主机范围最小化。

2）增加system并将该管理员用户提升为超级管理员，即与root等价的管理员用户，只是名字不同而已：
￼
        mysql> grant  all  privileges  on  ＊.＊  to  system@'localhost'  identified  by￼
    'oldboy123' with grant option;￼

UPDATE mysql.user SET password=PASSWORD("oldboy123") WHERE user='root'￼
    and host='localhost';￼

### 第6章 MySQL常用管理SQL语句应用实践

SQL，英文全称为Structured Query Language，中文意思是结构化查询语言，它是一种对关系型数据库中的数据进行定义和操作的语言，是大多数关系型数据库管理系统所支持的工业标准语言。

3．事务处理语言（TPL）
TPL，全称为Transaction Processing Language, TPL语句用于确保被DML语句影响的表的所有行能够及时得到更新。TPL语句包括BEGIN TRANSACTION、COMMIT和ROLLBACK。

当接收到SQL语句后，数据库首先会判断SQL语句的正确性、类型（例如DDL、DML、DCL），然后根据不同类型，由命令分发模块投递到相应的模块处理。如果是SELECT语句，则首先会查找SQL高速缓存（query_cache）；如果命中目标数据，则SQL不需要再做相应的解析执行操作，直接将请求的数据返回客户端应用程序即可。
2）如果用户请求的数据未在高速缓存中命中，那么会进入SQL的解析过程。

￼注意库名不能以数字开头。
￼所有字母对大小写不敏感。

| information_schema | #<==此表为系统表，存储数据库内置对象的信息，如用户，权限等。￼
        | mysql                 | #<==此表为系统表，存储用户授权和权限相关的信息，授权时会用到。￼
        | oldboy                | #<==这里就是刚才创建的数据库。￼
        | performance_schema | #<==这是MySQL第二条产品线增加的系统表，存储与性能相关的表数据。￼

                  #<==通过show命令查看数据库语句的帮助。￼
        SHOW CREATE DATABASE db_name￼
        mysql> show create database oldboy\G  #<==\G是为了调整显示的格式。￼

所谓的切换库，就相当于系统中的切换路径一样，只不过，系统中使用的是类似于“cd /etc”的命令，而数据库里切换库使用的是use命令。

mysql.user是mysql库里的user

生产场景下尽量不要给开发人员select以外的权限，对于网站的连接账号，不要授予select、insert、delete、update以外的权限。对别人的“仁慈”，就是对自己的岗位和公司最大的

VARCHAR(10)列可以容纳最大长度为10的字符串。实际存储需求是字符串（L）的长度，加上一个记录字符串长度的字节。对于字符串’abcd', L是4，存储需要5字节。

char类型是定长，不够的在右边用空格补全，这会浪费存储空间，以此列为查询条件时，速度更快，多数系统表的字段都是定长。
varchar类型是变长，节省存储空间，以此列为查询条件时速度较慢。

desc student;￼


        rename table 原表名 to 新表名；

alter table test rename to student;￼

数据库的索引就像书的目录一样，如果在字段上建立了索引，那么以索引列为查询条件时可以加快查询数据的速度，这是MySQL优化的重要内容之一，

方法1：建表后利用alter命令增加普通索引。
在此之前，要删除建表时创建的index_name索引，命令如下：
￼
        mysql> alter table student drop index index_name;￼

其中，PRI为主键索引的标识，MUL为普通索引的标识。

当数据量以及访问量很大的时候，不适合临时建立索引，因为会影响用户访问。老男孩曾经在生产上为有着四五百万条记录的表建立索引，花了90～180秒，说多了都是血和泪啊，读者应尽量选择在业务流量低谷时建立索引，以避免重蹈覆辙。

select ＊ from oldboy.test; #<==用点号分隔库和表￼

这里的“*”表示查询表的所有字段，详情可查看help select。
可通过如下命令查询mysql库use表对应user和host列的用户，这

指定固定条件查询数据，一般结尾接where关键字并指定字段的条件查询。

若要同时查询多个条件，则取交集（and），例如查询id为2，并且name为oldgirl的命令如下：

select id, name from test where id>2 and id<5; #<==多个条件，and取交集。￼

select id, name from test where id>3 or id<2; #<==多个条件，or取并集。￼

select id, name from test where id>3 order by id asc;￼

update 表名 set 字段=新值，… where 条件；

针对上面的故障，开始用备份的数据进行恢复（备份的重要性）：

source /opt/bak.sql￼

￼不加任何条件（where）就是全部删除，这也是非常危险的操作，这里就不演示了。对于不加条件的delete、update，一定要慎用回车键，按照流程操作（运维人员和开发人员一起操作）。

update test set state=0 where name='oldgirl';￼

网页正常显示的数据SQL语句为“select * from test where state=1;”
删除上述oldgirl的记录的语句为“update test set state=0 where name='oldgirl';”
因此实际上数据并未真的删除，而是显示状态变为0了，如果想要真正删除，还可以写个在夜里定时任务清理state为0的状态行。

￼TRUNCATE通过释放存储表数据所用的数据页来删除数据，并且只在事务日志中记录页的释放，因此使用的系统和事务日志资源更少。

￼DELETE语句每次删除一行，并且会在事务日志中为所删除的每一行记录一项。

### 第7章 MySQL数据库备份与恢复基础实践

使用-B参数备份数据库，会在备份的数据中增加建库及use库的语句。
￼使用-B参数备份数据库，后面还可以直接接多个库名，实现同时备份多个库。

使用mysqldump命令可以把数据库中的数据导出来，并通过SQL语句的形式存储。这种备份方式称为逻辑备份，效率不是很高。在当下的生产场景中，多用于数据量不是很大的备份情况，例如30GB以内的数据。若在数据库数据很大的时候采用此备份方法，则所用的时间就会很长，恢复的时间也会很长，因此，当数据大于30GB（参考值）后，建议选择其他的诸如Xtrabackup的物理方式进行备份和恢复，见第9章内容。

Binlog是一个二进制格式的文件，用于记录用户对数据库更新的SQL语句信息，例如更改数据库库表和更改表内容的SQL语句都会记录到binlog里，但是对库表等内容的查询则不会记录到日志中。

使用mysqldump全量恢复也只能恢复到当日0点，但是有了binlog文件，就可以将两次完整备份间隔之间的数据还原，因为binlog文件里的数据就是写入数据库的数据，使用binlog文件恢复数据，我们称之为二进制增量数据恢复。

这个oldboy_db.sql文件是系统的相对路径，默认是登录MySQL前的系统路径，也可以使用完整的路径。

mysql的binlog日志用于记录MySQL内部的增删改等操作，也就是对MySQL数据库更新内容的记录（对数据库的改动），对数据库进行查询的语句（如以show、select开头的语句），不会被binlog日志记录。binlog日志的主要作用是数据库的主从复制以及数据灾难后的增量恢复。

### 第8章 MySQL企业级备份应用知识与实践

￼缺点：每天一个全备，占用空间多，占用系统资源多，经常备份会影响用户体验。中小企业用得最多的策略就是按天全备，然后根据空间情况保留全备份数，例如仅保留7天内的备份数据，如果企业数据很重要，则可以使用磁带机等设备留存1年以上的备份数据。

逻辑备份也有一定的缺点，例如，备份速度比物理备份慢、恢复的效率也不是特别高等。

为了确保备份期间数据的一致性，可以选择人工停库或者锁库后再进行物理复制，而这在生产环境中一般是不允许的，除非是可以申请停机或锁表时间，所以使用传统Linux命令复制工具还是比较粗的冷备份方式，应避免使用，后文还会提及根据MySQL主从复制利用从库进行冷备份的策略。

除了在Linux命令行通过命令直接复制MySQL数据文件之外，还有一些其他的第三方的开源或商业物理热备份工具，如Xtrabackup。使用这个工具可以实现物理全备及增量备份。

￼缺点：不容易跨平台、跨版本、跨软件、跨操作系统，可以实现分库分表备份，但恢复时会麻烦很多，软件的使用也比较复杂一些。

备份的策略一般是每日进行全量备份，备份会选择在数据库业务流量低谷时执行，备份时可以锁表或者采用事务方式备份，

在MySQL没有主从复制功能或主从复制功能不完善的时候，我们就曾采取定时或实时推binlog文件的方法。例如每分钟推一次binlog到备份服务器上，或者通过mysqlbinlog参数read-from-remote-server，在其他服务器上远程读取binlog。

比较好的binlog增量备份或MySQL备份方法就是为MySQL数据库配置异机主从复制功能（实时复制功能），即binlog会被实时地发送到从服务器上，这样效果才是最好的。当然，也要相应地在主从复制的从库上实现全备。

mysql </data/backup/oldboy.sql  #<==先恢复全备，即0点￼
                                                                      以前的备份。￼

看到了吧，0点以前的数据已恢复了，但是0点到出故障时间的增量还没有。
再恢复增量数据，即从binlog中解析出清理了drop语句的bin.sql文件：

最佳的方法就是从数据库中取出所有库名，然后对每个数据库执行一次备份。

for dbname in `mysql -e "show databases"|sed '1,2d'|grep -v _schema`￼

但是主从复制的缺点是不能解决错误执行SQL语句的问题，例如，执行“drop database oldboy”命令之后，所有的从库都会傻傻地执行同样的删除动作（这个问题可以通过在从库上实现延迟复制来缓解）。

### 第9章 MySQL物理备份工具Xtrabackup应用实践

Xtrabackup的主要特点具有如下。
￼直接复制物理文件，备份和恢复数据的速度非常快，安全可靠。
￼在备份期间执行的事务不会间断，备份InnoDB数据不会影响业务。
￼备份期间不会增加太多数据库的性能压力。
￼支持对备份的数据进行自动校验。
￼支持全量、增量、压缩备份及流备份。
￼支持在线迁移表以及快速创建新的从库。
￼支持几乎所有版本的MySQL和MariaDB。

事务型引擎的共同特征是具备事务的4个特性，这4个特性分别是：原子性（atomicity）、一致性（consistency）、隔离性（isolation）、持久性（durability），又称为ACID特性。

### 第10章 MySQL数据库日志知识与企业应用实践

在高并发数据库的场景下，普通查询日志应该是关闭状态的（默认也是关闭的），主要是因为查询日志的信息量很大，容易导致磁盘I/O性能问题。当访问量不是很大，而企业又有审计执行的SQL语句的需求时，可以考虑开启该功能。

二进制日志的作用是记录数据库里的数据被修改的SQL语句，一般为DDL和DML语句，例如含有insert、update、delete、create、drop、alter等关键字的语句。
2．二进制日志的作用
二进制日志最重要的作用有2个，具体如下。
第一个是记录MySQL数据的增量数据，用来做增量数据库恢复，没有二进制日志功能，MySQL的备份将无法完整还原数据。
第二个是实现主从复制功能，具体见MySQL主从复制的相关内容。

2）执行“mysqldump -F”或“mysqladmin flush-logs”会将binlog刷新为新文件。

简单地理解，慢查询日志（slow query log）就是记录执行时间超出指定值（long_query_time）或其他指定条件（例如，没有使用到索引，结果集大于1000行）的SQL语句。

long_query_time = 2                             #<==记录大于2秒的SQL语句。￼
        log_queries_not_using_indexes = ON           #<==没有使用到索引的SQL语句。￼
        slow-query-log-file = /application/mysql/slow.log  #<==记录SQL语句的文件。￼
        min_examined_row_limit = 800                  #<==记录结果集大于800行的SQL语句。

### 第11章 MySQL数据库字符集

GBK是专门用作中文的字符编码规范，UTF是通用转换格式的缩写，又可称为万国码，理论上来说，UTF可以表达各种文字的编码格式。

￼对于新型的互联网以及移动互联网的混合业务，推荐使用utf8mb4字符集替代UTF8字符集。总之，如果没有极特别的需求，请选择UTF8或utf8mb4作为数据库的字符集。

### 第12章 MySQL数据库存储引擎知识

数据库表里的数据存储在数据库里及磁盘上，与上述的视频格式及存储磁盘文件系统格式的特征类似，也有很多种存储方式。
但是，对于用户和应用程序来说，同样一张表的数据，无论采用什么引擎来存储，用户看到的数据都是一样的。对于不同的引擎存取，引擎功能、占用的空间大小、读取性能等可能都有区别。
通过上面的说明，我们给出存储引擎的官方解释，存储引擎是MySQL数据库用来处理不同表类型的SQL操作的组件。
MySQL早期最常用的存储引擎为：MyISAM和InnoDB。目前，InnoDB是最常用的存储引擎，也是MySQL5.6默认的存储引擎。

InnoDB引擎由于支持事务、外键等，有利于数据的一致性，以及其能支持更高的多用户并发性等优点，InnoDB已经取代了曾经常用的MyISAM引擎，不过由于数据库中的MySQL库的大部分表主要用于读取，因此，MyISAM引擎依然在使用。

InnoDB引擎的优点是更新数据行级锁定、支持ACID的事务、支持外键，它的设计目标是面向在线事务处理的应用，目前绝大多数互联网公司都在使用InnoDB引擎，该引擎替代了其他的引擎。MySQL 5.6版本的默认引擎已变为InnoDB引擎。

### 第13章 MySQL引擎之InnoDB

MySQL从5.5版本开始即将InnoDB作为默认存储引擎，该存储引擎是第一个完整支持事务ACID特性的存储引擎，且支持数据行锁、多版本并发控制（MVCC）、外键，以及一致性非锁定读。
InnoDB作为MySQL的默认存储引擎，这就意味着默认创建的表都会使用此存储引擎，除非使用“ENGINE=参数”指定创建其他存储引擎的表。
InnoDB的关键属性具体如下。
1）ACID事务特性支持，包括commit、rollback以及crash恢复的能力。
2）行级别锁以及多版本并发控制。
3）利用主键的聚簇索引（clustered index）在底层存储数据，以提升对主键查询的IO性能。
4）支持外键功能，管理数据的完整性。
在MySQL实例中执行“show engines”命令查看存储引擎的情况。

事务（Transaction）是数据库区别于文件系统的重要特性之一，事务可由一条非常简单的SQL语句组成，也可以由一组复杂的SQL语句组成。事务中的操作，要么都做修改，要么都不做，这就是事务的基本目的。理论上说，事务有着极其严格的定义，它必须同时满足四个特性，即通常所说的事务的ACID特性。

1）A:atomicity原子性。事务是一个不可再分割的工作单位，事务中的操作要么都发生，要么都不发生。
2）C:consistency一致性。事务开始之前和事务结束以后，数据库的完整性约束没有被破坏。也就是说，数据库事务不能破坏关系数据的完整性以及业务逻辑上的一致性。
3）I:isolation独立性。多个事务并发访问时，事务之间是隔离的，一个事务不应该影响其他事务的运行效果。
4）D:durability持续性。在事务完成以后，该事务对数据库所做的更改便持久地保存在数据库之中，并不会被回滚。

buffer pool（缓存池）是InnoDB在内存中开辟的用来缓存表数据和索引数据的区域，一般可以设置为50%!～(MISSING)80%!的(MISSING)内存大小，通过将经常访问的数据放置到内存当中来加快访问速度。

InnoDB数据的读写都需要经过缓存（缓存在buffer pool即内存中），数据以整页（16KB）为单位读取到缓存中。缓存中的数据以LRU策略换出（最少使用策略），IO效率高、性能好

buffer pool是内存中用来缓存数据和索引的存储区域，也是MySQL性能调优的重要一环。
理想情况下，设置的size越大，则缓存到内存中的数据越多，InnoDB就越像是内存数据库。

￼1：每次commit都持久化（安全，但性能低，IO负担重）。
innodb_flush_log_at_timeout参数决定最多丢失多少秒的数据，默认是1秒。
￼2：每次commit都写入内存的缓存中，每秒再刷新到磁盘（安全，性能折中，若中MySQL宕机则数据不会丢失，若是服务器宕机则会丢失最多1秒的数据）。

为了提高IO效率，数据库修改的文件都是在内存缓存中完成的；那么，我们知道一旦断电，内存中的数据都将消失，而数据库又是如何保证数据的完整性的？答案是数据持久化与事务日志。
如果宕机了则会应用已经持久化好了的日志文件，读取日志文件中没有被持久化到数据文件里面的记录，然后将这些记录重新持久化到我们的数据文件中。

### 第14章 MySQL主从复制知识与应用实践

MySQL数据库的主从复制技术与使用scp/rsync等命令进行的异机文件级别复制类似，都是数据的远程传输，只不过MySQL的主从复制技术是其软件自身携带的功能，无须借助第三方工具，而且，MySQL的主从复制并不是直接复制数据库磁盘上的文件，而是将逻辑的记录数据库更新的binlog日志发送到需要同步的数据库服务器本地，然后再由本地的数据库线程读取日志中的SQL语句并重新应用到MySQL数据库中，从而即可实现数据库的主从复制。

复制过程中，一台服务器（严格来讲是实例）作为主数据库（Master），接收来自用户的、对其内容的更新，而一个或多个其他的服务器则作为从服务器（Slave），接收来自主服务器binlog文件的日志内容，然后将该日志内容解析出的SQL语句重新应用到其他从服务器中，使得主从服务器数据达到一致。

双向主主复制逻辑架构图，此架构可以在Master服务器1端或Master服务器2端进行数据写入，或者在两端同时写入数据（需要经过特殊设置）。

主从服务器架构的设计，可以大大加强MySQL数据库架构的健壮性。例如，当主服务器出现问题时，我们可以人工切换或设置成自动切换到从服务器继续提供服务，此时从服务器的数据和宕机时的主数据库几乎是一致的。

利用MySQL的主从复制技术进行数据备份，在硬件故障、软件故障、人为在数据库外误操作的场景下，该数据备份是有效的；但对于人为地在数据库中执行drop、delete等语句删除数据的情况，从库的备份功能就没有用了，因为从服务器也会执行删除的语句。

MySQL主从服务器架构可通过程序（PHP、Java等）或代理软件（maxscale、atlas）实现对用户（客户端）的请求按读和写进行分离访问，即让从服务器仅仅处理用户的select（查询）请求，以降低用户查询的响应时间及同时在主服务器上读写所带来的访问压力。对于更新的数据（例如update、insert、delete语句）仍然会交给主服务器处理，以确保主服务器和从服务器保持实时同步。

百度、淘宝、新浪等绝大多数的网站都是用户浏览的页面多于用户发布内容的页面，因此通过在从服务器上接收只读请求，就可以很好地减轻主库的读压力，且从服务器可以很容易地扩展为多台，使用LVS进行负载均衡（读写分离软件自身大多也有负载均衡的功能），效果就非常棒了，这就是传说中的数据库读写分离架构。上述架构的逻辑图如图14-7所示。

PHP和Java程序都可以通过设置多个连接文件轻松地实现对数据库的读写分离，即当语句关键字为select时，就去连接读库的连接文件，若为update、insert、delete时，则连接写库的连接文件。

Maxscale、Atlas、Mycat等代理软件也可以实现读写分离的功能，并且无须对应用程序做任何修改，而且它们还支持负载均衡等功能；缺点是又引入了单点服务，并且稳定性不如程序实现好。

要实现MySQL的主从复制功能，首先必须打开Master端的binlog日志功能。因为整个复制过程实际上就是Slave从Master端获取binlog日志，然后再在Slave上以相同的顺序执行获取的binlog日志中所记录的各种SQL操作，从而实现主从数据一致的功能。

### 第15章 MySQL主从复制高级方案与应用实践

一主多从的MySQL数据库环境，最脆弱的就是主库了，不但扩展困难，所承受的压力也很大，而且，还会面临宕机没有机器替补的问题。

MySQL的高可用方案。MySQL的高可用方案包含很多种，具体如下。
1）heartbeat+dbrd+mysql方案

此方案是通过MySQL的replication实现的主主之间的数据同步，同时还可以实现slaves负载均衡等功能，但业界普遍认为MMM无法完全保持数据的一致性，因此对数据一致性要求较高的数据库场景很少采用，导致该方案也逐步没落了。

1）选择一个不对外提供服务的从库，这样可以确保其与主库更新最接近，专门做数据备份用，从而告别在主库上进行备份但影响主库访问的方案。
2）开启从库的binlog功能，目的是将来数据丢失时可使用binlog进行增量恢复，注意，此处最好开启从库的binlog功能，而不是在数据恢复时拿主库的binlog进行数据恢复。

￼当数据量低于30GB时，可采用mysqldump逻辑备份，优缺点前文已经讲解过了。
￼当数据量大于30GB时，可采用Xtrabackup物理热备工具，优缺点前文中也已经讲解过了。

建议从库数量在3～5个为宜，要复制的从节点数量过多，会导致主库系统及网络带宽压力过大，从而最终导致从库复制延迟。

主库硬件要搞好一点，架构的前端要加buffer以及cache层，以减轻主库的压力。

而延迟复制就可以很好地解决这个问题。例如，可以设定某一个从库和主库的更新延迟1个小时，这样当主库数据出现问题以后，1个小时以内即可发现，可以对这个从库进行无害恢复处理，使之依然是正确的完整的数据，这样就省去了数据恢复占用的时间，用户体验也会有所提高。

### 第18章 MySQL集群高可用方案MHA应用实践

MHA（Master High Availability）是用Perl编写的一套非常流行和实用的MySQL高可用解决方案软件，它的作用是保证MySQL主从复制集群中主库的高可用性，同时保证整个集群业务服务不受影响。当主库异常宕机后，MHA能够在1～30秒的时间内实现故障自动检测和故障自动转移，选择一个最优的从库变成新的主库，同时使得其他的从库和新的主库继续保持数据一致的状态，同时还需要保证在数据库发生故障时，将集群所有数据的损失都降到最低。

高可用性（high availability）：通常用于描述一个系统经过专门的设计，使其减少停工时间，从而保持业务服务的高度可用性的功能说明。

（1）选择新主
主动宕机需要在集群中选择适合的从库作为新主库，根据MHA的配置，可选择的方法具体如下。
1）根据其他从库的binlog位置点选择最新的从库作为新的主库。
2）设置半同步从库，直接选择半同步的从库作为新的主库。
（2）数据补全
在进行故障切换和转移之前，必须要进行数据补全操作，否则就算是进行故障切换了，也会面临数据丢失的问题，这是不可接受的，因此数据补全的步骤具体如下。

1）如果主库服务器仍然可以连接，那么MHA会试图通过SSH连接主库，把宕机主库内的所有binlog日志保存下来；如果不可进行SSH连接，则放弃主库的binlog日志数据。
2）以选择好的最新主库的binlog位置点为基准点，通过中继日志（relay log）进行数据补全，使得其他所有从库与新主库的数据保持一致。

3）将宕机时从主库上保存下来的binlog日志（如果有）恢复到所有数据库节点上。
（3）角色切换
1）将选择好的新主库提升为正式主库的角色。
2）让其他的从库重新与新主库保持主从复制状态。

￼主库宕机后，从库可以立刻接替主库提供服务，并且故障转移的速度会很快。
￼主库崩溃不存在数据一致性问题。
￼部署MHA不需要对当前MySQL集群环境做出重大更改。

￼功能强大，适应场景多，性能优秀，可工作在半同步复制和异步复制场景中，当监控MySQL状态时，仅需要每隔N秒向master发送一次ping包（默认3秒），所以对性能无影响。
￼只要是MySQL主从复制支持的存储引擎，MHA都支持，不会仅局限于InnoDB。

### 第19章 MySQL读写分离Atlas工具实践

双机热备功能。也就是说，第一台数据库服务器，是对外提供增、删、改业务的生产服务器；第二台数据库服务器，则主要是进行读的操作。

### 第20章 云关系型数据库

云数据库是一种被优化或部署在一个虚拟计算环境中的数据库，是一种稳定可靠、具有弹性伸缩能力的、在线的数据库服务。云数据库能够根据用户的需求，进行资源的按需扩展（CPU、内存、存储），同时进行按需付费。

云数据库一般使用多节点部署模式。例如，在Web界面购买一个数据库实例，云厂商会提供一个不可见的备份实例，当主数据库发生异常时，云数据库会自动进行故障切换，保证数据库的高可用性。
云数据库还具备自动备份等功能，保证数据库实例的高可用进行和数据安全。

RDS数据库还提供了容灾、备份、恢复、监控、迁移等方面的全套解决方案，彻底解决了数据库运维的烦恼。

RDS for MySQL是阿里云提供的一种稳定可靠、可弹性伸缩的在线数据库服务，强调的是稳定可靠、可弹性伸缩和在线使用数据库服务，与传统数据库是有区别的，RDS for MySQL即开即用，我们从线上即时购买，即时开通就可以使用了。
RDS for MySQL提供了完善的Web管理界面，可通过Web界面，对数据库进行数据库实例的管理，例如，数据库的创建和删除、数据库实例数据备份和恢复、数据库实例的性能监控、数据库实例升降级等功能。

1）RDS本身是主从备份架构，数据有三份以上的存储备份，具有非常高的可用性和数据可靠性，服务可用性的承诺是99.95%!，(MISSING)数据可靠性的承诺是六个九，99.9999%!。(MISSING)使用克隆实例可以轻松地将数据恢复至7天内的任意时刻。

3）阿里云通过MySQL所有的SQL操作日志记录和慢SQL的分析，能够为用户提供完整的分析报告，告知客户一些优化的建议，比如说，主键的检查、是不是有主键、索引建立得是否合适，以及在线可以看到的SQL执行计划，帮助客户优化自己的SQL语句等。
4）RDS有完整的监控体系，RDS具有将近20种的性能监控和资源监控视图，可对部分资源设置报警阀值，比如说硬盘使用率达到多少时可以进行报警。

独占物理主机实例最大CPU60核、内存为470G、最大磁盘容量为3000GB。

20.3.12 RDS for MySQL三节点企业版
MySQL三节点企业版（以下简称三节点）是阿里云关系型数据库RDS于2017年3月份面向高端企业级用户推出的一款完全自研的云数据库系列，除了维持原有的MySQL兼容性和可用性，我们在AliSQL内核中引入了Raft协议，借助MySQL Semi-sync Replication可实现日志多副本同步复制，以确保数据的强一致性，提供金融级的可靠性，如图20-3所示。

RDS单机基础版可以通过底层数据分布式存储层来保证数据多副本的可靠性，一个物理节点故障损坏不会造成数据丢失。同时，减少一个数据库节点，可以大幅节省用户的成本，售价可低至双机高可用版的一半。

RDS提供了多种类型的备份，MySQL支持物理备份和逻辑备份，MySQL支持全量备份和增量备份。备份开始时间可由用户根据自己的业务低峰进行灵活配置，所有备份文件免费保留7天。

利用备份文件和日志，RDS可以生成一个7天内任意时刻的克隆实例，用户可在校验数据无误之后，再进行数据恢复操作。创建克隆实例操作不影响用户当前实例的正常运行。

￼性能优化：慢日志查询、SQL运行报告、缺失索引。
￼阈值报警：磁盘空间、CPU使用率、连接数使用率、IOPS使用率。
￼安全控制：白名单设置、SQL注入告警。

RDS只读实例和备份实例是一样的，都是通过Binlog生成的。

读写分离方案的优势具体如下。
1）大量读请求指向只读实例。
2）降低主数据库压力。
3）对程序架构影响不大。