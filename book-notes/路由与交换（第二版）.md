## 路由与交换（第二版）
> 斯桃枝

### 1.1.4 交换机的加电启动

交换机加电后，即开始了启动过程，首先运行ROM中的自检程序，对系统进行自检，然后引导运行Flash中的IOS，并在NVRAM中寻找交换机的配置，然后将其装入DRAM中运行，其启动过程将在终端屏幕上显示。

### 1.4 交换机端口安全

（1）MAC攻击：每秒发送成千上万个随机源MAC的报文，在交换机的内部，大量广播包向所有端口转发，使MAC地址表空间很快就被不存在的源MAC地址占满，没有空间学习合法的MAC地址。

2）ARP的攻击：攻击者不断向对方计算机发送有欺诈性质的ARP数据包，数据包内包含与当前设备重复的MAC地址，使对方在回应报文时，由于简单的地址重复错误而导致不能进行正常的网络通信。一般情况下，受到ARP攻击的计算机会出现两种现象：①不断弹出“本机的×××段硬件地址与网络中的×××段地址冲突”的对话框。②计算机不能正常上网，出现网络中断的症状。由于这种攻击是利用ARP请求报文进行“欺骗”的，防火墙会误认为这是正常的请求数据包，不予拦截，所以普通的防火墙很难抵挡这种攻击。

（3）IP、MAC地址欺骗：攻击者用网络盗用别人的IP或MAC地址，进行网络攻击。

### 1.5.3 交换机的交换方式

存储转发方式是计算机网络领域应用最为广泛的方式。它把输入端口的数据帧先缓存起来，然后进行CRC（循环冗余码校验）检查，在对错误帧处理后才取出数据帧的目的MAC地址，通过查找表得到输出端口后送出帧。其优点是：①对进入交换机的数据帧进行错误检测，提高了传输的可靠性；②支持不同速度的端口间的转换，保持高速端口与低速端口间的协同工作。其缺点是数据缓存、校验使得延时增加，影响交换机交换数据的速度。但在一个不太稳定的网络环境下，这种交换方式仍然能提高网络的性能。

### 3.1 IP路由概述

在“网间网”中，路由器不仅负责对IP分组进行转发，还负责与其他路由器进行联络，共同确定“网间网”的路由选择和维护路由表。

路由动作包括两项基本内容：寻址和转发。

寻址即判定到达目的地的最佳路径，由路由选择算法来实现。为了判定最佳路径，路由选择算法必须启动并维护包含路由信息的路由表，路由表中的路由信息依赖于所用的路由选择算法不同而不同。路由选择算法将收集到的不同信息填入路由表中，根据路由表可将目的网络与下一站（Nexthop）的关系告诉路由器。路由器间互通信息进行路由更新，更新维护路由表使之正确反映网络的拓扑变化，并由路由器根据度量来决定最佳路径。这就是路由选择协议。例如，路由信息协议（RIP）、开放式最短路径优先协议（OSPF）和边界网关协议（BGP）等。

转发是按寻址的最佳路径传送数据分组。当路由器从某个接口中收到一个数据包时，路由器根据数据包中的目的网络地址，若不在此接口的同一网络中，则查找路由表中查找，找到路由表中最匹配的表项，取出目的网络所对应的接口，并从此接口转发出去。如果路由器没有相应的表项，它就不知道如何发送分组，只能将该分组丢弃。

说明主机A发送ping命令到主机B后，不同网络之间的IP的路由过程。

ICMP把这个有效负荷交给因特网协议（IP），IP协议会创建一个数据包。此数据包将包含源IP地址192.168.1.1、目的IP地址192.168.2.2。

数据包创建好后，IP协议比较源和目的IP地址是否在同一网络，不同网络时，主机A将把此数据包发送到自己的默认网关192.168.1.254（Windows TCP/IP协议中设定的默认网关）。

主机A要能够发送这个数据包到默认网关，必须知道路由器的F0/0（其IP地址被配置为192.168.1.254）的MAC地址，以便将数据包下传到数据链路层，并形成数据帧，数据帧头中有源MAC、目标MAC地址。

通过在主机A中查找ARP缓存（Windows中用arp –r命令查看ARP表，将显示IP地址Internet Address、与MAC地址Physical Address的对应关系），如果已经被解析，把192.168.1.254所对应的MAC地址（假定为0000.0000.0000）取出产生数据帧。

如果主机的ARP缓存中尚未被解析，主机A将在本地网络中发一个ARP广播以搜索192.168.1.254的MAC地址。路由器F0/0收到此广播，并响应这个请求提供F0/0的MAC地址，主机A缓存此地址到ARP表中，同时路由器也缓存主机A的MAC地址（假定为AAAA.AAAA.AAAA）到自己的ARP表中。

主机A把数据包、源和目标的MAC地址交给数据链路层，局域网驱动器通过局域网提供媒体访问，形成以太网数据帧（此帧的目标MAC：AAAA.AAAA.AAAA，源MAC：0000.0000.0000，目标IP：192.168.2.2，源IP：192.168.1.1）。

1）路由器从物理媒体双绞线上收到一个个比特后，按帧进行CRC校验，若不匹配，将丢弃此数据帧。（2）路由器从帧中抽出数据包，传给IP层。

（3）IP层收到数据包后，取出其目标IP地址192.168.2.2，查找路由表，找到其路由条目，属于目标网络192.168.2.0，由F0/1接口转出。（4）路由器将此数据包发到F0/1的缓冲区内。（5）路由器需要了解目标192.168.2.2的MAC地址，才能封装成数据帧，从F0/1接口发向目标（假定F0/1的MAC为：1111.1111.1111），因此路由器首先检查自己的ARP缓存表

如果没被解析，路由器将从F0/1向目标网络192.168.2.0广播一个ARP请求，主机B响应后，返回其MAC地址（BBBB.BBBB.BBBB），路由器将其放到自己的ARP缓存中。（7）路由器将此数据帧从F0/1接口，通过物理媒体双绞线一个比特一个比特发送到主机B。

（1）主机B接收到此帧并进行CRC校验。如果结果与FCS字段中的内容不匹配，将丢弃此帧，匹配时，再检查MAC地址，取出其IP包，交给网络层。（2）网络层根据数据包的协议字段，交给ICMP。

### 3.1.2 IP路由选择协议

（1）维护路由选择表并确保其他路由器知道网络拓扑中的变化。（2）当分组到达一个接口时，路由器利用路由表决定把分组发送到哪里。把这些数据交换到相应的接口，按接口类型成帧后，发送此帧。

动态路由选择协议是通过运行路由选择协议，使网络中路由器相互间通信，传递路由信息，利用收到的路由信息动态更新路由器表的过程。

当一个分组在路由器中进行寻址时，路由器首先查找静态路由，如果查到则根据相应的静态路由转发分组；否则再查找动态路由。

BGP是为TCP/IP互联网设计的外部网关协议，用于多个自治域之间。

### 3.1.3 路由决策原则

路由器根据路由表中的信息，选择一条最佳的路径，将数据转发出去。如何确定最佳路径是路由选择的关键。路由决策原则按以下次序：1.按最长匹配原则当有多条路径到达目标时，以其IP地址或网络号最长匹配的作为最佳路由。

### 3.1.4 路由器中的路由表

通常C代表直连路由（Connected Route），S代表静态路由（Static Route），S*代表默认路由，R代表RIP，O代表OSPF等。图3-5显示了路由表的全部信息。

### 3.1.5 Windows系统中的IP路由表

③网络地址：某个特定网络的网络地址，如路由表中的第2、3、8行。④默认路由：所有未在路由表中指定的网络地址，均发往默认路由所指定的地址，如路由表中的第1行。

4）Metric（跃点数）：用于指出路由的成本，通常情况下代表到达目标地址所需要经过的跃点数量，一个跃点代表经过一个路由器。跃点数越低，代表路由成本越低；跃点数越高，代表路由成本越高。当具有多条到达相同目标网络的路由表项时，TCP/IP会选择具有更低跃点数的路由项。

### 3.2 静态路由概述

路由器就自动产生激活端口IP所在网段的直连路由信息，即直连路由。路由器的每个接口都必须单独占用一个网段，几个接口不能同属一个网段

### 3.2.2 静态路由

静态路由是指由网络管理员手工配置的路由信息。静态路由具有简单、高效、可靠的优点，而且网络安全保密性高。其特点为：（1）不需要启动动态路由选择协议进程，因而减少了路由器的运行资源开销。（2）在小型互连网络上很容易配置。（3）可以控制路由选择。

### 3.2.3 默认路由

（1）0.0.0.0/0可以匹配所有的IP地址，属于最不精确的匹配。（2）默认路由可以看作静态路由的一种特殊情况。（3）当所有已知路由信息都查不到数据包如何转发时，则按默认路由信息进行转发。

### 8.1 NAT基础

1）局域网内保持私有IP，无须改变，只需改变路由器，进行NAT转换，就可上外网。（2）NAT节省了大量的地址空间。（3）NAT隐藏了内部网络拓扑结构。

4.NAT的缺点（1）NAT增加了延迟。（2）NAT隐藏了端到端的地址，丢失了IP地址的跟踪，不能支持一些特定的应用程序。（3）需要更多的资源如内存、CPU来处理NAT。

通常NAT是本地网络与Internet的边界，工作在存根网络的边缘，由边界路由器执行NAT功能，将内部私有地址转换成公网可路由的地址。

### 9.1.1 ACL简介

ACL全称访问控制列表（Access Control List）

ACL使用包过滤技术，在路由器上读取第3层及第4层包头中的信息（如源地址、目的地址、协议口、端口号等），根据预先定义好的规则对包进行过滤，从而达到访问控制的目的，

### 10.1 生成树协议概述

在交换网络中，由于单点（单链路）故障容易导致系统瘫痪，因此引入备份链路。但冗余链路又会造成网络环路，当交换网络中出现环路时，会产生广播风暴、多帧复制和MAC地址表不稳定等现象，

广播采用广播帧来发送和传递信息，广播帧面向局域网中所有主机，因此容易产生碰撞，为缓解碰撞又要重传更多的数据包，从而耗尽网络带宽，使网络瘫痪。

解决环路的最初思路是：当主要链路正常时，断开备份链路；当主要链路出现故障时，自动启用备份链路，于是产生了生成树协议。