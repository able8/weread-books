## 企业安全建设入门：基于开源软件打造企业网络安全
> 刘焱

### 序

纵观人类发展的历史，已经先后经历了农业革命、工业革命、信息革命。每一次产业技术革命，都给人类社会带来巨大而深刻的影响。伴随着云计算、物联网、大数据、移动互联网、人工智能等技术引领的数字化变革，全球各个市场、各个行业已经紧密地联系为一个统一体。

据了解，此次“断网”事件是由于美国最主要DNS服务商Dyn遭遇了大规模DDoS攻击所致。攻击者使用了一种叫作“物联网破坏者”的Mirai病毒来进行肉鸡搜索。其中，这些设备中有大量的DVR（数字录像机，一般用来记录监控录像，用户可联网查看）和网络摄像头（通过Wifi来联网，用户可以使用App进行实时查看的摄像头）。媒体将此次事件形容为“史上最严重DDoS攻击”，不仅规模惊人，而且对人们生活产生了严重影响。

### 第1章 开源软件与网络安全

在Linux出现后的几十年里，各种开源软件如雨后春笋般出现，它们深刻改变着互联网的面貌。
1993年，红帽成立；
1994年，MySQL启动；
1996年，Apache称霸互联网；
2005年，Hadoop横空出世；

### 2.2 WAF概述

WAF（Web Application Firewall, Web应用防火墙）是通过执行一系列针对HTTP/HTTPS的安全策略为Web应用提供保护的一种产品。作为绝大多数互联网公司Web防御体系最重要的一环，承担了抵御常见的SQL注入、XSS、远程命令执行、目录遍历等攻击的作用，就像大厦的保安一样默默工作，是守护业务安全的第一道防线。

多数WAF处于性能的考虑，检测策略主要是基于请求或者应答内容，缺乏上下文以及请求应答关联分析的能力，势必看问题就很片面和局限，大家可以在有输入框的地方输入alert(/1/)，看看有多少WAF会拦截。

### 2.3 常见WAF部署模式

另外一种常见部署模式是反向代理模式，如图2-5所示，通过指DNS的方式接入。这种方式的优点是不变化网络架构，横向扩展方便。缺点是配置略麻烦，需要逐步切换DNS。

### 2.4 自建WAF系统

OpenResty是一个基于Nginx与Lua的高性能Web平台，其内部集成了大量精良的Lua库、第三方模块以及大多数的依赖项，用于方便地搭建能够处理超高并发、扩展性极高的动态Web应用、Web服务和动态网关。OpenResty通过汇聚各种设计精良的Nginx模块，从而将Nginx有效地变成一个强大的通用Web应用平台。

OpenResty的目标是让你的Web服务直接运行在Nginx服务内部，充分利用Nginx的非阻塞I/O模型，不仅仅对HTTP客户端请求，甚至于对诸如MySQL、PostgreSQL、Memcached以及Redis等的远程后端都进行一致的高性能响应。

可以把Lua理解为一个进程，贯穿在整个Nginx服务的HTTP报文处理的流程中，可以针对HTTP报文的任何字段进行处理，如图2-7所示。这里只是为了方便理解，事实上Lua就像胶水一样粘入了Nginx的处理流程，其实并没有真实存在一个Lua进程。下面

### 2.5 自建分布式WAF系统

常见的开源解决方案当属LVS。LVS是Linux Virtual Server的简写，意即Linux虚拟服务器，是一个虚拟的服务器集群系统，支持VS-NAT、VS-TUN、VS-DR三种模式：

VS-NAT，如图2-13所示，就是把客户端发来的数据包的IP头的目的地址，在负载均衡器上换成其中一台RS的IP地址，并发至此RS来处理，RS处理完成后把数据交给负载均衡器，负载均衡器再把数据包的源IP地址改为自己的IP，将目的地址改为客户端IP地址即可 ｡ 期间，无论是进来的流量，还是出去的流量，都必须经过负载均衡器。

VS-TUN，如图2-14所示，把客户端发来的数据包，封装一个新的IP头标记（仅目的IP）发给RS, RS收到后，先把数据包的头解开，还原数据包，处理后，直接返回给客户端，不需要再经过负载均衡器 ｡ 注意，由于RS需要对负载均衡器发过来的数据包进行还原，所以说必须支持IPTUNNEL协议 ｡ 所以，在RS的内核中，必须编译支持IPTUNNEL这个选项。

VS-DR，如图2-15所示，负载均衡器和RS都使用同一个IP对外服务，由于负载均衡器要对二层包头进行改换，所以负载均衡器和RS之间必须在一个广播域，也可以简单地理解为在同一台交换机上。

1）配置同步模型。
配置同步最常见的方式有两种：推、拉。推模式最容易实现，但是在大型分布式系统里面无法保证时效性；拉模式性能差。

ZooKeeper（简称ZK）是一个开源的分布式应用程序协调服务，是Hadoop和HBase的重要组件。如图2-17所示，它是一个为分布式应用提供一致性服务的软件，提供的功能包括：配置维护、域名服务、分布式同步、组服务等。ZooKeeper在分布式系统的配置管理方面应用非常广泛。ZooKeeper支持发布订阅模式

在最简化设计时，我们可以让每台WAF的配置完全一样，这样的好处是可以随时添加服务器，任何一个服务器宕机都不会影响WAF服务，而且整个系统的架构会非常简洁。每台WAF只要使用Python脚本订阅ZooKeeper中的配置，一旦发生变更，获取最新配置，更新相关配置文件，给Nginx发送信号热加载新配置文件即可。

建议至少使用三个ZooKeeper实例（如图2-19所示），而且分布在不同服务器上，可以和WAF混合部署，因为ZooKeeper对性能消耗很小：

日志处理也是基于流行的storm做实时流式处理，基于Spark做离线分析，基于HDFS做离线存储，

### 2.6 抗DDoS攻击

DDoS粗略分类为流量型攻击和CC攻击。流量型攻击主要是通过发送报文侵占正常业务带宽，甚至堵塞整个数据中心的出口，导致正常用户访问无法达到业务服务器。

● TCP SYN FLOOD

通常黑客会伪造TCP SYN的源地址为一个不存在的地址，让服务器根本没法回包，并且增加TCP SYN的报文长度，同时堵塞机房出口。

● UDP FLOOD——又称UDP洪水攻击或UDP淹没攻击，UDP是没有连接状态的协议，因此可以发送大量的UDP包到某个端口，如果是个正常的UDP应用端口，则可能干扰正常应用，如果是没有正常应用，服务器要回送ICMP，这样就消耗了服务器的处理资源，而且很容易阻塞上行链路的带宽。通常黑客会发送大量长度较长，源IP伪造成不存在地址的UDP报文，直接堵塞机房出口。

● 反射型攻击——反射拒绝服务攻击又称DRDoS攻击（Distributed Reflection Denial of Service），或分布式反射拒绝服务攻击。其原理如图2-22所示，是黑客伪造成被攻击者的IP地址，向互联网上大量开放特定服务的服务器发起请求，接收到请求的那些主机根据源IP地址将响应数据包返回给受害者。整个过程中，返回响应的服务器并不知道请求源的恶意动机。

黑客往往会选择那些响应包远大于请求包的服务来利用，这样才可以用较小的流量换取更大的流量，获得几倍甚至几十倍的放大效果。一般来说，可以被利用来做放大反射攻击的服务包括DNS服务、NTP服务、SNMP服务、Chargen服务等。

可见利用NTP协议的反射放大效果最好，超过500倍。也就是说攻击者只需要发起100Mbps的请求流量，经过NTP服务器的反射放大，可以换来5Gbps的攻击流量。

DDoS云防护的基本原理就是替身防护，即通过A记录、CNAME或者NS的方式将被攻击网站的域名指向云清洗机房，云清洗机房利用囤积的大量带宽进行流量清洗，把清洗后的正常业务访问转发给网站，过滤掉攻击流量。

### 3.2 主机加固

1. Linux主机OS层面加固
● 禁止root登录。
● vi /etc/ssh/sshd_config。
● PermitRootLogin no。

### 4.3 微步在线

以查询IP信誉为例，能够提供实时IP情报和画像信息，获得IP的基础属性信息，如是否IDC主机、动态IP、傀儡机、VPN、代理IP等，调用方法如下：

### 第5章 业务安全

业务安全，也叫业务风控、反欺诈，是近今年来非常热的一个领域，从互联网金融到电商、O2O，只要和钱有关系的业务，

### 5.2 API网关Kong

使用Kong之前，我们开发的每个接口都需要独立实现诸如缓存、日志记录等功能，尤其是和安全相关的认证、授权、限速也需要各个接口自己去实现，不但重复开发而且无法统一管理，容易产生遗漏。

使用Kong以后，各个接口可以只专注于自己的业务实现，通用的缓存、日志记录等功能，尤其是和安全相关的认证、授权、限速都由Kong来实现。

Kong的数据库使用的是PostgreSQL。PostgreSQL是加州伯克利开发的一款关系型数据库，相对于MySQL，具有以下优点￼：
● 不仅仅是关系型数据库：除了存储正常的数据类型外，还支持存储数组，不管是一维数组还是多维数组均支持json（hStore）和jsonb，相比使用文本存储要高效很多。

● 可以快速构建REST API:PostgREST可以方便地为任何PostgreSQL数据库提供完全的RESTful API服务。
● 支持树状结构：支持R-trees这样可扩展的索引类型，可以更方便地处理一些特殊数据。MySQL处理树状的设计会很复杂，而且需要写很多代码，而PostgreSQL可以高效地处理树结构。
● 支持图结构数据存储。
● 事务隔离做得更好。

### 第6章 代码审计

代码审计就是检查源代码中的缺点和错误信息，分析并找到这些问题引发的安全漏洞，并提供代码修订措施和建议。

RIPS是一款开源的，具有较强漏洞挖掘能力的自动化代码审计工具。它使用PHP语言编写的，用于静态审计PHP代码的安全性。RIPS的主要功能特点如下：
● 能够检测XSS、SQL注入、文件泄露、本地/远程文件包含、远程命令执行以及更多类型的漏洞。
● 标记存在漏洞的代码行。

### 第7章 蜜罐与攻击欺骗

蜜罐技术是一项“古老”的技术，它本质上是一种对攻击方进行欺骗的技术，通过布置一些作为诱饵的主机、网络服务或者信息，诱使攻击方对它们实施攻击，从而可以对攻击行为进行捕获和分析，了解攻击方所使用的工具与方法，推测攻击意图和动机，能够让防御方清晰地了解自己所面对的安全威胁，并通过技术和管理手段来增强实际系统的安全防护能力。

### 7.2 SSH服务蜜罐Kippo

Kippo是一款优秀的SSH服务蜜罐，它提供了非常逼真的shell交互环境，比如支持对一个文件系统目录的完全伪装，允许攻击者能够增加或者删除其中的文件。Kippo包含一些伪装的文件内容，如/etc/passwd和/etc/shadow等攻击者感兴趣的文件，以UML（User Mode Linux）兼容格式来记录shell会话日志，并提供了辅助工具能够逼真地还原攻击过程。Kippo还引入了很多欺骗和愚弄攻击者的智能响应机制。正是由于具有这些特性，Kippo能够称为是一种中等交互级别的SSH蜜罐软件￼

### 7.3 Elastcisearch服务蜜罐Elasticpot

Elasticsearch依然是互联网公司非常容易遭受攻击的服务之一。Elasticpot定位是一款模拟Elasticsearch服务的蜜罐，主打功能就是检测针对Elasticsearch的各类攻击￼，包括基于Elasticsearch自生RCE漏洞的攻击以及上文提到的利用Elasticsearch匿名访问机制进行数据删除并勒索的攻击。

### 第8章 态势感知系统建设

态势感知是一种基于环境的、动态、整体地洞悉安全风险的能力，是以安全大数据为基础，从全局视角提升对安全威胁的发现识别、理解分析、响应处置能力的一种方式，最终是为了决策与行动，是安全能力的落实￼。

扫描任务通常会消耗较长时间，需要使用任务队列，最常使用的任务队列当属Celery。
Celery是一个强大的分布式任务队列，它可以让任务的执行完全脱离主程序，甚至可以被分配到其他主机上运行。通常使用它来实现异步任务和定时任务。它的架构组成如图8-6所示。

● 消息中间件Broker, Broker即为任务调度队列，接收任务生产者发来的消息（即任务），将任务存入队列。Celery本身不提供队列服务，官方推荐使用RabbitMQ和Redis等应用。
● 任务执行单元Worker, Worker是执行任务的处理单元，它实时监控消息队列，获取队列中调度的任务，并执行它。
● 任务结果存储Backend, Backend用于存储任务的执行结果，以供查询。同消息中间件一样，存储也可使用RabbitMQ、Redis和MongoDB等应用￼，通常Backend使用Redis应用。

### 8.2 入侵感知概述

● 静态资源，负责对外提供静态资源服务，比如图片、js、静态页面等。
● 动态资源，负责对外提供动态资源服务，通常是CGI脚本服务。
● API服务，对移动APP用户直接提供API服务，或者为其他服务提供API服务调用，比如地图API服务、搜索查询API服务。

从协议栈的角度分析，需要覆盖至少HTTP协议、数据库协议、DNS协议。
从数据搜集的角度分析，如图8-16所示，需要覆盖至少网络流量、数据库日志、Web服务器文件、服务器操作日志、DNS服务器查询日志，最好再包括服务器进程信息、PHP/Java组件内部调用数据、甚至业务层应用日志。

### 8.3 网络入侵检测

Bro是一款被动的开源流量分析器，如图8-23所示，它主要用于对链路上所有深层次的可疑行为流量进行安全监控。Bro支持自定义的脚本语言，通过该脚本语言可以非常细粒度地进行协议分析，它可以在TCP会话层以及HTTP、DNS等应用层协议层，以常见的文本日志格式记录协议的详细内容，比如HTTP会话以及请求的URL、关键头、MIME类型、服务器反馈，DNS请求及反应，SSL证书，SMTP会话的关键内容，等等。

### 8.6 敏感信息外泄监控

社会工程学几乎是伴随着互联网安全的发展而发展起来了。员工敏感信息的外泄通常为黑客入侵提供了大量的企业一手信息，记得曾经某大厂就出现了某员工把VPN密码写到GitHub，结果导致白帽子直接登录内网漫游。在态势感知系统中，以黑客视角实时监控全网的、针对本企业的信息外泄，是非常有意义的，

### 9.4 自建SOC系统

网络全流量包含完整的网络数据，即TCP/IP协议栈的数据，比如MAC头、IP头、TCP头、HTTP头以及HTTP载荷数据，对于分析网络中的攻击行为帮助非常大。

常见的网络全流量获取方式为交换机镜像、分光镜和网络分流器三种。

Syslog协议属于一种主从式协议，发送端会发送一个小的文本信息（小于1024字节）到Syslog接收端。常见的网络设备、安全设备以及发行版的Linux系统都支持把日志以Syslog协议发送出来。
以常见的Linux发行版为例，Syslog的配置文件位于如下路径：
￼
    /etc/syslog.conf
通过在配置文件最后一行增加下列语句即可以把Syslog发送给远端的Syslog服务器：
￼
    ＊.＊     @192.168.0.2

Logstash是一款强大的数据处理工具，它可以实现数据传输、格式处理、格式化输出和强大的插件功能，常用于日志处理￼。

FILTERS为数据中转层，主要进行格式处理，数据类型转换、数据过滤、字段添加和修改等，最常用的过滤器为Grok, Grok通过正则解析来结构化文本，Logstash内置了120个匹配模式，满足大部分需求。
OUTPUTS是Logstash工作的最后一个阶段，负责将数据输出到指定位置，常见的输出位置列举如下：
● Elasticsearch:，发送事件数据到Elasticsearch。
● File，将事件数据写入到磁盘文件上。
● Kafka，将事件数据写入Kafka。

Kafka是一种高吞吐量的分布式发布订阅消息系统，有如下特性：
● 通过O(1)的磁盘数据结构提供消息的持久化，这种结构对于即使以TB级的消息存储量也能够保持长时间的稳定性能。
● 高吞吐量，即使是非常普通的硬件也可以支持每秒数百万的消息处理。
● 支持通过Kafka服务器和消费机集群来分区消息￼。

● Broker——Kafka集群包含一个或多个服务器，这种服务器被称为Broker。
● Topic——每条发布到Kafka集群的消息都有一个类别，这个类别被称为Topic。物理上不同Topic的消息分开存储，逻辑上一个Topic的消息即使保存于一个或多个Broker上，用户只需指定消息的Topic即可生产或消费数据而不必关心数据存于何处。
● Parition——是物理上的概念，每个Topic包含一个或多个Partition。
● 生产者——负责发布消息到Kafka Broker。
● 消费者——消息消费者，向Kafka Broker读取消息的客户端。

实时处理层主要使用Storm, Storm是一个免费开源、分布式、高容错的实时计算系统。Storm令持续不断的流计算变得容易，弥补了Hadoop批处理所不能满足的实时性要求。Storm经常用在实时分析、在线机器学习、持续计算、分布式远程调用和ETL等领域。Storm的部署管理非常简单，而且相比同类的流式计算工具，Storm的性能也是非常出众的。

Hadoop分布式文件系统（HDFS）被设计成适合运行在通用硬件平台上的分布式文件系统。它和现有的分布式文件系统有很多共同点，但同时区别也是很明显的。HDFS是一个高度容错性的系统，适合部署在廉价的机器上。HDFS能提供高吞吐量的数据访问，非常适合于大规模数据集上的应用。

HBase是一个高可靠、高性能、面向列、可伸缩的分布式存储系统，利用HBase技术可在廉价PC Server上搭建起大规模结构化存储集群。HBase是Google Bigtable的开源实现，类似Google Bigtable利用GFS作为其文件存储系统，HBase利用Hadoop HDFS作为其文件存储系统。Google运行MapReduce来处理Bigtable中的海量数据，HBase则利用Hadoop MapReduce来处理HBase中的海量数据，Google Bigtable利用Chubby作为协同服务，HBase则利用Zookeeper作为协同服务，其架构如图9-15所示。

Elasticsearch是用Java开发的，并作为Apache许可条款下的开放源码发布，是当前流行的企业级搜索引擎，设计用于云计算中，能够实现实时搜索，稳定，可靠，快速，安装使用方便。安装Elasticsearch唯一的要求是安装官方最新版的Java。

GPU的应用如图9-16所示。GPU全称叫做Graphics Processing Unit，起初设计用于计算机的图像渲染，其内部的计算单元进行并行计算，在矩阵运算和数值计算方面具有独特优势，特别是浮点和并行计算上性能优于通用CPU的数十数百倍

人们利用GPU来训练这些深度神经网络，所使用的训练集虽然很大，所耗费的时间却大幅缩短，占用的数据中心基础设施也少了许多。GPU还被用于运行这些机器学习训练模型，以便在云端进行分类和预测，从而在功率耗费更低、占用基础设施更少的情况下能够支持远比从前更大的数据量和吞吐量。将GPU加速器用于机器学习的早期用户包括诸多较大规模的网络和社交媒体公司

TPU的应用案例如图9-19所示，TPU是谷歌专门为提升深层神经网络运算能力而研发的一款芯片，通过优化片外内存访问，使用低运算精度以及脉动式数据流，大大提高了运算能力，比GPU、 CPU组合快15～30倍。

Logstash其实可以直接把数据写入Elasticsearch（通常简称es），但是考虑到Storm也要数据处理，所以把数据切分后放到Logstash，然后发送至Kafka，提供给Storm处理后Logstash写入Elasticsearch。数据检索可以直接使用Kibana，非常方便，数据切分也可以在Storm里面完成。这个就是经典的ELK架构。

在生产环境中，处理安全事件，分析入侵行为，只有SSH登录日志肯定是不够的，我们需要尽可能多地搜集数据源，以下日志作为参考：
● Linux/Window系统安全日志/操作日志。
● Web服务器访问日志。
● 数据库SQL日志。
● 网络流量日志。

path => ["/var/log/＊.log", "/var/log/message"]￼

### 10.2 数据库安全概述

● 数据库审计，审计数据库的操作行为，发现针对数据库的入侵行为以及违规操作。
● 数据库运维平台，提供给数据库管理员管理数据库的平台，使管理员无法直接接触数据库服务器，全面控制、审计管理员的操作行为。
● 数据库脱敏，针对流出数据库的敏感数据进行脱敏处理。
● 数据库漏洞扫描，扫描数据库常见漏洞。

### 10.5 开源数据库防火墙DBProxy

DBProxy是由美团点评公司技术工程部DBA团队（北京）开发维护的一个基于MySQL协议的数据中间层。如图10-13所示，DBProxy作为中间层转发来自Web服务器的数据库请求到后端数据库服务器，并且把数据库查询请求再转发给对应的Web服务器。

● 读写分离。
● 从库负载均衡。
● IP过滤。
● 分表。
● DBA可平滑上下线DB。