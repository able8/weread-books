## 运维前线：一线运维专家的运维方法、技巧与实践
> 云技术社区

### 推荐序

在移动互联网时代，初创企业和巨头们之间的力量相差悬殊，这滋生了创业扶持产业的出现与兴起。所谓创业扶持产业，从技术革新上看就是“云”，云服务让所有的初创企业有了和巨头们一样的基础设施。

传统运维的革新是一个必然的过程，如果你对运维知识的了解一直停留在原地，那你离悬崖就不远了。
云服务下的运维相较于传统服务器的模式，优势已相当明显。企业无需花费巨额的资金来购买新的服务器和托管机房的机位，就能够低成本、低风险地实现新增业务。同时，运维人员不再只能利用传统的网管手段来定位系统故障，他们可以通过云计算管理平台以及虚拟设备管理平台进行分析。

七牛云的目标是打造一个场景化的PaaS（Platform-as-a-Service，平台即服务）平台，帮助开发者缩短从想法到产品的距离。我们打造了很多子产品，包括大数据、通用计算、云计算等。从我们发布产品的服务类型来看，第一类是对象存储服务，第二类是融合CDN服务，第三类是数据处理服务，第四类是直播云以及实时流网络LiveNet服务。

云服务的兴起改变了运维，而这种改变不会停止。
云服务厂商可以将所有事情标准化，然后以服务的形式打包提供给客户。而运维人员将告别烦琐的工作内容，但是他们可能要承担更多的职责——解决监控、评估、采购、报修等问题。

你如果在云服务厂商做运维工作，便需要对传统运维有更深刻的理解了。


### 前言

IT系统正在向规模更大、更复杂、更高级的方向演进，一切IT资源都掌握在运维手里，通过运维来操作。这个时代对运维的要求越来越高，运维如果稍有不慎，就会造成重大的损失，所以随着IT系统的发展，运维的重要性也越来越高。

本书覆盖了运维自动化、系统运维、云及虚拟化、Web运维、游戏运维、DBA运维等6个方面14个知识点

### 1.3.2 运维自动化的价值

最后运维自动化的收益是成本的节省，一种是最直接的人力成本的节省，可以让更少的人做更多的事情；间接的成本受益是把很多运维经验固化成平台的经验，从而减少了整个交付链上的文档化内容的输出。

### 1.7 运维自动化系统的API参考实现

所有的底层系统都是通过API对外提供服务的，API可供各个系统使用。接口的使用需要通过授权来获得，建议这个授权可以是基于系统级别的，也可以是接口级别的，而不是采用统一开放的模式。另外接口内需要有相应的一些权限控制，以避免底层服务被任意操作。

### 1.8.1 团队的能力模型

1）业务运维。因为对这块能力的要求越来越低，因此其在我们的考核体系中所占的比重也越来越低。日常的变更、扩容、故障定位、运维规划对人的能力要求都非常低，这些工作都能模式化且平台化，从而减少了对人的倚重。

3）技术研究。运维是一个技术团队，需要通过技术来体现价值，当找到好的技术时就要想着如何将技术应用到业务上，为用户带来价值，比如说提升用户体验，减少成本等。

维研发还需要制定相应的运维研发规范，代码规范、UI规范、测试规范等，让所有参与运维研发的人统一遵守，包括应用运维研发的组员。

### 第2章 利用Facter和Django快速构建CMDB

CMDB（Configuration Management Database），又称配置管理数据库，更多的时候我们习惯将其称为资产管理系统。

### 2.3 Puppet及Facter介绍

CMDB的信息收集可以是多种多样、共融共存的：
（1）通过一些Agent客户端收集信息，然后注册到中心服务器数据库。
（2）通过监控系统收集，比如Zabbix、Nagios、IPMI等。
（3）通过配置管理工具收集，比Puppet、SaltStack、Ansible等。

### 2.5 使用Django快速构建CMDB系统

Django是一个免费的、开源的Web框架，由Python语言编写，由于其是在一个快节奏的新闻编译室环境中开发出来的，因此它的设计目的是让普通开发者的工作变得简单。

### 2.6.2 API功能

Django REST framework是一个非常强大、灵活的API构建工具，它能很容易、很快速地帮我们构建Web API。

### 第4章 集中配置管理工具Puppet

为了提高效率、避免重复劳动、减少错误、积累知识，系统管理员已经开始做一些局部的自动化工作。

### 5.1 禁用连接追踪

        if [ -z $host ]; then￼
            echo "Usage: `basename $0` [HOST]"￼
            exit 1￼
        fi￼

我们首先分析了系统日志/var/log/messages，发现在对应的时间点，有关于nf_conntrack的报错

服务器上的已有连接追踪条目数量已接近于我们配置的最大追踪数，这一点进一步确认了丢包问题是由连接追踪导致的。

### 5.1.2 分析连接追踪的原理

通过cat/proc/net/nf_conntrack命令可以查看当前连接追踪的表）：

### 5.2 慎重禁用ICMP协议

因为我们只开放了ICMP的以下类型为允许：
￼
        iptables -A INPUT -p icmp --icmp-type echo-reply -j ACCEPT￼
        iptables -A INPUT -p icmp --icmp-type echo-request -j ACCEPT


### 5.2.2 MTU发现的原理

MTU（Maximum Transmission Unit，最大传输单元）是指一种通信协议的某一层所能通过的最大数据包大小（以字节为单位）。由于以太网传输电气方面的限制，每个以太网帧最大不能超过1518字节，刨去以太网帧的帧头（源MAC+目标MAC+Type+CRC）18字节，那么剩下承载上层协议的Data域（IP头+TCP头+应用数据）最大就只能有1500字节

### 5.3.1 源地址NAT

源地址NAT，主要用于如图5-12所示的网络示意图中无外网IP的服务器（Server B）需要访问互联网的场景。

（2）在服务器Server A上，启用路由功能。启用的方法是执行以下的命令：
￼
        sysctl -w net.ipv4.ip_forward=1

### 5.3.2 目的地址NAT

目的地址NAT用于如图5-12所示的网络示意图中，外部用户直接访问无外网IP的服务器（Server B）提供的服务。例如，外部用户希望通过互联网访问到Server B上的Oracle数据库（监听端口是TCP 1521）时，我们可以使用如下的命令在Server A上进行目的地址NAT设置：

iptables  -t  nat  -A  PREROUTING  -d  x.y.z.173  -p  tcp  -m  tcp  --dport  1521  -j  DNAT￼
        --to-destination 10.128.70.111:1521 #改写目的地址为10.128.70.111，目的端口为1521￼
        iptables  -t  nat  -A  POSTROUTING  -d  10.128.70.111  -p  tcp  -m  tcp  --dport  1521  -j￼
        SNAT --to-source 10.128.70.112 #改写源地址IP为Server A的内网IP，此时与Server B相￼
        当于是和Server A进行通信

网络地址转换是运维人员在工作中经常会用到的技术，我们需要非常熟悉源地址转换和目的地址转换这两种方案。

### 5.4 深入理解iptables的各种表和各种链

❑mangle表：mangle表用于修改IP的头部信息，如修改TTL（Time to Live）。

### 6.2.2 systemd的启动顺序

级别0和级别6分别表示关机和重启，它们都会调用/etc/rc$runlevel.d/目录下以K开头的服务，按照顺序调用service <服务名称> stop来关闭服务；唯一的区别就是级别0最后会调用halt命令关机，而级别6会调用reboot命令重启：

❑级别1会在系统启动时加载/etc/rc1.d/S开头的服务，这些服务只包含启动必需的服务，只会加载bash而不进行用户身份的校验，该级别可用于服务器异常或忘记管理员（root）密码时的紧急救援工作。

我们可以看到级别0和级别6使用的数字已经转换成了更好识别功能的英文，其中级别1为恢复模式；级别2、3、4合并成了一个target，这个target被称作多用户模式，即不带图形的多用户网络模式；级别5单独使用一个target用于启动时启动X服务，即图形服务器。精

systemd就是利用这些关键字完成了复杂的启动依赖关系，运维工程师甚至可以在不懂Shell脚本的情况下就可以配置各个服务之间的依赖关系了，而且还是并行引导的。

### 6.3.2 hostnamectl命令

首先要通过hostname命令设置当前的主机名，为避免主机名失效还需要将主机名写入配置文件；通过systemd提供的hostnamectl命令可以只用一条命令就能完成上述操作

### 6.4.3 systemd的其他功能

cron是管理员经常会用到的工具，是用于定时执行脚本和备份的重要工具，这里给大家介绍另外一种方法，那就是使用systemd的timer来代替cron进行计划任务。

❑OnBootSec表示在系统启动之后10分钟才开始运行。
❑OnUnitAcriveSec是运行的周期，这里用做测试，所以每分钟运行一次。
❑Unit表示调用的是哪个service，可通过上面的service来调用脚本文件。

### 6.5.2 使用systemd journal功能

#   journalctl   -u firewalld.service￼

### 7.1.1 PHP进程的工作方式

Web服务器Apache/Nginx通过FastCGI协议把请求转发到PHP-FPM进程。

❑域名被DNS解析到Nginx管理进程（Master process）所在的服务器IP。
❑Nginx管理进程选择一个工作进程（Worker process）。
❑Nginx工作进程把请求转发到PHP-FPM管理进程（默认是9000端口）。
❑PHP-FPM管理进程分配一个工作进程处理index.php请求。
❑工作进程在服务器路径中找到index.php文件，解析编译。
❑执行PHP代码，可能还要请求后端存储等。
❑得到请求的结果，先返回给Nginx，然后再返回给用户浏览器。

### 7.2.1 运维对PHP研发提要求

❑统一的应用日志路径：只有规范了日志路径才可以通过自动化去收集或清理日志，如protected/logs/xxx.log。
❑统一的部署路径：将所有代码都部署在/data/webapps/xxx.yyy.com中，以业务域名作为部署路径。

❑性能和效率分析：上线前要了解代码的运行效率，所写的SQL的效率，整个系统的吞吐能力，整个系统和细分环节的延时情况。可以通过压力测试工具来分析，比如ab （Apache Bench）工具。

❑容错容灾分析：一旦出现故障，要有一定的容错容灾能力，比如说做到无状态化，session和产生的内容不存储在本机中，当然机器出现故障或挂掉的时候要能够快速切换到其他服务器，在业务负载较大时要能够快速扩容。
❑较大型的团队开发一定要用框架，在选择框架时要充分考虑到性能问题和运维方法。

有些开发人员认为缓存与自己无关，是架构师或运维维护的责任。还有些开发人员不了解缓存的特性，认为只要能往里面写数据、读数据就行了，结果造成内存利用不合理的问题，而且也没起到缓存的作用。某程序员还把大量的一次性数据写入缓存，他不了解一次性数据下次是不会再读写的，没必要缓存，缓存一次性数据反而会让内存无法释放，他还找运维说这缓存有问题，内存不够要扩容。

### 7.2.2 运维参与PHP项目架构设计

（6）复杂逻辑比如特别消耗CPU和IO资源的，可在应用层使用其他技术来实现，比如JAVA、C++、Go、Node、js、不要局限于PHP，应合理利用各种技术的优势。

### 7.2.3 PHP运维常见问题及解决之道

“运维是保证网站的可持续性运营”，在腾讯运维岗位被称为技术运营。在我的理解中运维是把产品设计、研发开发、测试完成的代码部署到服务器上，并保证以良好的状态持续运行，监控随时发生的状况，出了问题能够快速定位并解决，甚至进一步让运行数据反向推动产品、研发、运营人员改进业务。概括地说运维是服务于从立项到研发完成、到上线运营、到下线的整个业务生命周期。从中可以粗略地看出运维应该做的事情包括如下几项。

❑部署：包括基础设施的资源部署、软件环境的部署。
❑业务上线：PHP代码发布。
❑稳定运行：保障用户进入网站页面后能一直顺利地完成整个业务流程。
❑监控：监控网站运行过程中的各种状态，如发生异常则告警。
❑性能优化：网站出现性能问题时能进行运维侧的优化，可帮助研发优化代码性能，容量不够时可快速扩容。
❑故障处理：出现故障后能快速定位到问题点。
❑数据分析反馈：对线上运行的状态能进行充分分析，把有用的结果反馈给研发和产品，推动产品进行下一次迭代。

### 7.3.4 PHP进程部署及配置文件管理实践

❑data/：存放程序运行期间生成的数据。
❑conf/：存放配置文件，php.in、php-fpm.conf等配置文件存放于此。
❑log/：日志，这里一般是软连接到系统大磁盘分区的日志目录。
❑bin/：存放二进制可执行文件，如php、php-fpm。
❑lib/：存放依赖的lib库文件。

### 7.4 PHP性能分析

性能的本质是延时和吞吐率，即所谓的latency和throughput。吞吐率是指在单位时间里完成的工作量，延迟是指一个请求从开始到完成所用的时间，有时也会认为与响应时间是同一概念。

❑延时/响应时间：一个PHP的请求（request）需要花费多长时间来处理，PHP执行需要多长时间。影响响应时间的因素包括PHP代码的执行时间、CPU、内存、磁盘IO、网络IO、SQL请求等。

❑错误率/失败率：PHP处理缓慢会导致超时或触发错误、异常，性能问题也体现在请求的错误率升高。

ab（Apache Bench）工具来分析，ab可以模拟用户对网站发起请求，常用参数为-n、-c，参数-n表示总请求次数，-c表示同时发起的并发请求数。例如要测试某网站的性能，命令如下：
￼
        ab  -n 300 -c 20 http://www.test.com/index.html
关注结果中的“Requests per second”和“Time per request”：
￼
        Requests per second:     285.54 [#/sec] (mean)￼
        Time per request:         1053.502 [ms] (mean)
可以发现平均响应时间大概在1s左右，并发数在285左右。结果中还有很多有用的信息，有兴趣的读者可以查阅相关资料。


### 7.4.3 性能分析方法

系统调用分析：所有软件对磁盘、内存、网络等硬件的操作都是通过操作系统来执行的，而系统调用是操作系统内核提供给用户态进程的接口方法。strace工具可以帮助查看用户进程调用的那些系统调用（如图7-27），比如磁盘读写、网络连接、网络读写、内存分配等操作及其耗时，从而进一步分析进程的资源消耗，进而有针对性地改进代码，优化程序。

命令格式：strace -p <PID> -T
其中PID是PHP-FPM工作进程的进程ID。
从图7-27可以看出大部分系统调用都在执行读取文件和从MySQL获取数据，且MySQL返回的字节数都有1000多字节，说明SQL返回的结果较大，但每次调用耗时还是比较短的（0.000015s），如果这里出现较长时间，很可能就是瓶颈所在。
strace还能统计一段时间内各个系统调用的执行次数和消耗时间，命令如下，结果如图7-28所示：

        $strace -p <PID>   -c
从图7-28可以看出stat（获得文件的状态）占了27%!的(MISSING)时间，poll（监测网络连接队列的事件）占了27%!。(MISSING)说明主要负载还是在查找文件和网络连接处理这两方面。解决办法就是和研发一起找到读取文件最多的代码部分，通过优化PHP代码进行解

1）访问日志分析每个请求的耗时
如图7-29所示，access log可以查看每次PHP的访问日志，包含了请求方法，请求的PHP文件及参数、返回码等，也有CPU、内存、时间消耗等。

4．常见外部存储的性能分析
（1）MySQL:PHP+MySQL是最常见的搭配，如果怀疑MySQL存在性能问题，那么我们可以通过如下几个方法来分析性能问题。
❑show processlist：显示当前正在运行的SQL的信息，分析SQL的数量及每条SQL的当前状态。
❑explain：取出可疑SQL执行explain SQL语句，可以分析SQL的执行计划、索引是否合理等。
❑show prof ile：通过show prof ile命令，可以分析出SQL的详细执行情况。
❑show status/show global status：可以查看MySQL内部的各种状态，包括连接、线程、内存使用、数据表的打开数量、SQL命令执行情况等。

Redis可以通过redis-cli命令进行管理，info命令分析Redis内部状态：包括连接情况、主从情况、持久化、内存使用情况等。也可以通过monitor命令查看正在Redis内部执行的指令。

### 7.5.1 PHP故障分类及处理思路

而罪魁祸首很可能是后端存储或调用外部连接反应太慢，或者挂了，导致PHP一直等待，达到了自行了断的条件。

❑502错误的一般处理方法：如果是执行超时时间配置不合理，则需要延长超时时间。另一种处理方法是从后端入手，找到关键的瓶颈点，比如分析数据库的慢查询、死锁、负载，执行中的SQL等，strace是个发现PHP连接后端超时的好方法。

❑503错误的一般处理方法：应该重点分析机器负载，Nginx进程是否存活，端口是否存活，Nginx进程的工作饱和度，如果以上都正常则应该参照7.4节所讲的方法分析Nginx状态。

❑404错误：表示页面不存在，静态页面或PHP文件被删除。

日常正常运行的网站如果突然变得卡顿，那么出现的故障大部分是性能问题造成的，往往是到了高峰期用户大量涌进网站，导致某些组件达到性能瓶颈。由PHP的性能问题所引起的故障比较常见的有如下几种。
❑PHP进程不存在：可能由于进程意外掉挂了，再没有起来，比较常见的是请求一直在处理中，达到max_execute_time时间，管理进程把工作进程干掉了。
❑PHP进程响应慢，Web服务器响应慢，达到超时后，返回503错误。
❑PHP进程本身慢：这种情况反而不多，只出现在少数特别复杂的框架写的程序中。
❑PHP依赖的接口慢：比如请求外部的接口，外部接口很慢等。
❑依赖的后端存储慢：这种情况比较普遍，比如MysQL、Redis、Memcached出现故障或性能问题。

### 7.5.2 业务监控和故障发现

好的故障处理是要做到比用户和老板先发现故障，甚至还没有出现故障，而只是一个风险点的时候就把它解决掉。所以故障发现是非常有必要的，故障发现最重要的方式就是监控

❑业务的URL：如果用户访问的页面都出现了问题，这是故障最直观的体现，则要加入URL监控，设定合理的超时值。可以使用服务器模拟用户访问，或者使用基调、博锐、监控宝等第三方服务。

❑错误日志的数量和比例：监控PHP的错误日志和FPM的错误日志，还有慢日志。可以通过数量得到错误率。通过日志内容进行双重监控。

监控系统是运维的核心系统。我们不可能每次都靠人工上服务器去分析问题，所以好的做法是自动把分析结果存入监控系统中，定期持续地记录数据。需要分析时到监控系统中去查看即可。监控系统可以使用开源的Zabbix、Nagios等，这些都是优秀的开源监控系统，大公司往往会选择自建监控系统。

### 7.5.3 PHP故障消除的方法

1．快速修复代码问题
❑回滚：如果是业务上线所导致的故障，那么最好的做法就是回滚。当然如果涉及有数据库的修改，那么要回滚将会是很困难的。必须要做出选择。是回滚容易解决问题还是应该直接扛住。
❑快速修改发布上线：在做了很多修改后发布上线，如果仅是某些小功能点故障，那么一般是不做回滚，而是快速修改，重新上线。同样，这也是权衡后的结果。

### 7.5.4 故障分析案例

现象：某业务反馈比较慢，有时报502错误。
分析：PHP访问日志（access log）看到有个查询列表页执行的时间比较长，进一步通过strace工具分析发现连接数据库和等待时间都比较长，估计是数据库负载较高。在MySQL中通过show processlist和分析慢查询，发现了问题SQL，有上千条，其中几条显示被锁了，分析问题SQL，发现是表索引不合理引起的。
结论和解决方案：是SQL写得不合理和表设计索引不合理引起的问题，加索引和优化SQL后即可解决，通过MySQL explain命令来分析SQL。关于SQL优化和MySQL优化，有专门的文章详细介绍，这里就不展开了。如何事前发现问题SQL，是运维和DBA的课题，可以考虑通过SQL的审计来实现。

有可能是第三方的，怀疑是通过HTTP协议调用了第三方的接口，外部接口慢导致PHP进程慢。于是我们通过基于xhprof的性能分析系统，发现（如图7-38所示）：

curl访问外部接口占用了太多时间，而且没有设置访问超时时间。让外部接口提供方查找性能问题，同时在curl_exec中设置超时时间为200ms，如果外部接口不稳定就快速返回失败，而不是卡在那里影响全局。

### 8.1.1 数据采集

要分析应用的运行情况，首先需要获得反映应用系统情况的数据，因为运行分析主要是解决性能、容量、客户体验的问题，建议从以下两方面定位好数据来源：
❑反映系统软件运行情况的容量性能数据，比如CPU、内存、数据库事务等。
❑反映交易指标的性能及客户体验数据，比如交易量、耗时、响应率等。

借鉴基于网络旁路APM工具抓取应用性能数据。这类APM工具的工作原理主要是在网络层面部署探针抓取应用报文，并将应用报文发送到集中的应用工具，通过对报文数据进行解码、清洗、合并等操作，获取以下数据信息。

### 9.3.3 其他提升桌面云存储性能的方式

私有云中有几种I/O风暴比较常见，比如登录风暴、杀毒风暴。登录风暴发生在系统启动后但还未进入桌面时，多人同时登录而对服务器造成压力的情况，这点我们从图9-9和图9-12中可以明显看出。对于登录风暴，我们可以使用自动登录的方式，将其与启动划分到同一顺序过程中，这样启动排队策略也能作用于它了。

### 第10章 私有云桌面网络组建

2016年年初，Amazon刚刚推出Workspace，即公有云形式的桌面。在此之前的几年中，桌面云主要是以私有云的形式存在，主要原因除了安全性以外，还有就是桌面协议性能所引起的带宽与延迟问题。

### 10.1.1 NAT网络

NAT的原理是在客户端发出的IP封包到达NAT网关后，其中的源IP地址会被替换为网关IP（这个过程称为SNAT，源IP和端口会被记录）再继续发送至外部服务器，当服务器将IP封包返回到NAT网关后，其中的目的地址将变更为客户端IP（这个过程称为DNAT，它会利用SNAT记录的IP与端口信息）再传递回客户端，外部地址一般不能直接访问NAT后端的地址（需要在NAT网关打开端口映射），

### 10.1.2 桥接网络

桥接是将两个以上的网络通过设备进行连接从而达到网络汇聚的目的。桥接位于OSI模型中的数据链路层

### 11.1 设备签收的学问

如果你把签收地址写到了机房里面，你就可以要求对方负责卸货并拆箱验收（这本来就是他们的分内工作）, IDC负责上架。这样我们就把人员全部都调动了起来，有效地提升了工作效率。签收地址在机房里面，只要设备没上架，你就有理由拒签。

### 11.6 小结

（8）要有一位能认可你的能力、支持你的想法、并且包容你犯错误的好领导，这条最重要。

### 12.1 Nginx基本安全优化

一般来说，软件的漏洞都和版本有关，这一点很像汽车的缺陷，同一批次的产品要有问题就都有问题，别的批次可能就都是好的。因此，我们应尽量隐藏或消除Web服务对访问用户显示各类敏感信息（例如Web软件名称及版本号等信息），这样恶意的用户就很难猜到他攻击的服务器所用的是否有特定漏洞的软件，或者是否有对应漏洞的某一特定版本，从而加强了Web服务的安全性。

可以通过配置文件加参数来隐藏Nginx版本号。
编辑nginx.conf配置文件增加参数，实现隐藏Nginx版本号的方式如下。
在Nginx配置文件nginx.conf中的http标签段内加入“server_tokens off; ”参数，

### 12.1.2 更改源码隐藏Nginx软件名及版本号

修改的第一个文件为nginx-1.6.3/src/core/nginx.h，代码如下：
￼
        [root@oldboy core]# sed -n '13,17p' nginx.h￼
        #define NGINX_VERSION       "1.6.3"       #<==修改为想要显示的版本号，如2.2.23￼
        #define NGINX_VER             "nginx/" NGINX_VERSION￼

### 12.2 根据参数优化Nginx服务性能

在高并发、高访问量的Web服务场景中，需要事先启动好更多的Nginx进程，以保证快速响应并处理大量并发用户的请求。

worker_processes 1; #<==指定了Nginx要开启的进程数，结尾的数字就是进程的个数
上述参数调整的是Nginx服务的worker进程数，Nginx有Master进程和worker进程之分，Master为管理进程，真正接待“顾客”的是worker进程。

高流量高并发场合也可以考虑将进程数提高至CPU核数×2，具体情况要根据实际的业务来选择，因为这个参数除了要和CPU核数匹配之外，也与硬盘存储的数据及系统的负载有关

application/nginx/sbin/nginx -s reload
现在检查修改后的worker进程数量，代码如下：

### 12.2.2 优化绑定不同的Nginx进程到不同的CPU上

默认情况下，Nginx的多个进程有可能运行在某一个CPU或CPU的某一核上，导致Nginx进程使用硬件的资源不均，本节的优化将尽可能地将不同的Nginx进程分配给不同的CPU处理，达到充分有效利用硬件的多CPU多核资源的目的。

### 12.2.5 配置Nginx worker进程的最大打开文件数

调整配置Nginx worker进程的最大打开文件数，这个控制连接数的参数为worker_rlimit_nof ile。该参数的实际配置如下：
￼
        worker_rlimit_nofile 65535;￼
        #<==最大打开文件数，可设置为系统优化后的ulimit -HSn的结果

### 12.2.7 开启高效文件传输模式

sendf ile参数用于开启文件的高效传输模式。同时将tcp_nopush和tcp_nodelay两个指令设置为on，可防止网络及磁盘I/O阻塞，提升Nginx工作效率。

### 12.2.8 优化Nginx连接参数，调整连接超时时间

例如，可设置为如果请求FastCGI 10秒内不能返回数据，那么Nginx就中断本次请求，向用户汇报取不到数据的错误。

2．连接超时的作用
❑将无用的连接设置为尽快超时，可以保护服务器的系统资源（CPU、内存、磁盘）。
❑当连接很多时，及时断掉那些已经建立好的但又长时间不做事的连接，以减少其占用的服务器资源，因为服务器维护连接也是消耗资源的。
❑有时黑客或恶意用户攻击网站，就会不断地和服务器建立多个连接，消耗连接数，但是啥也不干，大量消耗服务器的资源，此时就应该及时断掉这些恶意占用资源的连接。
❑LNMP环境中，如果用户请求了动态服务，则Nginx就会建立连接，请求FastCGI服务及后端MySQL服务，此时这个Nginx连接就要设定一个超时时间，在用户容忍的时间内返回数据，或者再多等一会后端服务返回数据，具体的策略要根据具体业务进行具体分析。当然了，后端的FastCGI服务及MySQL服务也有对连接的超时控制。
简单地说，连接超时是服务自我管理、自我保护的一种重要机制。

）设置参数：keepalive_timeout 60;
用于设置客户端连接保持会话的超时时间为60秒。若超过这个时间，服务器就会关闭该连接，此数值仅为参考值。

### 12.2.9 上传文件大小的限制（动态应用）

下面介绍如何调整上传文件的大小（http Request body size）限制。
首先，在Nginx的主配置文件里加入如下参数：
￼
        client_max_body_size 8m;
具体大小可根据公司的业务做调整，如果不清楚就先设置为8m吧，一般情况下，HTTP的post方法在提交数据时才会携带请求主体信息。

设置允许的最大客户端请求主体大小，在请求头域有“Content-Length”，如果超过了此配置值，则客户端会收到413错误，意思是请求的条目过大，有可能浏览器不能正确显示。设置为0则表示禁止检查客户端请求主体大小。此参数对提高服务器端的安全性有一定的作用

### 12.2.10 FastCGI相关参数调优（配合PHP引擎动态服务）

FastCGI参数是配合Nginx向后请求PHP动态引擎服务的相关参数，要想较好地理解参数细节，需要熟悉和了解Nginx FastCGI客户端配合php-fpm（FastCGI服务器端）的原理。

### 12.2.11 配置Nginx gzip压缩实现性能优化

1. Nginx gzip压缩功能介绍
Nginx gzip压缩模块提供了压缩文件内容的功能，用户请求的内容在发送到用户客户端之前，Nginx服务器会根据一些具体的策略实施压缩，以节约网站出口带宽，同时加快数据传输效率，来提升用户访问体验。

❑提升网站的用户体验：发送给用户的内容小了，用户访问单位大小的页面就加快了，用户体验提升了，网站口碑就好了。
❑节约网站带宽成本：数据是压缩传输的，因此节省了网站的带宽流量成本，不过压缩时会稍微消耗一些CPU资源，这个一般可以忽略不计。
此功能既能提升用户体验，又能使公司少花钱，一举多得。对于几乎所有的Web服务来说，这是一个非常重要的功能，Apache服务也有此功能。

❑图片、视频（流媒体）等文件尽量不要压缩，因为这些文件大多都是经过压缩的，如果再压缩很可能不会减小或减小得很少，甚至还有可能增大，同时压缩时还会消耗大量的CPU、内存资源。

gzip_min_length   1k;￼
        #<==设置允许压缩的最小页面字节数，页面字节数从header头的Content-Length中获取。默认值是￼
        0，表示不管页面多大都进行压缩。建议设置成大于1KB，如果小于1KB可能会越压越大。￼

### 12.2.12 配置Nginx expires缓存实现性能优化

更深入地理解：expires的功能就是允许通过Nginx配置文件控制HTTP的"Expires"和"Cache-Control"响应头部内容，告诉客户端浏览器是否缓存和缓存多长时间以内访问的内容。这个expires模块控制Nginx服务器应答时的expires头内容和Cache-Control头的max-age指令。缓存的有效期可以设置为相对于源文件的最后修改时刻或客户端的访问时刻。

在网站的开发和运营中，视频、图片、CSS、JS等网站元素的更改机会较少，特别是图片，这时可以将图片设置在客户浏览器本地缓存365天或3650天，而将CSS、JS、html等代码缓存10～30天。这样用户第一次打开页面后，会在本地的浏览器中按照过期日期缓存相应的内容，下次用户再打开类似的页面时，重复的元素就无需下载了，从而加快了用户访问速度。用户的访问请求和数据减少了，也可以节省大量的服务器端带宽。此功能同Apache的expires功能类似。

❑expires可以降低网站的带宽，节约成本。
❑加快用户访问网站的速度，提升用户的访问体验。
❑服务器访问量降低了，服务器压力就减轻了，服务器的成本也会降低，甚至还可以节约人力成本。

location ～ .*\.(js|css)? $￼
        {￼
            expires        30d;￼
        }
该范例的意思是当用户访问网站URL结尾的文件扩展名为js、css类型的元素时，设置缓存为30天，即1个月。

第一，对于经常发生变动的图片等文件，可以缩短对象缓存时间，例如：谷歌和百度首页的图片经常会根据不同的日期换成一些节日的图片，所以这里可以将这个图片的缓存期设置为1天。
第二，当网站改版或更新时，可以在服务器中将缓存的对象改名（网站代码程序）。

❑网站改版升级会修改JS、CSS元素，若改版时对这些元素名进行了修改，则会使得前端的CDN及用户端需要重新缓存内容。

8．企业网站有可能不希望被缓存的内容
❑广告图片，用于广告服务，都缓存了就不好控制展示了。
❑网站流量统计工具（JS代码），都缓存了流量统计就不准了。
❑更新很频繁的文件（Google的logo），如果按天缓存，效果还是显著的。

### 12.3 Nginx日志相关的优化与安全

>/dev/null 2>&1表示任何输出都不要。

### 12.3.2 不记录不需要的访问日志

在实际工作中，对于负载均衡器健康节点的检查或某些特定文件（比如图片、JS、CSS）的日志，一般不需要记录下来，因为在统计PV时是按照页面进行计算的，而且日志如果写入太频繁会消耗大量的磁盘I/O，降低服务的性能。
具体配置方法如下：
￼
        location ～ .*\.(js|jpg|JPG|jpeg|JPEG|css|bmp|gif|GIF)$ {￼
            access_log off;￼
        }
这里用location标签匹配不记录日志的元素扩展名，然后关掉日志。

### 12.4 Nginx站点目录及文件URL访问控制

location ～ ^/images/.*\.(php|php5|sh|pl|py)$￼
                {￼
                    deny all;￼
                }￼

### 12.4.2 禁止访问指定目录下的所有文件和目录

12.4.2 禁止访问指定目录下的所有文件和目录
范例1：配置禁止访问指定的单个或多个目录。
禁止访问单个目录的命令如下：
￼
        location ～ ^/(static)/ {￼
                deny all;￼
        }￼

### 12.4.3 限制网站来源IP访问

范例1：禁止外界访问某目录，但允许某IP访问该目录，且支持PHP解析，命令如下。
￼
        location ～ ^/oldboy/ {￼
            allow 202.111.12.211;￼
            deny all;￼
        }￼

### 12.4.4 配置Nginx，禁止非法域名解析访问企业网站

问题：Nginx如何防止用户IP访问网站（恶意域名解析，也相当于是直接IP访问企业网站）？

方法3：发现某域名恶意解析到公司的服务器IP，在server标签里添加以下代码即可，若有多个server则要多处添加。
￼
        if ($host ! ～ ^www/.eduoldboy/.com$){￼
            rewrite ^(.*)  http://www.eduoldboy.com$1 permanent;￼
        }
上面代码的意思是如果header信息的host主机名字段非www.eduoldboy.com，就301跳转到www.eduoldboy.com。

### 12.5 Nginx图片及目录防盗链解决方案

第二，作为高级运维或运维经理，每天上班的重要任务，就是经常查看网站流量图，关注流量变化，关注异常流量。
第三，对访问日志做分析，迅速定位异常流量，并且和公司市场推广等保持较好的沟通，以便调度带宽和服务器资源，确保网站正常的访问体验。

### 12.10 使用CDN做网站内容加速

CDN是一套全国或全球的分布式缓存集群，其实质是通过智能DNS判断用户的来源地域及上网线路，为用户选择一个最接近用户地域，以及和用户上网线路相同的服务器节点，因为地域近，且线路相同，所以，可以大幅提升用户浏览网站的体验。

❑可以阻挡大部分流量攻击，例如：DDOS攻击。

首先应尽量考虑把网站数据放到CDN中缓存，这样计算在网站中的总流量和总访问量后减去CDN的访问流量，剩下的访问量规模需要的架构才是我们需要设计和考虑的。一个良好的网站架构设计，访问量应尽量都交给CDN。

### 12.10.2 CDN的特点

❑加快了访问速度，减少了原站点的带宽。
❑用户访问时从服务器的内存中读取数据，分担了网络流量，同时减轻了原站点负载的压力等。
❑使用CDN可以分担源站的网络流量，同时还可以减轻原站点的负载压力，并降低黑客入侵及各种DDoS攻击对网站的影响，从而保证网站有较好的服务质量。

### 12.12 使用普通用户启动Nginx（监牢模式）

❑管理权限必须是root，这就使得最小化分配权限原则遇到难题。
❑使用root运行Nginx服务，一旦网站出现漏洞，用户就可以很容易地获得服务器的root权限。
因此，我想出了一种不用为开发人员，甚至普通运维人员赋予管理员权限，就可以很好地管理Nginx服务的方法，具体内容将在下节为大家讲解。

### 12.13 控制Nginx并发连接数量

用于指定key设置的最大连接数。当超过最大连接数时，服务器会返回503（Service Temporarily Unavailable）错误。
1．限制单IP并发连接数

### 12.14 控制客户端请求Nginx的速率

用于设置共享内存区域，key可以是字符串，Nginx自带变量或前两个组合，如$binary_remote_addr。name为内存区域的名称，size为内存区域的大小，rate为速率，单位为r/s，每秒一个请求。

### 13.1 游戏运维最关键的几件事

游戏运维的核心指标主要包含4个方面：安全、稳定、高效、成本节约

### 14.1.2 配置规范

❑log-bin：打开二进制日志功能，在复制（replication）配置中，作为MASTER主服务器必须打开此项，如果需要从最后的备份中做基于时间点的恢复，那么你也同样需要二进制日志。

### 14.1.5 其他规范

[mysql]￼
        prompt="\u@\h:\p [\d] : \D >"￼
        tee=/data/log/mysql_history/mysql_history.log

文件最大打开数，见如下代码：
￼
        [root@运维男 ～]# cat /etc/security/limits.conf￼
        * soft nproc 10000￼
        * hard nproc 10000￼
        * soft nofile 4194304￼
        * hard nofile 4194304

net.ipv4.tcp_max_tw_buckets：表示系统同时保持TIME_WAIT套接字的最大数量，如果超过了这个数字，TIME_WAIT套接字将立刻被清除并在/var/log/messages中打印警告信息，默认为180 000，改为10 000。
❑net.ipv4.tcp_tw_recycle：开启TCP连接中TIME_WAIT sockets的快速回收，默认是0，关闭。
❑net.ipv4.tcp_tw_reuse：设置为1表示开启重用，允许将TIME_WAIT sockets重新用于新的TCP连接，默认是0，关闭。

### 14.2.2 各个模块介绍

主库没有做真正的高可用，当主库挂掉时，需要在平台上点一下迁移按钮，才会做故障迁移，如果直接把主库的地址提供给业务人员使用，那么发生迁移之后主库的地址变了，还需要通知业务改代码，更换主库的地址，这显然是不科学的，这也是我们在主库迁移前加一层LVS的一个主要原因。

### 附录A 求职者与面试官

一轮面试下来，我都会回忆每一个环节的全过程，去思索哪里值得肯定，哪里做得不好。

说到职业规划，可能是很多人非常困惑的一个问题。很多人其实都缺乏这方面的意识，根本没有认真地考虑过自己的职业规划。他们希望参考别人的意见来确定自己未来要走的道路，或者认为应当先发展几年后才能定位，这些观念都是错误的。职业规划是一项自始至终都在进行的动态工作，在进入职场前就需要开始准备了。对于普通人来讲，职业收入是你的重要经济来源，关系到生活尊严与家庭幸福。怎么能够不认真对待？怎么能够依赖别人来指明道路呢？职业发展和婚姻同等重要，都是人生大事，存亡之道，不可不察啊。

向业内人士了解每个行业的发展趋势、职业特点和技能要求，再结合自身的性格和优缺点来选择发展道路。请记住，不管走什么路都一定要自己去决断。因为只有你最了解自己。如果你迷惘到连自己都不了解，那么别人指出的道路又怎么能够确保就一定是正确的呢？一句话，你自己就是你最好的职业规划师。

当然只具备意识是远远不够的，还需要明确的计划和切实的行动。

职业规划不是喊口号，和商业企划一样，要有详尽的方案才行。这项工作至少要分成这几个部分：定位目标、找出差距、设定计划、付诸实施。

不管这家公司的知名度如何，你最好都要先去了解一下它的背景和基本情况，包括行业地位、发展趋势、企业文化、业界评论等。另外，办公地点也要事先了解清楚。我个人认为如果有可能的话，最好还是能够进一家大中型企业。一个刚入行的新人就像一张白纸，第一家公司会对他们产生比较大的影响。大公司做事情相对比较规范，对新人的影响还是比较积极的。其次也可以考虑创业公司，相对于小公司，创业公司也许能学到更多的东西。但是关于创业公司，我只建议工作不足两年的新人去考虑。这个问题我会在后文中详细分析。总而言之，我们更愿意投身于一个做事规范，积极向上，有发展前途的公司。

你最好留意一下这家公司的办公环境、前台员工的职业形象及待人接物，等等。如果路过办公室，还可以观察一下公司员工的工作状态。他们是快乐奋进的？是疲惫痛苦的？还是百无聊赖的？员工的形象和工作状态是我判断一家公司优劣的基本依据。

另外，我会计算一下我的等待时间。因为等待时间是和重视程度成反比的。迟到是求职者的大忌，但有些面试官反而却不够守时，让候选人等待很久，实在是非常的不妥。

要面试官去处理临时故障，可能存在两种原因：①这个岗位严重缺人，目前可能只有这位面试官一个人；②这个团队的技术能力有问题，其他成员无法很好地胜任这个岗位的工作，表明团队成员技术落差大，人员存在单点。接下来你可能就要多留心了。你一定要搞清楚这种情况已经持续了多久。如果长期没有得到改善，则说明加入这个团队将会有很大的风险。

在反向提问的环节，求职者还应该更多地了解工作环境、团队情况、职位发展等问题。例如可以提出如下一些问题：
❑请问我们最近两年的发展目标是什么？要做到怎样的程度？
❑我能了解一下我们团队近两年的发展规模是怎样的么？未来我们还需要哪些成员加盟？
❑请问您认为目前我们团队所面临的最大需求是什么？
❑请问您最欣赏的员工应该是怎样的？
❑请问目前我应聘的这个岗位未来三年的发展方向是什么？

作为面试官，我遇到过两次候选人向我询问薪酬问题的情况。首先我只负责技术考核，后面还有总监和HR的环节。和我谈薪水既不合时宜，恐怕也找错了对象。

如果面试官在交谈中主动和你谈及薪酬问题，说明你已经成功了90%!，(MISSING)但要是你自己率先触碰这个敏感话题，那么肯定不会有什么好结果。

这些候选人，在使用“我们”作为主语时言语激扬，显得比较兴奋。而当他们被要求只描述自己的工作业绩时，也就是把主语更换成“我”时，立刻就会显得底气不足，同时语速下降，眼神也开始变得黯淡。

❑做事随意性强、不遵守已有规章制度，工作缺乏规范性的人。
❑凡事凭直觉做，缺乏细致分析，考虑问题不周全的人。
❑工作不认真，喜欢糊弄，抱有“60分万岁”主义的人。
❑责任心差，做事毛躁，对生产环境缺乏敬畏心的人。
❑自我意识太强，无法融入团队的人。
❑执行力差，工作效率低下，光说不练的人，
❑缺乏担当和大局观的人。
❑不喜欢做事，整天只会抱怨或到处搬弄是非的人。

2．浅尝辄止型
这也是一类典型的现象，这类人接触过很多领域的知识，但可惜的是对每一样都不够深入

1．拒绝重复性劳动，日常工作工具化
在这里我认为不适宜讲自动化的概念，我认为现今自动化概念的门槛被降得太低了。不是说写个脚本或程序就能称为自动化运维了。如果把手动操作比作走路的话，自动化应该是无人驾驶的汽车才对。目前我们也只是做到了工具化的级别，最多就是自行车而已，仍旧需要大量的人工干预环节。事实上，能做出尽量减少人工干预的工具化产品，也是一件非常不容易的事情。

5．用心做事最重要
做事情有四个层次：做任务、做工作、做产品、做品牌。

把事情做到极致、精益求精不过是匠人的最低标准，匠心精神还在于强调以几个下方面
❑坚持、专注：无论外界环境如何变化，匠人对做事原则和骨气都有着高度的坚守。
❑谦恭、自省：匠人实事求是，谦逊虚心，不自大，不吹嘘。
❑敬畏、入魂：匠人对工作有着崇高的职业自豪感与使命感，将自己的生命与灵魂注入到作品当中。
总而言之，缺少匠心的产品就没有艺术和价值，只有真正的匠人才值得人们尊敬。

像这种情况就称为职位天花板。平台的机制问题（例如绩效考核、管理制度、团队建设等）也是导致人员流失的主要因素，但它与前者带有不可抗力的属性不同，这类问题是可以改善的。因此团队的领导者应当重视机制的建设和改善。

离职有时候看似是自己的机遇，却往往是为他人做了嫁衣。

企业有时候急于求成也难免会看走眼，请来了不合适的人选，结果弄得双方压力都非常的大。行业圈子本来就很小，如果承担不了压力被迫离职是件非常糟糕的事情，传扬出去反倒坏了名声。

作为一个运维团队，技术诚然是最基本的要求。但我不会把技术排在第一位，而是更看重一个人的综合素质（包括性格、价值观、处事方法、同理心、责任心、认知力、沟通力、洞察力、执行力、学习力，等等）

如果是招纳新人，最好能有两年左右的相关经验。需要具备一定的基础知识，另外还有三点要求：执行力强；工作及学习意愿强；做事认真负责。

另外有些公司还喜欢进行压力测试的考核，故意刁难或刺激候选人，然后借以观察对方的反应和心理承受能力。我认为除非岗位有这种职业需求（高层管理人员或销售），否则压力测试实在是有悖常理。如果换位思考的话，你是否愿意接受这类测试呢？

在某一个技术问题上，如果候选人无法回答或答错了，面试官可以稍作提示，如果提示没有效果的话，就应该转入下一个问题。此时胜负已分，就该点到为止。穷追猛打不会显得你技高一筹，反而会令候选人更加紧张和不悦，正所谓得饶人处且饶人嘛。

和候选人一样，在面试之前，面试官也应当做好充足的准备功课，问问题应做到有的放矢。

作为一般职位，80%!的(MISSING)面试结果其实当场就已经决定了。如果你见到HR并谈到了薪水，基本上就成功90%!了(MISSING)。面试结束后你很快就能收到回复。相反的，如果没有见到HR或部门领导，那就是没戏了。除非明确是多场次的面试，否则那种被告知回去等消息的话，就是一种委婉的拒绝。

4）如果你被淘汰了，你觉得会是因为什么原因
我会直白地告诉面试官，那肯定是因为我与你合不来。

我认为让面试官先做自我介绍才是最好的开局效果。请面试官花费5分钟的时间先简要介绍一下公司的基本情况，还有你的团队规模、运维环境及所使用到的技术和职位要求，等等。如果是部门领导或HR，最好能对公司的商业运作、企业文化、福利待遇做一些宣传。这种自我介绍很容易打开话题，而且还可以缓解候选人的紧张情绪，

主要集中在三类问题上：第一，候选人在以往工作中最擅长的一两个技术，以考察候选人对以往工作是否用心钻研；第二，列出目前职位需要的技术点，让候选人选择一两个最有把握的，以考察候选人是否可以胜任工作；最后了解一下候选人最近在关注什么技术。每个问题要尽量深入，考察对方对原理或方法的理解程度。为什么不必问太多的问题呢？因为候选人挑选的已经是他最擅长的内容了，对最擅长的方面进行最深入的讨论足以考察对方的技术能力。一个问题的时间注意控制在5分钟以内。另外只要发现对方深入不下去了，结果也就显现出来了，应该停止讨论并切换到下一个问题。所谓点到为止，没有必要继续纠缠不清。这样计算大约总计花费半个小时。

第一，自己最大的非技术优势是什么（举例说明）？借以考察对方的性格品质和综合能力。第二，你对新团队的期许是什么？这显然比问为什么离职要好得多。虽然我觉得这两者其实本质上并没有什么差别，但显然这样的提问更加有亲和力。

最后和大家共勉一句话——也许你现在和我一样，不过是个无名小卒。但只要你愿意改变，世界一定会为你动容。