## 云原生敏捷运维从入门到精通
> 王宇 张乐 侯皓星编著

### 内容简介

第1章介绍云化产品的需求分析以及云资源的规划和选型；

### 前言

提高迭代的速度？答案是采用敏捷的方法配合高度的自动化。敏捷方法的特点就是微迭代，每个迭代周期很短，发布的内容很少，但都是经过充分测试的发布版本。

怎么才能做到这一点呢？答案是充分自动化。这就引入了持续集成和持续发布的概念。所谓持续集成，就是利用一套自动化工具，在每天的特定时间将当天入库的代码进行集成、编译、测试，保证当前的最新版本是可以发布的版本。所谓持续发布，就是在持续集成结果没问题的情况，根据软件发布的要求，自动发布最新的软件到生产环境，保证生产环境是最新的版本，从理论上应该可以实现每天或者更短时间一个发布。

满足持续质量保证的Jenkins集群定制、基于Kubernetes集群的端到端产品自动测试和基于Kafka和Streaming技术的实时预警、基于历史日志存储的ELK日志分析，在本书最后还向读者介绍了Devops和AIops的行业案例和最新技术进展。

了解和掌握基于云原生应用和产品的项目流程设计和运维的全过程。

原生云Devops的原理和流程

### 第2章 产品项目生命周期的开始——Redmine

Redmine是一个基于Web的项目管理开源解决方案工具。它向用户提供基于项目活动和问题的完整生命周期跟踪和管理。

### 第3章 管理代码——从分布式版本控制系统Git出发

（4）提交（Commit）提交可以简单地理解为某一次的代码改动后当前工作区的快照。每个提交都会产生一个新版本的唯一标识，在以后任何时候都可以通过此标识快速回溯到此时刻的代码状态。所有提交也即构成了每个分支的追溯信息。

（7）标记（Tag）标记是为了标识一个特殊时间点的分支版本状态。在发布某个版本重要开发节点时，会经常在主分支打上相应标记，以后可以方便地切回到标记的版本。

Git之所以能够完整克隆仓库并追溯历史内容，要归功于其内容寻址（Content-Addressable）文件系统。任何仓库内部的改动（包括新文件的保存或者文件更新），都会在Git文件系统中保存为一个副本。这个副本即当前文件的完整快照，是一个二进制对象，对象名是计算文件内容后生成的一个SHA1哈希值，计算文件内容而非文件名生成的SHA1哈希值保证了同文件的每个历史版本都能保存为单独的二进制对象。

git-add所做的工作就是保存记录文件内容的二进制、更新索引并生成tree对象。

git pull实际是git fetch和git merge的快捷命令，它会先下载远程仓库的更新到本地版本库，然后将当前分支在远程仓库的更新合并到本地仓库：

git pull rebase有一个直接的好处是，当你用git log查看合并后的提交日志时，可以看到和远程仓库中一样的D、E、F提交信息，完整的工作记录就被保存了下来，如果你希望看到线性的提交历史，而不是在提交日志中出现一些有点碍眼的“merging”提交，git pull rebase是正确的选择。但是任何事情都有两面性，git pull rebase重写了提交历史，使得你无法从日志中直观发现远程仓库什么时候被拉取合并过。

-m选项用于重命名分支，以下命令将当前分支重命名为branch_changed：

即Git流（Gitflow）工作流。Git提供了一个标准工具git flow去定义Git流工作流，git flow是Git的扩展，它实际上将Git的一些基本命令用脚本组合了起来。

● develop分支一般用于所有已完成或者正在进行的功能代码的汇总，同时也是新功能开发的基础分支。下一次的产品发布，通常会根据预先制定好的发布计划先从develop分支选取相应的代码改动并入master分支，再从master分支构建发布产品。

一旦有新功能需求，开发者便可以在默认已创建的feature分支上进行开发工作，当多个功能并行开发时，项目会建立多个不同的功能分支。功能开发完成后，分支代码会被合并入develop分支，此后该分支便可以被销毁。在大型的较为规范的商业软件项目中，即使功能开发完毕，功能分支通常也会被保留下来以组成项目的全历史追溯系统。

此外在Git流工作流模式中，功能分支的代码不会直接进入master分支，都是先并入develop分支，继而进入master分支用于产品发布的。产品v1.0、v1.1、v1.2版本相继由master分支交付，而feature-A和feature-B在v1.2中被发布。

由于git flow默认所有功能分支都基于develop分支，因此在git flow帮助下创建功能分支就会简洁一些：

而hotfix直接基于master分支。hotfix分支是Git流工作流模式中仅有的从master分支直接分叉而来的，相应的工程师在hotfix分支上修正问题后，hotfix分支会被立即同步到master分支和develop分支（或者当前的release分支），并且master分支上会打上新的版本标签，例如v2.0_hotfix1。

### 3.2 管理分享代码宝库——GitHub

基百科上对GitHub的功能列表描述为：
● 文档：包括自动生成的、采用类Markdown语言的Readme文件。
● 问题追踪系统（同时可用于功能需求）。
● Wiki。
● GitHub Pages支持用户通过软件仓库建立静态网站或静态博客（通过一个名为Jekyll的软件实现）。
● 任务列表。

### 3.3 企业的内部代码仓库管理——GitLab

2014年，GitLab有限公司成立，GitLab已经由GitLab Inc.拥有。GitLab能被部署到自己的服务器上，更安全可靠，适合企业级别的团队内部协作开发，已被很多大公司或组织采用，如IBM、NASA、阿里巴巴等。GitLab主要有以下两种类型的产品。

● 提供内置的持续集成CI解决方案，不再需要用额外的Jenkins等工具打造CI流程，极大地方便了项目的交付集成管理。
GitLab为付费用户提供了更多高级功能，如代码质量扫描、更强大的CI pipeline资源、安全测试检测、技术支持等。由于本章的主题是版本控制系统，对于其他功能这里不再展开叙述。

### 第4章 让需求和质量持续得到满足——快速交付中的Jenkins

敏捷开发是最近几年非常流行的一种软件开发方法，表现为快速迭代、持续演化的软件开发方式。敏捷的实现方式是用一套规范、可重复、可靠的流程将软件产品生成过程中的规划、开发、构建、集成、测试、交付、部署环节串联起来。Jenkins即是这样一种实现了软件生产各环节相互串联的工具，在面向驱动的敏捷开发运维中使用非常广泛。

Jenkins现在已经演变为基于Java的开源工具，用于自动化持续重复的工作，它提供了一个开放易用的软件平台。Jenkins结合其他的自动化部署、测试技术用于软件工程的持续自动化构建和测试，有利于开发者将代码变化集成到产品，使产品快速迭代、持续交付成为可能。Jenkins的主要优势包括：

/var/run/docker.sock保存docker守护进程默认监听的Unix域套接字（Unix Domain Socket），容器中的进程可以通过它与Docker守护进程进行通信，Jenkins容器可以通过暴露出来的域套接子操作主机的其他容器

### 6.2 实现部署——使用Ansible配置管理

2）使用缩进表示层级关系。
3）缩进时不允许使用〈Tab〉键，只允许使用空格。
4）缩进的空格数目不重要，只要相同层级的元素左侧对齐即可。
5）# 表示注释，从这个字符一直到行尾，都会被解析器忽略。

### 6.3 构建容器式交付部署环境——使用Kubernetes集群

这表明私有仓库不支持HTTPS协议，目前docker pull（私有仓库的客户端）在默认情况下使用HTTPS协议，为了解决这个问题，可以采用下面的方法。
￼
这种方法有两个问题：一是它将docker pull的HTTPS支持降级到HTTP协议，这将忽略私有仓库的认证，从而存在因为人为疏忽连接上钓鱼网站的风险

证书或者是数字签名是实现双方信任关系的手段。通常证书是由权威机构签署的，权威机构签署证书的好处是，大部分操作系统和浏览器已经内置了它们的根证书，所以在认证权威机构发放的证书时，不需要在目标系统上安装根证书。但是权威机构发放的证书都是收费的，对于学习目的有些昂贵，所以下面我们介绍的第一步是如何产生自签名证书。

最后调用openssl x509命令生成认证文件：
￼
一旦产生了自签名证书，我们就可以基于自签名证书启动私有镜像仓库。

步骤3：复制根证书。
我们不是权威机构，操作系统或者浏览器不可能内置我们的根证书，必须把根证书复制到所有需要它的机器上，这里实际上只有Docker需要用它，所以需要将证书复制到目录/etc/docker/certs.d/<域名>，这里的域名是10.140.0.15，并且改名为ca.crt，表示它是服务器根证书。

### 第8章 新的开始——拥抱机器学习与人工智能的明天

AIOps利用机器学习和大数据方法，以自动化决策的方式完成IT运维或者运营的任务。以往需要大量人工治理的工作现在可以由AIOps自动化完成。

### 8.2 AIOps的应用场景和典型案例

在AIOps的帮助下，这个流程会被完全革新，不需要各个角色的参与，AIOps会实时检测线上异常，再对异常进行根因分析，接着提出修复建议或者直接自动修复。

### 附录A-4 使用Google云实现敏捷运维管理的相关服务

（2）Google容器镜像仓库


（5）Google监控工具
参见https://cloud.google.com/monitoring/？hl=zh-cn。
（6）Google日志管理
参见https://cloud.google.com/logging/？hl=zh-cn。

### 附录B 云服务测评指标体系（CMI）

2）客户用户需求指标（Client Personnel Requirements）。3）可学习性指标（Learnability）。4）可操作性指标（Operability）。5）操作透明性指标（Transparency）。