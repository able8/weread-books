## SRE生存指南：系统中断响应与正常运行时间最大化
> 纳特·韦尔奇

### 推荐序1

当人类的工作、生活变得越来越依赖互联网时，一旦网站系统不可用，其造成的影响和损失就将难以想象：在远古时代，人类能够习惯没有自来水，也没有电的生活；但今天如果停水、停电，很多人都会无法适应。

互联网正在逐步演变成像供水、供电设施那样的基础设施，网站系统的可用性变得至关重要。

冗余和容灾、容量规划、系统自动保护、失败预案、监控能力、发布与变更管理、故障应急处理等构成了SRE领域的蓝图，并不断地快速迭代着

### 前言

第2章 监控，讨论了在监控时使用的工具和方法。在本章之后，一个很好的实验就是设置对服务的监控，即使它们只是为测试而编写的虚假服务，你也应该去监控它们随着时间是否有所变化。

第3章 事故响应，解释了该如何应对中断，并让团队为最坏的情况做好准备。本章还专注于围绕团队协作建立即时响应与轮换的最佳实践系统，以及构建流程以尽量减轻由生产事故造成的压力。
第4章 事后回顾，让你能为自己、你的团队和你的组织撰写事后回顾报告，以促进事后回顾。本章还讨论了要收集的数据，以及如何借助通信跟踪未来的工作。

### 1 简介

随着互联网的发展，人们已经习惯于从各种设备中随时获取内容。这意味着产品品牌的声誉已经慢慢地与产品的响应性和可靠性联系起来。

这种可靠性对企业来说越来越重要，并逐渐形成了一个专注于软件可靠性的研究方向：站点可靠性工程。本

### SRE简史

在大型组织中，往往会组建专注于开发或维护一些工具的团队来可靠地管理基础设施，以便产品团队可以快速、轻松地管理所需的基础设施。这些联合团队通常被描述为SRE或 DevOps（Developer and Operations，开发人员和运营团队）。

说“当要求软件工程师规划一个运维团队时，SRE就诞生了。”（引用自《SRE：Google运维解密》）他经常被提及的观点是，运维工作现在只是软件工程的一个方面。鉴于谷歌在可靠性方面取得的成功，这个观点已经在许多公司中流行起来。

### SRE是什么

没有什么东西是完美的，在互联网上也没有网站能达到100%!正(MISSING)常运行，因为不好的事情总会发生。因此，我们所能做的就是尽可能找出可能发生的故障，并以有用的方式优化产品使其具有抗灾性。SRE不仅仅是对系统的分析，它还关乎如何对系统展开架构设计与构建，从而满足产品的需求。

互联网上的软件永远做不到完全可靠，这里有两个原因。第一个原因是，互联网是一个分布式系统，各部分经常出现故障，这会影响服务的可用性。第二个原因是软件是人编写的，所以Bug不可避免，而Bug会导致系统宕机。

### 关于这本书

● 第2章 监控：第一层是监控，它确保你洞察系统，跟踪系统的健康状态、可用性，以及系统内部发生的事情。监控不仅仅是工具，因为它也需要沟通。

容量规划也是为了确保系统可以随着时间的推移得到完善和增强。一旦去监控系统并使它能够可靠运行，你就可以开始考虑如何随着时间的推移去扩展它，以及如何查找和预测性能瓶颈和资源限制了。

我们希望SRE工程师将花费大约一半的时间来开发新的工具和服务。这些工具中的一部分将用于自动化一些手工任务，而其他工具将用于改进Mikey金字塔的其余部分，例如用于自动负载测试或用于提高性能的服务。

### 以SRE作为新项目的框架

下面让我们开始研究本书的每一章并提出以下问题。
● 服务有监控机制吗？
● 团队有事故响应的计划吗？
● 团队有事后回顾报告吗？它们存放在哪里？
● 服务是怎么被测试的？项目有发布计划吗？
● 有人曾经做过扩展计划吗？
● 能使用什么工具来改进服务？
● 当前的可靠性水平是否提供了令人满意的用户体验？

时间和精力都是有限的资源，因此，你总是需要与更多的人共同协作，所以一定要慢慢来。走得慢点意味着事情不那么容易会被遗漏。你

### 小结

我们将探索监控领域。监控是研究一个系统运作的基础。你可以通过监控来记录系统历史数据，以及通过分析收集到的数据来探索系统的行为。到第2章结束时，你将了解程序检测、数据聚合、数据存储及数据展现的基础知识。

### 为什么要监控

两种不同类型的监控。第一种是指标，第二种是日志。指标，在这个例子里面，是度量数字。在传统意义上，指标侧重于性能数字，例如，磁盘空间使用率、接收的数据包数量、CPU负载。现在，它们可以用来表示任何可以定义为数值的东西，可以是来自系统中的任何软件。日志用来记录事故，通常也包含一些数字与数据，但往往结构松散。有些日志是完整的JSON数据块，而有些只是人工格式的文本字符串，日志也可以是介于两者之间的东西。

请求（Requests）、错误（Errors）、延迟（Latency）。

### 检测应用程序

下面是一个非常小的中间件，它将封装传递给它的任何处理程序、增加请求计数和记录请求持续时间。为

上面的/metrics是访问指标的endpoint。如果访问此服务器上的/metrics，你将看到此服务器导出的所有指标的当前值，这也是Prometheus获取其数据存储中存储指标的路径。可以配置这个路径为任何路径，/metrics只是一个常见的默认值。

### 收集和保存监控数据

轮询（也称为拉取）程序从服务中抓取数据，然后存储并显示数据。轮询应用程序的缺点是，需要保留一些关于所有服务的记录，以备不时之需。这不是这类程序的问题，但需要考虑的问题是：如何知道服务器上正在运行哪些服务？

推送应用程序常被吐槽的一点是，如果许多服务同时向它传送数据，则可能会出现问题。但推送应用程序本身没有任何问题，它们只是具有不同的架构。与轮询应用程序一样，有很多大大小小的公司使用推送应用程序，并且行之有效。

### 展示监控信息

收集数据并将其保存到数据存储中之后，就可以向用户展示这些数据了。前面提到的许多监控工具都提供了自己的可视化系统。

### 管理和维护监控数据

监控是人们最容易遗忘的系统之一。通常情况下，它只是默默地工作，以至于被遗忘、忽略。你要确保对它保持关注，这样它就不会在你最需要它的时候不起作用了。正如我们在本章中多次提到的——确保服务正在按预期工作。具体到监控，它应该持续存储指标数据。

### 沟通

随着监控越来越广泛地被应用，人们可能会发现监控系统让人兴奋的新用途。例如监控图表可用于董事会会议提交的执行摘要；开发人员可能不仅要求聚合生产数据，还要求监控来自开发环境的数据，以帮助其调试性能问题。

监控服务只是另一个产品，所有基础设施也都是这样。它将随着市场调查、可行性研究和基于客户反馈的持续迭代而改进。

### 3 事故响应

事故响应建立在使用监控构建的数据之上，并借助反馈循环，来帮助我们加强对服务的监控。这向我们展示了什么是重要的。因为如果没有得到警报，而是有人告诉我们服务没有正常工作，那么我们的监就是不到位的。

### 什么是事故

事故是指一些重要的事情发生，它迫使你改变正常的行为。

事故一般是相似的。它们往往是系统性的变化（来自系统本身或系统正在接收的输入）或系统运行环境的变化而引起的故障。系统本身的变化通常是由于代码的部署或系统操作的规模变化造成的。

在上面的第3个示例图中，存在某种网络不稳定性，因此两个软件不能与右边的数据库进行通信。在这种情况下，负载均衡器没有将数据库的连接性作为其健康检查的一部分，因此任务仍在服务中。也就是说，50%!的(MISSING)请求可能是错误的，因为任务不能与数据库保持通信。

世界是由持续不断的混乱构成的，这意味着变化可能来自四面八方。

### 什么是事故响应

事故响应通常包括以下几个动作。
● 关注，注意到有些东西不对劲。
● 交流，告诉别人哪些东西不对劲。
● 恢复，纠正不对劲的东西。

### 警报

警报是对正常工作的打扰，因此，如果警报触发不合理，或者没有经过深思熟虑，那么它可能迅速扰乱你的生活，并使你与项目的关系恶化。

像监控一样，警报是一个不断变化的东西。要警惕过于频繁的警报，因为无论是谁收到警报，效率都会降低。不断的评估是必需的，这样人们才能确保警报是有用的并对它做出正确反应。

● if [[ $status_code -ne 200 ]]；检查$status_code是否不等于200。如果不是，那么需要发出警告。几行后的fi会关闭这个if块。

待命工程师（on-call engineer）发出警报。

无论你的团队选择什么时间表，请确保它适用于所有待命者，并且让人们知道他们什么时候必须有空。如果可以，尽量试着避免收到这样的信息：“噢！我是待命者吗，还是只需要坐下来看戏就好？我没有笔记本电脑，别的人有吗？”


### 随时待命

创建一个明确的上报策略以供待命者（和警报系统）遵循。如果只有一个团队，那么通常会涉及的人是待命者、后备人员，然后是团队的其他成员。

给待命者更多补偿。也就是说，如果可能的话，尽量支付他们在传统工作时间之外的额外费用。我的基本理念是，待命者应该加薪15%!。(MISSING)

### 沟通

好的设置通常有两个频道。一个频道可用于处理停机的人员的讨论，另一个频道可用于受事故影响的人员。两个频道分开讨论，但要将事情集中在各自的房间内。

如果在处理一个问题10分钟后仍然毫无头绪，那么就应该开始寻求帮助了。通常情况下，在10分钟后我就开始联系副手，因为那时我已经知道是自行处理，还是需要另一双手了。如果副手也不知道，那就引进其他人。慢慢地培养那些参与其中的人，直到你了解了什么不起作用，以及如何使系统良好运行为止。

除内部沟通之外，这还有助于发布公共状态页面。例如谷歌云状态页面或Cloudflare状态页面就非常有用，因为当外部客户有问题时可以有个地方去查找。通常情况下，从Twitter或Facebook等地方链接到这些页面会减少你的支持团队收到诸如“有什么东西坏了吗？”这种邮件。

### 恢复系统

这是因为你不一定要立即进入Bug搜索模式。相反，你希望找到系统中发生了什么更改并进行回滚。

如果应用程序没有更改，或者回滚也解决不了问题，那下一个要查看的方面就是环境是否发生了改变。输入改变了吗？是否开始接收大量流量？收到的是一堆无意义或损坏的流量吗？当想出如何更改应用程序以更好地处理这种类型的错误流量时，是否需要开始阻止某个IP地址或用户代理？这是有效的流量吗？如果是这样，是否可以增加运行的东西的数量，以提升用于应对流量增加的资源数量？

这个要检查的列表（代码更改、输入更改和依赖项更改）

### 警报解除

请注意，第一目标始终是启动系统，而不是解决问题或找出根本原因。

一旦验证了解决方案，然后发布一个更新说明事情已经解决了，并提及是否会有后续行动。那么在找到并修复中断的根本原因后，至少要再发布一次更新。

### 小结

事后回顾是记录和回顾你所做的工作，并且通过团队合作来减少未来事故的行为。

### 为什么写事后回顾报告

在响应一个事故时，提到了需要集中精力尽快使系统恢复到健康状态。这种需要常常会阻止你发现事故的根本原因。撰写事后回顾报告正是找出根本原因的好时机。进程是如何“死亡”的？系统的哪部分引起了不稳定？事故发生后多久我们才注意到？为什么其他系统也失败了？

事后回顾报告允许你记录所发生的事情、解决问题的方法，以及你的团队学到了什么。然后你可以共享文档并将其归档，以便组织中的人员可以参考该文档，并了解你的团队针对此类事故采取了什么类型的行动。

透明文化也有助于增进信任。如果你能看到别人正在做的工作（以及他们如何处理紧急情况），你更有可能信任他们，并且珍视他们提出的建议。

除生产事故之外，你还可以写有关事件的文档。事件的文档在形式上往往更自由，但也能提供相同的好处。事件可能指的是产品上线、重要的新特性、复杂的集成、供应商的变化或类似的东西。记录重要的业务事件可以对你的日后有所指引，并在做出未来决策时有所参考。此文档可以防止未来的团队以相同的方式实现新特性或再次尝试相同的产品策略。它还可以帮助你根据团队如何处理过去的事件来规划将来类似的事件。

他们保证你已经着手解决问题，并且不会再遇到这种类型的中断将提高他们对你的信任度，这也有助于减少客户在使用你的服务或给你的服务付钱时的顾虑。在我看来，公司越透明越好。话虽如此，由于法律或财务限制，有时你无法向大众透露所有内容。

### 何时写事后回顾报告

1.如果几天内发生两次相同的事故，则应该写一篇事后回顾报告。
2.如果服务中断超过30分钟，则应该写一篇事后回顾报告。

### 开展事故分析

事故分析是复杂的。有时你会立刻知道答案，有时则需要数小时或几天的研究。你应该像偏执的夏洛克·福尔摩斯那样深究这个系统。从事故现场出发，深入挖掘各个方面。要谨防先入为主的观念，要意识到红鲱鱼，并且要验证你的假设。

### 如何写事后回顾报告

个大概的事后回顾报告的模板如下：摘要、影响、时间表、根本原因、行动项目和附录。

在文档的顶部，添加相关人员的姓名、事件发生日期，以及文档最后一次修改的时间。如果你将事后回顾报告存储在云端，则可以添加关键字或标记来帮助组织文档。

第一部分应该是执行摘要。这意味着无论谁打开这个文档，他们都应该对发生了什么、何时发生的，以及谁受到影响有一个大致的了解。它往往是简短的，给读者一个关于事故的“快照”。

我们没有看到这些外部故障，但在此次中断期间，客户提交了15个相关的生产环境支持案例。我们决定不发布公开的事后回顾报告，但对这15个案例做出了回应。

也可以通过社交网络和新闻网站来搜索提及你的宕机的信息。或者，可以深入挖掘日志，并尝试估计有多少客户机知道了服务器宕机。这个估计不是完美的，但可以让你更好地了解这种影响。另一种衡量冲击的方法是查看外部状态页的访问量。如果有谷歌云状态页或GitHub状态页这样的状态页面，就可以根据用户访问量的增加推断出有多少用户对宕机事故感兴趣了。与更直接的度量或客户通知相比，它提供的信息更少，但是它可以帮助你了解有多少人关心系统的性能。

附录是添加与此事故相关的所有事项的部分。添加聊天日志、相关服务日志、屏幕截图、图形、外部URL等是确保文档将来能够独立存在的好方法。每个条目都应贴上标签，以便于查找。
附录的使用方式与时间线相同，它提供了如何找到根本原因的上下文，并提供了与文本一起使用的可视化显示。附录也很重要，因为现在使用的工具可能将来就不再使用了，或者之后很少会以相同的精确度监控数据了。通过拍摄系统的快照，可以让你的团队了解过去，而无须永久存储高精度的监控数据。

### 停止事后指责

人们因为害怕失败，对服务中断甚至手中的工作感到恐惧。但事实是——我们与失败为伴。作为人类，失败是我们最明确的特征之一。SRE的一个关键原则是，如果无可避免要经历失败，那就竭力改变你的组织，让它对失败宽容，你可以从失败中快速恢复并吸取教训。另一个原则是可靠性是团队共同奋斗的方向。每个人都需要放心地提出问题，应对停机，并努力改进系统。培养这种认知水平是非常困难的，并且需要不断强化和帮助。

不要责备人类，每一步都要充分利用工具来防止人类犯错误。可以思考自动化可以防治人们遗漏检查表中的步骤吗，有检查清单吗。众所周知，检查清单可以挽救生命（这是多年前由医学和航空专业人士发现的）。作为计算机程序员，我们可以将过程转换成代码。这样做的原因是，总有一天有人甚至不知道清单的存在。所以，不要要求人类做某事，而要找出人类不应该做某事的地方。

人们需要感到安全才能提出问题。在组织中的人，不管职位有多高，都需要一起工作来解决问题。每个人都需要对失败感到安全，并与他人讨论他们的失败。如果人们感到不安全，他们往往会不诚实，或者可能试图隐瞒东西。更糟糕的是，他们可能就此离开。

### 举行事后回顾会议

● 应该改进做什么？最后，把重点放在需要改进的事情上。

### 分析以往的事后回顾报告

每季度一次，或者每年一次，收集所有的事后回顾报告，并尝试收集总结一些指标。这些指标可以帮助你深入了解你的团队对事故是怎么响应的。
● 故障恢复时间
● 故障间隔时间
● 触发的报警数量与生成的事后回顾报告数量
● 轮值者触发的平均报警数量

### 小结

我们将讨论测试和发布，考虑我们编写的代码，以及如何让它接受现实的验证。我们已经经历了事故，现在让我们把目光转向产品和服务的不断演变吧。


### 测试

时，会发生什么？
3.假设：提出假设。在代码中，这更多的是询问你想要发生什么。
4.测试：行动并验证，代码是否以想要的方式做出了反应？
5.拒绝或通过：如果测试失败，那么需要修改一些东西（如测试、代码、基础设施、流程等）以满足你的期望。

有很多类型的测试可以对代码进行验证，但我倾向于将它们分成3类。
● 单元测试：用于确保函数和方法正常工作。
● 特性测试：也称为冒烟测试和验收测试。它们验证特性是否正常工作。
● 集成测试：这些测试用于确保特性和系统正确地协同工作。

特性测试要测的是业务逻辑、用户交互，以及通过多个函数的数据流。通常，特性测试将测试API，如确保API符合发布的规范。

### 发布

在蓝绿部署中，在保持旧版本运行的同时，对新版本进行部署。然后将新的负载平衡器指向新版本，然后一旦验证过新版本运行良好，就把旧版本离线。在蓝绿部署中，蓝版本是旧的，绿版本是新的。
蓝绿部署很有用，它允许你快速转换到正在运行的服务，特别是对回滚很慢的情况来说。你甚至可以通过缓慢迁移两个集群之间的通信量来结合金丝雀和蓝绿部署。

有些人问应该多久发布一次。我个人喜欢尽可能频繁地发布，代码在发布之间变化越小，如果有问题的话也越容易跟踪其的原因。另一些则采用更有计划性的方法，例如选择每个星期二、冲刺的第二天到最后一天或任何其他任意时间进行发布。所有这些选项都可以。最好和团队一起协作，找出适合你的团队的时间表。

在发布版本之后，需要验证它。在计算机领域各种问题都可能出现，因此能够验证服务是否运行了正确的版本，以及是否正常工作非常重要。不应该只是等待错误是否出现，除非你拥有大量的用户基础，否则你不能假设用户在发布后会碰到所有特性和边界情况。要确保有人负责验证所进行的更改是否实际有效，以及部署是否顺利。

在检查发布的新更改之后，监控和错误跟踪可能是随着时间的推移验证发布的最好方法。对警报和监控进行优化可以让你轻松地知道发布是否稳定，并且不需要在代码中引入任何回归测试

但是，你不能仅仅测试以确保回滚发生。当进行回滚时，你还需要进行验证，就好像刚刚发布了一样，因为这确实是真的发布，只是一个以往的版本罢了。

### 自动化

测试和发布的自动化通常需要自动化3件事情。
● 构建：从源代码构建出实际的构建物
● 测试：验证构建物
● 分发：向用户发送构建物

如何设计自动化取决于你和开发人员的工作流程。有时你必须构建两次，一次带有测试选项，一次带有生产优化。有时你需要构建一个二进制文件，然后围绕它构建一个包来分发它。你还可以缓存你的构建，所以你的测试运行程序可能只需要去获取最近构建的二进制文件来进行测试。大多数服务甚至支持定义工作流，因此你可以并行地或顺序地执行许多不同的操作。

Continuous integration是指在每次提交时都应该运行一组测试以确定代码是否存在Bug。Continuous deployment是指每个提交都应该自动部署到生产环境中。Continuous delivery与此类似，但重点在于它取决于你是否允许部署，一旦你决定允许部署代码，整个部署将自动发生。Deploy on green是指每当测试通过时就应该进行连续部署。

### 企业财务简介

● 现金流：描述有多少钱，这些钱从哪里来，去往哪里。它包括收入，即钱从哪里来；以及支出，即钱往哪里去。

● 资产负债表：资产负债表是资产、负债和股权的列表。基本上，这包括公司所拥有的财产、债主，以及股东。资产负债表的基本计算方程是资产=负债+权益。花的钱（资产）等于从银行借的钱（负债）和股票（从投资者那里得到的钱）的总和。

经营性支出就是除资本支出外的一些支出。它是你无法收回的投资，如保险、劳动力、人力成本、基础设施等。如果你是园艺服务者，购买割草机将是资本支出，而它的燃料将是经营性支出。

### 为什么需要规划

规划是痛苦的。它要求你的监控系统是可靠和全面的。它要求进行一些负载测试。它需要与业务中的每个相关人员进行交谈，从编写代码的开发人员，

规划的主要目标是管理风险和期望。可以说，这同样适用于整个人生，包括管理他人的期望和检查做某事的风险。对于容量规划，它涉及将容量扩展到整个业务。你所关注的期望是人们在看到业务增长（尤其是自发增长）时期望服务如何响应。你正在评估的风险是在额外的基础设施上花费时间和金钱来处理这个问题。

### 定义一个规划

在执行规划时，请确保对变更进行了监控。基础设施的变更就像代码的变更：提交代码时出错的所有东西在部署基础设施时都会出错。

除一般的基础设施和系统状态之外，你还应该确保你的假设得到验证。你根据当时事实制订了计划，很可能在最初的计划和最后的执行期间事情已经发生了变化。注意账单和发票，并注意服务的整体性能。你有期望的备用容量吗？使用量是否按预期的速率增长？

### 技术作为利润中心和采购

根据公司的实情，可以将技术视为利润中心或成本中心。通常，如果技术是要销售的产品，那么技术团队就处于利润中心；而如果技术是帮助公司成功的，那么技术团队就处于成本中心。

### 小结

这对SRE很重要，因为容量不足会导致服务停机。通过与同事一起工作，你可以制订计划以应对将来的停机来提高长期可靠性。记住首先要摸清楚当前的容量是什么，看看它是如何随时间变化的，然后获得预算，以确保你可以处理所预测的增长。

### 7 构建工具

编写软件是我最初进入技术领域的原因。我喜欢用很少的资源创造出能触及数百万人的东西。我感觉编写软件是纯粹的在为大众创造。只需要一个文本编辑器和一个解释器或编译器，就可以创建新的东西。你所做的事情往往可以改善许多人的生活，或者更常见的，只是让你自己的生活变得更容易。

为别人和自己构建工具可能带来难以置信的回报，但是工具也经常被忽略。好的工具对于让开发人员感到高兴和保持团队的高效率运作是至关重要的。构建工具也可以成为帮助你作为工程师不断发展的动力。

SRE的诞生是因为软件工程师触及了运维。因此，你仍然应该在工作中从事软件工程。目标是将50%!的(MISSING)时间用于编写代码，30%!的(MISSING)时间用于与人打交道，20%!的(MISSING)时间用于应对紧急情况。

首要任务是通过编写代码把自己和其他人从重复的工作中解放出来。一位伟大的SRE工程师曾经对我说过：“我会做一次，甚至会做两次，但如果你让我做第三次，我会把它全部烧掉。”我粗略地引用了这句话，她这里指的是对某种无能为力的事故做出的反应，但更重要的一点是，她表明人类是喜怒无常的，不完美的，人不是机器。如果我们不需要人类来完成任务，那么就编写代码，这样人类就不需要参与其中了。

### 寻找项目

如果你打算开始一个新的项目，而不是加入现有的项目，就需要找到一个你认为需要解决的问题。这种灵感可以来自各种地方。我的项目灵感往往来自几个不同的地方。

● 自动化手动完成的任务。这是最经典的SRE工程师的任务之一。通过自动化一些东西，你可以为自己和其他人腾出时间去做其他事情。这是一个很庞大的部分，包括使用代码把任何人工过程或检查表自动化。

● 改进依赖关系以使其更具弹性。分析依赖关系和基础设施的部分，以查找可能的故障是很有价值的，人们对正常的服务会很满意，直到它失败为止。

最后一个想法是：你的目标是使用自动化从而尽可能地解放自己。如果6个月后你还在做一模一样的事情（或类似的事情），你会发现自己变得沮丧和不快乐。你可以通过写软件来消除日常生活中不愉快、无聊和乏味的工作。

### 项目计划

在敏捷中，我们没有提到的两个东西是回顾会和站会。我非常喜欢参与它们。站会是每天举行的会议，团队中的每个人轮流说出他们昨天做了什么，今天将会做什么，以及什么阻碍了他们。这是让人们随时了解项目最新情况并了解是否有任何变化的好方法。即使每个人都在做不同的事情，它让所有人都能统一上下文。站会形式多种多样，可以是聊天、电子邮件，或现场举行，无论什么形式，能达到效果就行。

回顾会是一种持续回顾过去一周、一个月、两周或其他的迭代计划的方法。大家定期开会，分享做的好的与做的不足的地方，以及如何改进。我曾经参与过的一次回顾会是星期五下午4点举行的，当时白板上有3个标题：Yay！Meb！Blargb！每个团队成员都会在标题下贴上便笺来表示他们此刻的心情。这是一个很好的情绪释放和表达心情的方式。

当一个人单独工作时，在代码中引入错误或产生错误的可能性会更高。第二，如果一个人离职，他往往会带走关于这个软件的全部知识。大多数由一个人开发的软件项目都欠缺文档，当负责开发维护的人离职后，软件出现Bug时，团队中的其他人必须要费很大劲儿才能知道它是怎么工作的。这将会花比两个人一起开发这个软件多得多的时间。

解决这一问题的一个方法是让一个人专门负责对这种单人开发的项目进行代码评审。这样，这个项目的每一行代码都由同一个人来评审，两个人可以讨论项目、交流意见。另一个解决方案是让多人参与这个项目。在开发人员之间划分工作，然后让他们协作并评审彼此的代码。要确保工作分配均衡，防治某个人工作任务过重。

你可能会感觉到，人们开始觉得自己工作效率低下，因为总是不能完成所分配的工作。这种低效的感觉，加上身心疲惫的感觉，是长期的工作压力和身体透支的征兆，会对员工的健康产生负面影响，并可能导致他们辞职。

### 构建项目

● 监控：正在编写的代码有基本指标吗？它们正在被收集和存储吗？
● 事故响应：你正在编写关于如何对服务进行运维的文档吗？如果发生事故，有没有报警机制？任何人收到报警都知道该怎么做吗？
● 事后回顾报告：当代码发生故障时，你是否像对待其他发生故障的代码一样编写事后回顾报告呢？
● 测试和发布：是否写了单元测试和集成测试？是否有文档记录发布流程和回滚流程？
● 容量规划：是否记录了容量规划将如何影响系统的性能？

● 使用版本控制：这是计算机编程的必备工作。即使是再小的项目也应该使用版本控制。人类会犯错误，版本控制可以让你轻松地从错误中恢复过来或查看何时引入了错误。
● 始终进行代码评审：作为开发人员，你所知有限，所以让另一双眼睛来阅读你的代码有助于发现Bug并纠正你所做出的假设。你的代码应该至少有一位评审者来帮助你发现其缺陷。

UNIX哲学也是类似的观点。这种哲学有几条原则，但我喜欢关注的两条是程序应该只关注一个目标并尽可能把它做好，以及让程序能够互相协同工作。在

### 文档与维护项目

发布变更日志。变更日志是显示自发布以来变更内容的文档。如果需要经常发布，你可能希望以某种方式使它自动化。

我工作过的许多组织都为每个版本保存内部变更日志，然后产品团队将这些日志转换为更简单的文档，供主管和客户使用。

项目所有者还负责跟踪奇怪的Bug或失败的测试。他们不必完成所有的工作，但是如果测试失败了，或者项目所依赖的库存在安全漏洞，他们应该是第一时间收到警报的人。

### 小结

SRE存在一种风险，就是SRE工程师有可能成为只负责配置管理或只负责事故响应的人员或团队。腾出时间进行软件开发可以帮助你的团队避免这种命运。软件开发在金字塔中的地位很高，作为一个团队，你不应该忘记它的重要性。

### 8 用户体验

平面设计和用户体验的研究侧重于提高用户生产力、用户幸福感和用户参与度。

图2：左边是生物危害标志，右边是国际辐射标志

该公司制定了6个设计标准。
1.视觉震撼：如果被看到，它需要非常引人注目。
2.独特且明确：标志不应该被重复使用。陶氏化学公司给出的例子是Jolly Roger，或称骷髅和交叉骨。虽然它曾经用来代表毒物，但它现在更多与海盗宝藏有关，并不能代表真正的危险。
3.易于回忆和识别：这可以阻止人们使用常见形状或颜色作为说明符号。
4.易于模板化：应该容易创建并可以应用于各种表面上。
5.旋转对称：不论它如何显示，人们都可以知道它是什么。
6.适用于来自不同背景的人：无论你身处何方，无论观众是谁，这都不应该是令人反感的或困惑的。

### ACM道德准则

如果你的软件给人带来精神上的痛苦，或者你允许存在一些让用户伤害自己或他人的功能，那么你可能在编写不道德的软件。

### 9 网络基础

与人之间的沟通非常重要。我们正在走向一个更加“分布式”的世界，这意味着确保服务之间通信的一致性与可靠性变得越来越重要。正如我们将在后面讨论的，网络是非常脆弱的。在本章中，我将向你展示互联网是多么脆弱，其工作原理是多么令人拍案叫绝。本章还将讨论如何探索和调试两个服务之间可能出现的问题。

### 发送一个HTTP请求

让被面试者描述HTTP请求经历的所有步骤。可以从很多不同的角度探索这个问题。曾经有一次我让一个人解释计算机是如何理解键盘按键的。虽然这很吸引人，但是现在我更想从网络的角度来看这个问题。

计算机使用IP地址相互通信，DNS将域名转换为IP地址。

● 如果本地缓存（在机器上或在网络上）有关于natwelch.com">的信息，则直接读取本地缓存。
● 如果本地缓存没有关于natwelch.com的信息，则询问DNS服务器是否有关于该域名的信息。
● 如果DNS服务器也不知道，则询问根服务器（又称点服务器）。

● .com服务器不知道natwelch.com的服务器在哪里，但是它知道名称服务器的信息。这称为NS（Name Servers，名称服务器）记录，它指向域的名称服务器。
● 然后，名称服务器将返回请求的任何记录。

OSI模型将网络描述为以下7层。
● 第1层：物理层
● 第2层：数据链路层
● 第3层：网络层
● 第4层：传输层
● 第5层：会话层
● 第6层：表示层
● 第7层：应用层

第1层是物理连接，第2层包含Wi-Fi、以太网和其他用于控制物理连接的协议。第3层是针对IP地址和路由方式的。第4层是TCP和UDP。第5层和第6层很少被讨论，它们是诸如SSL和其他网络封装的地方。最后，第7层是HTTP和其他用户级消息所在的位置。

网络的物理层和数据链路层通常被概括为“以太网”。从技术上讲，这里承担了很多工作，而最重要的是，每个网络设备都有一个MAC（Media Access Control，媒体访问控制）地址。在现代网络中，MAC只是指定网络连接的一种方式，例如以太网端口、Wi-Fi适配器、蓝牙连接或手机天线。大多数网络设备都带有一个默认的MAC地址，可以根据需要更改它，网络上的每个设备都需要一个唯一的MAC地址。

IP协议是在Internet上路由数据包的协议。在Internet上有3种常见的数据包：TCP、UDP和ICMP。还有其他类型的，你可以发送任意的数据，IP协议会告诉路由器如何路由你的数据包，并对数据包提供一层封装。
数据包是通过网络发送的一组字节。它按字节分组，前几个字节存储的是关于连接的头数据。网络上的每个协议都有额外的连接数据。IP协议从连接数据开始，然后内部是更高的层。第2层包裹第3层，第4层包裹第5层，以此类推。

通过阅读地址解析协议（Address Resolution Protocol，简称ARP）、内部网关协议（Interior Gateway Protocol，简称IGP）和边界网关协议（Border Gateway Protocol，简称BGP），可以理解接收数据包的每个路由器如何向下一站发送数据包并最终把数据包发向目的地。这里不做过多介绍。

因特网控制消息协议（Internet Control Message Protocol，简称ICMP）用于测试IP地址。ICMP经常被现代网络配置阻止，因为它会泄漏许多有关基础设施拓扑结构的信息。也就是说，ICMP通常用于调试。调试时最常用的工具是ping和traceroute，两者都使用ICMP数据包，这些数据包是仅包含IP地址数据和控制消息的小数据包。控制消息告诉负责接收的网络硬件如何处理数据包。硬件也可以发送ICMP数据包，以告诉你无法连接到你试图连接的内容。

cache-control提供了两条信息：public意味着任何人都可以缓存此响应（用户、CDN等）；max-age=2592000则意味着这个响应可以被缓存30天，或者说2，592，000秒。

Content-Length告诉我们会在响应的body中接收219字节的数据。从技术上讲，这代表octet的个数，而不是byte的个数，但在大多数现代系统中，8 bits=1 octet=1 byte。

### 网络监控工具

$ nc -l 8080￼

nc非常强大，强大到超乎我的想象。强烈建议你通过互联网发掘一下关于nc的一些神奇的使用方法，例如使用它来建立网络隧道、扫描网络上的端口、传输文件等。

### Linux基础

在Linux中，真正使文件起作用的是所谓的inode。inode是一种数据结构，它存储与文件有关的所有元数据。其结构体详解如下。
● 两个设备标识符：一个是这个inode所在的文件系统，而另一个只有在这是一个特殊的设备并指向物理硬件标识符时才存在。
● 唯一的文件序列号。
● 文件的访问权限定义。
● 指向inode的硬链接数（如果为0，则意味着文件将被删除）。
● 文件所有者的用户和组标识符。
● 时间戳。
〇 ctime，inode被更改的时间
〇 mtime，文件被修改的时间
〇 atime，文件最后被访问的时间
● 文件大小，单位是字节。

磁盘上的每个文件都有一个inode，要查看文件的inode，可以运行命令stat。stat命令允许读取所有inode。当通过运行ls输出一个目录中的所有文件时，其实是在读取一个inode表，这就是目录的全部内容。每个inode表有两个特殊文件，分别是一点（.）与两点（..）。.代表当前目录的inode，..代表父目录的inode。

这意味着文件拥有者可以读/写，所属组可以读，而其他人则根本无法访问它。

这个八进制位用于可执行的文件，它使文件在执行时获得文件拥有者或所属组的权限，而不是运行它们的用户的权限。如果它等于4，则获得文件拥有者的权限；如果等于2，则获得文件所属组的权限；如果等于6，则同时获得两者的权限。这是有用的，但极其危险。如果一个文件设置了setuid，并且拥有者是root用户，不管是谁执行它，它都会以root用户的权限运行。你还可以把目录的该位设置为1，这样可以防止用户移动或删除该文件中不属于自己的文件，这就是所谓的sticky bit。

内核模块是可以在编译内核或运行时使用modprobe命令添加到内核的模块。该模块类似于Windows的设备驱动程序，可以更改操作系统与物理硬件的交互方式或创建虚拟设备供操作系统使用。

● /var存放运行时文件，包括日志、缓存和其他文件

top包含很多信息，包括正常运行时间、负载均值、用户计数、进程CPU使用率、内存使用率、进程nice值，以及许多其他信息。

前一节提到了负载均值，你可以在top命令返回的顶部，或者直接运行uptime命令看到它。

● 3个负载均值，统计时间分别是1分钟、5分钟、15分钟
这3个负载均值是Linux系统平均负载，它们是给定时间段内的系统平均负载。你还可以在/proc/loadavg中看到这些。

运行的任务只是正常运行的进程，为了简化思维，如果单核CPU上的1分钟负载均值为1.0，我们可以大致假设没有程序在等待CPU资源。如果有双核，则1.0意味着有一个核心闲置了1分钟。你可以通过运行nproc、lscpu或cat/proc/cpuinfo来了解有多少个可用的内核。

所有这些工具，加上在本章前面提到的工具，都很简单。它们只完成一两件事，而且做得足够好。这是UNIX哲学的一部分。由Doug McIlroy（早期贝尔实验室的工程师）于1978年定义的UNIX哲学如下。

● 让每个程序做好一件事。如果要完成一项新工作，请构架一个新程序，而不是基于旧程序添加新功能，使其复杂化。
● 期望每个程序的输出都成为另一个尚未可知的程序的输入。不要将输出与无关信息混淆。避免使用列或二进制输入格式。不要坚持使用交互式输入。

### 云基础

容器由Docker普及，最初是Linux的一部分，基于cgroup和namespace。现在有许多不同的容器系统。容器的一般概念是在一个容器之上运行许多轻量级的操作系统。

它的好处是隔离，并且能够在不同的容器之间共享相同的内核。这意味着容器的创建速度更快，并且每个独立的容器所需的资源比虚拟机少。

容器的一个好处是能够拥有许多相同的服务器，然后使用容器编排框架在所有服务器上调度和组织容器。这样可以方便地自动调整资源大小，并且无须为每个应用程序定制服务器。

如果云提供商不提供LB，你可以使用Nginx或HAProxy构建自己的LB。通常来说，服务商提供的LB比自己运行的Nginx要更可靠。如果确实想构建自己的LB，可以使用DNS在LB的多个实例之间进行负载平衡。这样做的缺点是可能存在缓存记录，但是如果在单个主机上放置多个A记录，它们将以一个半随机的顺序返回。

LB有很多方法可以将流量发送到后端。最常见的是轮询调度，这就像迭代一个数组来决定谁得到下一个请求一样。其他一些常见算法如下所示。
● 最不流行（也称为最少连接），它将流量发送到具有最少活动连接的后端（或使用其他指标确定负载最少的后端）。
● 客户机散列，对处理请求的客户机的某些方面进行散列操作，并以后端数量取模，从而决定请求发向哪个后端。

自动伸缩是基于触发器增加或减少资源副本数的操作。此触发器可以是监控指标、时间事件或其他任何事件。自动缩放服务通常作为虚拟机和容器的附件服务。对于Web服务，通常人们围绕传入数据包速率、CPU使用率或内存消耗来设置自动调整规则。当它们达到某个级别时，将创建一个新的容器或实例。然后启动计时器，直到自动缩放服务再次检查是否应执行另一个缩放操作。

数据库服务通常提供一些数据库的托管版本。它们通常比自己运行数据库贵得多，但提供了诸如自动备份、自动存储管理或自动性能优化和安全审核等工具。

### 内容简介

本书是软件开发人员在面对灾难性的网站服务中断时的生存指南。由于互联网企业正在尽最大的努力维持业务的正常运行，站点可靠性工程（SRE)已经成为非常热门的领域。本书提供了一个学习SRE相关知识的循序渐进的框架，学习这些可以让读者从容应对必须在短时间内恢复的网站宕机事故。