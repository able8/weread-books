## DevOps入门与实践
> DevOps引入指南研究会

### 作者简介

曾在日本索尼公司任架构师，2014年进入Recruit公司，负责全面推进基础设施即代码的部署方式。

主要负责Recruit基础设施的构建和自动化运维工作

大学毕业后进入NS Solutions公司基础设施事业部，负责为构建和运维自动化项目提供支持。对Hadoop和OpenStack等抱有兴趣。

### 前言

日文书名副标题中的基础设施即代码是指将服务器、网络设备等基础设施的设置和架构代码化，把软件开发的开发模式应用到基础设施运维中的方法。基础设施即代码是在DevOps实践中支持开发和运维紧密合作的一个非常有效的方法。

### 1-1 DevOps出现的背景

DevOps不仅是一种工作方式，还涉及团队建设和开发流程的设计等，可以说越想深刻理解DevOps

### 1-1-1 DevOps诞生的背景

我们先来介绍一下DevOps诞生的土壤，大致有以下两点。


●以敏捷开发为代表的持续开发方式的出现
●持续开发带来的运维问题

### 1-1-3 持续开发带来的运维问题

此外，作为信息共享的基本思想，该演讲中还提出为了让开发和运维在同一个地方能看到相同的内容（Dev and Ops see the same thing, in the same place），可以将配置信息代码化，保存到同一个软件管理系统的仓库（第2章）中实现可视化，同时也介绍了分支使用原则（第3章）中从主分支进行发布的方法，以让全员明确所使用的版本。

如上所述，基础设施即代码可以通过将基础设置的配置代码化，从而将基础设施引入软件领域，使软件开发的方法也同样适用于基础设施的构建和配置。为了进行配置变更，我们可以像写代码一样编写配置信息，并像应用程序开发一样使用测试工具来对配置信息进行测试，并将通过测试的配置信息和代码一样进行版本管理。像这样，在基础设施的构建和运维中就可以使用开发部门的敏捷开发等持续开发方法。

2012年迈克尔·德哈恩（Michael DeHaan）发布了使用Python编写的配置管理工具Ansible。它的特点是配置信息采用YAML语言描述

●幂等性：不管执行多少次，都能得到相同的结果

### 1-1-4 DevOps的诞生和历史

用于应对变化的工具
●Automated infrastructure（基础设施自动化）
●Shared version control（版本管理共享）
●One step build and deploy（一步式构建和部署）
●Feature flags（通过配置项来管理应用中的某一功能是有效还是无效）
●Shared metrics（共享指标数据）
●IRC and IM robots（互联网中继聊天、即时通信机器人）



●Avoiding Blame（避免指责）



创造DevOps这一词汇的德布瓦在博客中也提到过自己差一点就放弃了这一理念，因为最开始的时候很多人都表示否定，认为开发和运维合作简直太荒谬了。

### 1-2-3 抽象化

VLAN（Virtual Local Area Network，虚拟局域网）是很早以前就为人所知的一个网络抽象化的方法，诞生于1994年，是一种把一个物理交换机分离成若干逻辑交换机的技术。

SDN（Software Defined Network，软件定义网络）被推上了台面。SDN有几种实现方式，这些实现方式的共同点就是将交换机分成Control Plane（配置等管理功能）和Data Plane（数据包转发功能）两个层面。其中Control Plane是用软件实现的，开发人员可以低成本地掌握软件知识，从而对网络的配置进行修改。防火墙和负载均衡器这种以前只有专业工程师才能接触到的设备也可以通过软件来控制，因此就算不是基础设施工程师，也可以理解这些设备的配置信息，并进行配置变更。

### 1-2-4 自动化

自动化也可以通过组合使用各种开源软件来实现，之后我们将介绍的持续集成就是自动化的一个典型例子。

### 1-2-5 统一管理

软件配置管理工具
信息的统一管理不仅限于沟通。利用软件配置管理工具（Software Configuration Management, SCM），我们可以将用代码、软件方式实现的基础设施的配置信息保存到软件配置管理工具中。通过对变更内容和变更者进行版本管理，开发和运维人员就可以根据相同的信息来变更配置或者对变更结果进行确认。这

### 1-3 组织和DevOps

本书中介绍的配置管理工具Ansible的首席开发者德哈恩就配置管理工具在消除对个人依赖方面所取得的成效做了如下论述。

滚动更新（rolling update）是一种更新升级方式，是指在由多个组件构成的系统中，每次只更新其中的一部分组件，从而在不停止系统的前提下实现整个系统的更新。

但是，配置管理工具的出现解决了这个难题，使团队内的任何人都可以完成这样高难度的工作，也由此消除了对个人的依赖。

开发团队和运维团队的紧密合作，就是要消除上面所说的损耗，形成一种大家一起讨论项目，互相检查，在了解对方工作状况的基础上不断对服务进行改善的关系。支撑开发和运维紧密合作的工具有很多，比如使用版本管理工具或基础设施配置管理工具，可以对开发团队和运维团队所需要的配置信息进行统一管理，实现信息共享，消除专业壁垒，从而有利于人才的流动，从结果来说也有助于组织结构的精简。

那么如何才能解决类似问题呢？如果开发团队和运维团队能共享发布的时机和内容，掌握发布可能影响的范围，一起对服务进行监控，那么就可以在更早的阶段找到问题出现的原因，及早修复bug。

不光是故障，性能也是一样。如果开发团队只考虑应用程序的开发，运维团队只考虑基础设施的运维，双方分别以这种方式来进行开发和基础设施构建的话，就会出现双方预想的连接池数不匹配，性能发挥不出来的情况。

### 2-1 从小的地方开始实践DevOps

第1章我们介绍了DevOps是通过Dev（开发）和Ops（运维）的紧密合作提高商业价值的工作方式和文化。

### 2-2 个人也能够实现DevOps

系统开发和运维的流程大体来说都包含以下几个阶段。


❶计划和需求分析
❷设计和实现
❸测试
❹发布
❺运维

❶使用VirtualBox构建个人开发环境
❷使用Vagrant使基础设施代码化，简化个人开发环境的构建操作
❸使用Ansible使构建和配置信息代码化，从而提高开发环境的构建和配置效率
❹使用Serverspec使基础设施代码化，从而提高构建和配置测试的效率
❺使用Git高效管理前面编写的各种代码



### 2-3-1 使用Vagrant实现本地开发环境的代码化

●提高了环境构建工作的效率
只要将构建方法记录到Vagrantfile中，任何人就都可以通过vagrant up命令轻松构建出相同的环境。
●方便环境共享
通过共享Vagrantfile，可以轻而易举地实现环境信息的共享。
●容易掌握环境
通过Vagrantfile，可以轻松地知道“这台服务器是干什么用的”。
●可以由团队来维护环境
此外，团队的任何成员都可以使用该文件，并且只需要运行vagrant up命令就能够使用环境。



### 2-3-2 使用Ansible将构建工作通用化，并向其他环境展开

前面的那些问题都可以通过Ansible和Chef等基础设施配置管理工具来解决。

声明式侧重于描述希望服务器进入的状态，而不是描述希望服务器如何进行处理。

不管是什么形式的配置管理信息，只要按照声明式的描述方法对各个状态进行抽象描述，就可以使整个配置管理信息变得抽象，从而像Web服务器、DB服务器那样实现服务器状态的抽象化。

另外，无论实际安装软件包时使用的是yum命令还是apt-get命令，都不需要详细设置，全部由工具负责处理。也就是说，开发人员只需要关注状态就可以了。

收敛性
收敛性是指不管对象的状态如何，最终都会变为指定的期望状态。

另外，收敛性和修改之前的配置文件内容没有任何关系，它只保证能实现配置文件中指定的最终结果。
这一点对开发人员来说也大有益处，因为开发人员只看描述内容就可以了解具体的状态。如果是程序化的操作步骤，那么每条命令都会有其依赖的前提条件，而开发人员则需要深刻理解这些前提条件。然而，有时候这些前提条件并没有被明确记录。由此看来，程序化的操作本身也潜藏着一定的危险。

我们把无论执行多少次都能得到相同结果的特性称为幂等性。这个概念结合了前面介绍的声明式和收敛性。幂等性这一性质在基础设施配置管理中有重大意义。在不能保证幂等性的shell脚本中，需要先获取当前的状态，然后通过if语句对各种条件进行严格的定义。

Ansible有如下一些特点。


●构建对象服务器上不需要安装客户端工具
●配置信息语法规则简单
●最少只需要一个命令就可以运行起来（不需要对Ansible进行配置），容易入门



也就是说，不管这之前nginx服务处于什么状态，也不管运行了多少次同样的命令，通过把nginx服务定义为started状态，Ansible就能保证nginx服务处于正在运行状态。

由于记录格式是统一的，所以编写起来也比shell脚本更加流畅。这种方式的优点在于可以通过标准化的格式来描述构建步骤，不需要像shell脚本那样编写很多条件处理语句。

由于通过Ansible的声明式的描述方式描述的状态具备收敛性，所以在编写配置信息时，我们就可以不必在意多余的前提条件，只需理解配置对象的目标状态即可。也就是说，我们看到的并不是配置的过程，而是想要达到的配置结果。

●Dynamic Inventory
可以从外部动态读取Inventory（主机列表）。



●Ansible Galaxy
不必从零开始编写角色，直接从互联网上获取并使用即可。

### 2-3-3 使用Serverspec实现基础设施测试代码化

Ansible使用YAML格式编写构建步骤，和Ansible相同，Serverspec也采用了类似的描述方式，提高了测试文件的可读性，同时也可以由工具来解释代码并进行测试，很好地满足了机器和人类双方的需求。

输出HTML格式的测试结果
Serverspec还提供了将测试结果输出为HTML格式的功能。比如，当我们需要把测试结果分享给他人时，相比把测试命令的输出结果复制下来给对方看，HTML格式的测试报告更容易让人理解。

### 2-3-4 使用Git在团队内共享配置信息

Git的本地仓库分为3个区，分别是工作区（working directory）、暂存区（staging area）和版本库（repository），如图2-16所示。

可以看到新创建的文件README.md在Untracked files列表中。这就表示文件还在工作区中。
git add：将文件从工作区移动到暂存区
接下来，我们试着将这个文件移动到暂存区，这时需要使用git add命令。

输出结果和之前稍有不同，出现了一行Changes to be committed:的内容，这一行表示README.md文件已经被移动到了暂存区。

git commit：将暂存区的内容提交到版本库
接着我们来进行提交操作，提交操作通过git commit命令实现，提交后的状态如图2-21所示。
￼

git diff：对比工作区和暂存区之间的差异


使用--hard选项，工作区的所有修改内容都会被撤销，回退到最新提交的状态。



考虑到这些情况，使用Git取代原始的复制文件夹的方式来进行版本管理明显更加安全可靠。不管是多么简单的代码，如果大家都能做到先执行git init命令创建仓库，然后再一点一点地提交代码来推进开发，那么开发工作就会变得更加安全和高效。

因此在团队中共享代码时，我们希望将修改“合并”起来，以一个合适的粒度进行提交。这里所说的“合并”指的是一个有意义的单位，比如“解决问题编号为××的问题”“添加××功能”，或者“解决××bug”等。这样做的一个好处是，以后我们在查看提交记录时，就能很清楚地了解到在什么时候做了什么样的修改。

如果已经在本地进行了多次提交，可以使用git rebase -i命令对这些小的提交进行合并。如果想将本次要执行的提交和上一次的提交进行合并，则可以使用git commit --amend命令。

### 2-3-5 基础设施即代码和DevOps的目标

答案是No。基础设施即代码思想不过是DevOps的一部分而已，只是我们在2-1节介绍的效率化的一种实现方式，代表不了DevOps的所有目标。
为了提高商业价值，我们一直在追求效率化（主要是以基础设施为对象），但是效率化是没有终点的。因此，分析影响商业价值提高的所有原因，并找到相应的解决方式，这一点非常重要。

正如DevOps的定义所示，其目标在于通过开发和运维的紧密合作来提高商业价值，只有团队成员共同参与合作，才能发挥出更大的效果。

### 3-1 在团队内实施DevOps的意义

沟通的缺失会造成信息不同步，甚至会降低开发、测试以及发布过程中的工作效率。如果不将DevOps的意义清楚地传达给团队的每一个成员，只是武断地采用一些新工具，结果恐怕会离你理想中的DevOps越来越远。要想实现DevOps，就必须注意培养有利于实施DevOps的土壤，否则有可能给开发现场带来混乱，甚至完全背离开发和运维紧密合作的目标。

这里我们的目标并不只局限于减少工作量，还会涉及如何让开发成员和运维成员更容易地了解到彼此都在做些什么、开发进入到了什么样的状态，这样开发人员和运维人员就能共享信息，进而实现紧密合作。

### 3-2-1 使用GitHub进行团队开发

Git使代码管理变得简单，GitHub以代码为中心大大提高了开发的效率，它们都是非常便利的工具和服务。以前，记录表、参数表和操作步骤等文件全都分散地保存在共享文件夹中，我们需要花费很大的精力才能知道哪个是正确的，哪个是最新的。而现在一切以代码为中心，基于代码进行沟通，一切都变得清晰顺畅了。

根据基础设施即代码的思想，不仅是应用程序，包括基础设施在内的所有的一切都可以用代码的形式来表现，进而能够实现以Git为中心进行沟通。开发相关的所有人员都可以基于Git进行对话，由此产生的交流和变更也都可以集中进行管理。

为了避免上面这种弊端的出现，我们需要提早在团队内制订分支策略和开发流程，比如可以规定如下内容。


●在什么时候使用哪个分支
●在什么时候合并到哪个分支
●在不同的环境中分别使用哪个分支
●在修改bug或者添加新功能时使用哪个分支

### 3-2-2 使用Docker进一步提高开发效率

在团队中共享环境时，可以使用Dockerfile或由Dockerfile文件构建的镜像。另外，使用Docker Compose有助于在团队中轻松地共享由多个容器组成的Docker环境。

-td选项是-t和-d两个选项的组合。-t选项用于给容器分配伪终端（Pseudo-TTY）, -d选项用于指定容器以后台模式（detach）运行。

这里，我们没有指定“[要执行的命令]”这部分的内容，这就表示执行镜像中定义的默认命令。

上面的命令几乎瞬间就可以执行完，也就是说，容器在一瞬间就启动了。由此可见，和使用vagrant up命令启动虚拟机相比，容器的启动速度要快得多。

Dockerfile是Docker镜像的设计文档，记载了“这个镜像是谁构建的”“基于什么构建的”等镜像的相关信息，使用docker build命令就能按照这个设计文档构建Docker镜像

docker-compose up -d命令，就可以启动配置文件中指定的容器。这里的-d选项用于指定容器以后台模式运行，如果不使用这个选项，该命令就不会从终端返回，各个容器的日志就会直接输出到终端上。

包括使用d o c k e r-compose scale命令指定某一个服务启动的容器的个数等，这里我们就不一一介绍了。使每个容器都拥有简单的功能，同时使用Docker Compose对这些容器的组合关系进行管理，这样即使是很复杂的开发环境，也很容易共享。

Docker的优点。


●环境构建速度更快
●资源使用效率更高
●开发环境共享更加方便

研究一下Docker for Mac/Windows内部的工作原理就会发现，其实在该工具内部也运行着一个Linux虚拟机，而Docker就运行在这个虚拟机中。

### 3-2-3 使用Jenkins管理工作

下面我们就来介绍一下构建流水线（build pipeline）工具Jenkins，以解决上面提到的问题，同时对如何进一步提高工作效率进行讨论。

1．可以将操作以项目（project）为单位整合到一起运行

2．消除了手工操作，使操作变得更加安全、可靠

．可以将项目的运行记录和结果保存下来
Jenkins可以保存什么人在什么时候运行了项目，以及结果如何等信息，以便之后查看。

### 3-2-4 使用持续集成和持续交付优化发布

持续集成的目的是尽早发现并解决问题，以提高整个开发周期内的工作效率，但实际上持续集成的好处并不仅限于此，这里我们就来系统地总结一下。
1．尽早发现问题，保证系统质量

2．削减工作成本
持续集成会将比较固定的工作流程自动化，比如在修改代码之后自动进行测试。因此，“代码的构建和部署”以及“执行测试”这些原本由开发者完成的工作都会被自动进行，从而可以达成削减工作成本的目的。

### 4-2-1 The Twelve-Factor App

The Twelve-Factor App不仅引入了持续改善的思想，还在基础设施中引入了软件开发的思想，比如基于基础设施即代码思想进行配置变更以及对服务器进行扩缩容等，这样一来，无论创建或销毁服务器，应用程序都可以轻松应对。

还要使进程在接收到SIGTERM信号之后实现优雅停止（grace shutdown）。

### 4-3-1 使用不可变基础设施进行高效管理

不可变基础设施的思想非常简单，就是在基础设施构建完成后就不再进行任何变更。
那么想对基础设施进行变更时要怎么办呢？答案是全部重新构建

而随着虚拟化和云计算等技术的发展，如今我们可以快捷地构建和销毁基础设施，比如可以使用第2章介绍的Ansible等基础设施配置管理工具来实现基础设施构建工作的自动化，这也就使得不可变基础设施成为可能。

以前，准备一台服务器并不容易，因此对待发生故障的服务器就像对待生病的宠物一样竭尽全力地给予救治，而在虚拟化和云计算飞速发展的今天，舍弃原有的基础设施并重新构建一个不再是难事。虽然这一说法稍微有些极端，但“服务器是牲畜”指的正是这种利用完就抛弃的观念。

因此，一般情况下不可变基础设施只针对Web服务器这种无状态的服务器，DB服务器等有状态的服务器则不在讨论范围内。

### 4-3-2 使用蓝绿部署切换服务

❷在用户没有使用的环境中实施发布工作，最后通过将前置（比如负载均衡器等）的连接切换到蓝色环境或绿色环境，从而瞬间完成环境的切换

．切换工作可以瞬间完成
我们在前面也介绍过，最终的切换工作可以瞬间完成，因此能够将发布工作给用户带来的影响控制到最小。

就可以瞬间恢复到原来的版本。总之，确保用户能正常访问服务是最重要的目标，为此只要再次切换蓝色环境和绿色环境即可。切换之后，我们就可以对故障进行深入调查，并实施相应的解决方案。

1．需要保持双重的基础设施

．不适用于有状态服务器
和不可变基础设施一样，蓝绿部署也不适用于有状态服务器。比如随着应用程序的发布，数据库的结构需要修改，而修改前后的数据库结构并不兼容，这时就不能使用蓝绿部署（不过这种类型的发布基本上不会频繁进行）。

如何实现蓝绿部署
那么如何在蓝色环境和绿色环境之间进行切换呢？切换的方法有很多，这里我们来介绍一下。
通过DNS进行切换

通过Cookie进行切换
最后要介绍的是通过Cookie进行切换的方法（图4-7）。访问网站时服务器端会发送Cookie到客户端，然后由浏览器负责将Cookie保存下来。服务器端可以通过Cookie的值控制连接目的地，在下次用户连接时，根据Cookie的值决定将请求转发到哪个环境。

### 4-3-3 本地部署和公有云

本地部署（on-premise）是指公司自己购买或租赁服务器和网络设备，将其放置在自己的数据中心，然后由自己负责维护。这也是基础设施的传统使用场景。

公有云的优点是可以瞬间获得资源。在本地部署的环境下，要想增加一台物理服务器，就需要选择硬件并安装、构建设备和网络，最快也得花上几天，而在公有云的环境下，只需要从既定的方案中选择合适的配置，点击一下按钮或者运行一下命令，用几分钟甚至几秒钟的时间就可以创建一台服务器。

另外，公有云服务在发生故障时极有可能成为一个黑盒。

比较成熟的公有云环境中提供了API、命令行工具以及管理控制台等各种工具，使用这些工具可以非常方便地构建和管理基础设施，这也是公有云难以被替代的一个优势。

不可变基础设施和蓝绿部署并不是实现DevOps必不可少的条件。DevOps的目的是提高商业价值，不管是不可变基础设施还是蓝绿部署，都不过是实现这一目标的一个手段而已。

### 4-3-4 SaaS

SaaS服务被广泛应用的本质在于优先追求商业价值，彻底削减非核心部分的成本。换句话说，就是将人力和系统资源分配到可以提高商业价值的地方，剩下的都以自动化的方式完成，以此降低资源的分配额度。可以说SaaS和DevOps的“通过较少的人快速提供服务，提高商业价值”的方针是一致的。

### 4-3-5 日志收集和分析

日志的种类有很多，包括系统日志、访问日志和错误日志等，但不管是哪种类型的日志，对于分析记录日志时发生的事情来说都是非常重要的。

可以使用以Logstash和Fluentd为代表的能够进行流处理的工具。这些工具可以对需要收集的日志进行监控，并以非常短的时间间隔将日志传输到其他服务器中。

使用Logstash或Fluentd，我们可以在持续收集日志的同时将这些日志传输到其他服务器中，然后在接收到日志的服务器上对日志进行聚合处理或者将其保存为文件。这样一来，实时收集日志的目标就可以轻松实现了。

### 4-4-2 ticket驱动开发

ticket驱动开发有一个规则，就是所有的代码提交都必须包含ticket。这是因为ticket中记录了所有的项目信息，使用ticket将想要实现的内容、实现过程以及代码关联起来进行管理，有助于减少失败次数，促使开发人员自发地对项目进行把控。

### 4-4-3 网站可靠性工程

本节将介绍网站可靠性工程（Site Reliability Engineering, SRE）。SRE是DevOps中运维的实践方法之一，基于Google长期的运维实践经验而提出，备受关注。

第1章我们介绍了DevOps中运维团队的使命不是确保系统平稳运行或进行优化，而是实现商业价值。通过本节的介绍，我们也了解到SRE追求的是网站可靠性，而追求网站可靠性的原因也在于实现商业价值。因此，我们必须认识到DevOps中的运维和SRE在本质上追求的目标是一致的。

容量监控。我们说服务监控是对当前系统状态的监控，那么容量监控则可以认为是对系统未来趋势的监控。服务监控对CPU负载值进行监控，而容量监控则将监控的重点放在了这些指标的变化上，比如通过持续监控CPU负载值，并对剩余量进行判断，就可以预测进入危险区域的时间。此外，如果对服务器或存储等设置了资源池，就可以根据资源池的减少量等信息，在资源耗尽之前预先确保必要的资源。

### 4-4-4 ChatOps

像这样，因为开发部门和运维部门可以在同一场所进行沟通，所以我们就可以通过让所有信息都在聊天工具中流动来实现流畅的软件工程。

在ChatOps中，我们只需要在聊天工具中输入一条指令，就可以完成想要完成的工作或者筛选出所需要的信息

操作过程以及结果对所有人可见
聊天工具是团队所有成员一起使用的，因此在聊天工具上显示执行的指令或执行结果时，其他团队成员也会看到，这就相当于告知他人自己做了什么样的操作并得到了什么样的结果。

Slack（图4-16）是一个以SaaS形式提供的聊天工具，不仅提供了聊天功能，还可以集成各种第三方应用程序。

### 4-5-1 故障处理．

DevOps中开发人员和运维人员是作为一个整体进行工作的，因此DevOps在故障处理方面会发挥出非常显著的效果

在DevOps中，开发人员和运维人员彼此了解对方的工作内容，共享各种信息，朝着同一个目标前进。某一部分是由谁依据什么思想设计的、本次发布在哪些地方做出了修改、下一次营销活动是什么，等等，这些信息都会在双方之间共享。通过利用DevOps的各种工具和方法来灵活地共享信息，在发生故障时就可以快速找到原因了。

### 4-5-2 实现持续集成和持续交付

是因为在发生故障时，负责处理的是运维人员。但是，运维人员其实根本不清楚发布和变更的内容

如果是DevOps团队，情况就完全不同了。应用程序和基础设施的发布计划和内容会准确地传达给运维人员，这样一来，运维人员就能掌握应用程序和基础设施在什么样的契机下发生了什么变化，又产生了什么样的结果，等等

从运维人员的角度来看，以前每次发布时都不知道发布了什么，而自己还要对这些发布进行维护，可以想象工作十分不易。但在DevOps的情况下，运维人员则可以准确把握发布的具体时间和修改内容等，由此也构建出了一个更加容易实施运维的环境。只有确保了运维的可靠性，持续集成和持续交付才有意义，才能实现快速提高商业价值这一最终目标。

### 4-5-4 建立开发和运维之间的合作体制

DevOps需要的是开发部门和运维部门之间互相理解和互相合作，从而朝着共同的目标前进。如果双方能够互相理解，共享彼此的信息并互相协作，那么即使分工不同，也能够快速解决故障，更快速地实现最终目标。

### 5-1-1 持续集成和持续交付的组成要素和集成

2．实现ChatOps
所有操作和处理都会通知到Slack，我们可以通过聊天工具来确认部署或测试处于什么状态

### 5-1-2 集成GitHub和Slack：将GitHub的事件通知给Slack

GitHub和Slack都已经具备和对方进行集成的相关配置，可以非常简单地实现集成，具体的操作步骤如下所示。



### 5-1-3 集成GitHub和Jenkins:git push之后的自动化处理

通过Git插件，在将代码推送到GitHub后，就可以触发Jenkins上指定的项目（处理），比如测试和部署等，从而实现持续集成。

### 5-1-8 使用持续集成和持续交付，将开发、构建和测试组合到一起

以GitHub为起点，在发生代码变更时，GitHub向Slack发送通知，与此同时Jenkins自动对服务器进行构建并测试

### 5-1-9 如何实现更实用的架构

比如构建的信息发送到构建用的频道，发生故障时的信息发送到故障用的频道，等等。但是也不要划分得太细，如果为了找到想要的信息而需要在不同频道之间来回切换，就会难以追踪关联信息。

### 5-2 实践ELK技术栈

ELK技术栈（Elasticsearch、Logstash和Kibana）。本节我们将接着5-1节的内容，来构建日志分析和可视化的架构。使用该架构，可以搭建起实时对Web服务器的访问日志进行可视化和分析的平台，据此就可以快速确认现在有哪些访问、这些访问又具有什么样的倾向等。比如我们可以基于日志平台，调查新广告在发布之后取得了多大反响，或者服务器端应用程序在发布之后带来了什么影响。

### 5-2-1 ELK技术栈的构成要素和集成

●Logstash
Logstash可以一边读取Web服务器（本节中指Web1和Web2服务器）的访问日志，一边将这些访问日志发送到Elasticsearch。


●Elasticsearch
Elasticsearch存储来自Logstash的日志信息，同时还会处理Kibana的访问请求，并返回可视化所需的信息。
●Kibana
Kibana是开发人员和运维人员对日志信息进行分析、可视化的页面，从多个维度对信息进行可视化。

### 5-2-4 可视化让我们距离DevOps更近一步

前面我们介绍了使用ELK技术栈可以方便、实时地对数据进行可视化。虽然本次示例中仅使用了Web服务器的访问日志，但实际上我们也可以使用Logstash采集服务器的syslog、CPU使用率和内存使用量等系统指标，通过Kibana将它们放在同一个时间轴上实现可视化。这样一来，我们就可以通过同一个平台来掌握系统整体的“状态”了。

通过可视化，开发人员和运维人员可以获得相同的信息，进而可以互相理解对方所做的工作，确认共同的目标，然后朝着相同的方向前进。这正是DevOps所体现的世界观。可视化让我们距离DevOps又近了一步。

### 5-3-1 实现不可变基础设施所需要的要素以及发布流程

❷在绿色环境（非活跃环境）中构建基础设施（※）
1．创建服务器，安装中间件和应用程序（※）
2．进行测试，在发布之前确认这些中间件和应用程序是否能正常使用

### 5-3-5 更具实用性的架构

1．无法确认当前是蓝色环境还是绿色环境
该架构的前提是操作人员能够清楚地掌握哪个是蓝色环境，哪个是绿色环境。如果错误地对正在工作的环境实施了操作，就会直接对服务造成影响，导致惨剧发生。就目前来说，该架构并没有防止操作失误的机制。

3．不适用于有状态服务器
这也是不可变基础设施自身的一种局限性。像本节介绍的这种简单示例，通常情况下只适用于无状态服务器

### 6-2-2 在既有组织中实施DevOps

要想通过自下而上的方式对组织进行变革，从而引入DevOps的方法，个人就需要阶段性地推动团队成员朝着DevOps前进。正如前面介绍的那样，首先需要自己使用DevOps的工具，改变个人开发环境，再逐渐向其他成员普及。然后，逐步改变团队的规则，改变团队之间的沟通方式，重新审视团队的角色分配，一点点地对体制进行改变并进行反馈，从而分阶段地实施DevOps。

### 6-2-3 实施DevOps的反模式

实施DevOps的方法是为了提高商业速度，构建精简的运维体制，创造出更好的服务，你当前打算使用的各种方法和这一目的一致吗？

DevOps的本质就在于互相理解和学习，消除不必要的沟通，从而提高效率

在发生故障时，需要开发和运维进行回顾。这一做法并不局限于DevOps，在解决故障时都需要对问题点进行回顾，找出问题出在哪里，并讨论如何去解决。DevOps需要通过不断改善才能实现，我们不能基于短期的成功或失败来对其进行评判。

### 6-2-4 在组织形式方面是否有实施DevOps的最佳实践

Dedicated是“专属”的意思。据该文章介绍，专门的DevOps团队中聚集了专业的工程师，这些工程师具备本书介绍的各种工具和方法的相关知识。这种类型的团队从最开始就是以专家为中心组建的，他们所做的工作包括编写基础设施代码、实现持续集成、进行版本控制等。

这种跨职能的团队可以降低各流程之间的沟通成本和认识偏差，有利于各个领域的知识共享，能够让实践取得更为显著的效果。由于跨职能团队超越了开发和运维的框架，因此在瞬息万变的商业环境中可以算作万能的解决方案。

通过引入DevOps，对运维人员来说就减少了为开发人员解决问题的麻烦，对开发人员来说也减轻了向运维人员请求协助的负担，还增加了选择的余地，提高系统开发和运维的效率。

这一体制中，开发和运维团队各自的专家都可以向这个小型的DevOps专用团队进行咨询，由这个DevOps专用团队集中精力实现基础设施代码化的配置管理、自动化部署以及持续集成环境的构建和监控等。

### 6-3 团队整体的DevOps

不仅是开发和运维人员，如果和服务相关的所有人员都能够相互协作追求更好的产品，就可以进一步加快商业速度，提高开发和运维的效率，从而为用户提供高质量的产品或服务。