## 大规模组织DevOps实践
> 陈能技 付勇编著

### 内容简介

DevOps是开发运维一体化的软件工程思想，DevOps尝试打破部门墙，构建一个协同的IT建设运行环境，通过工具链形成数据关联的规范化、规模化的软件持续交付流水线，从而助力企业业务的敏捷发展。

本书适合IT主管、项目经理、开发、测试、配置管理、运维等IT从业人员阅读。

### 作者简介

目前专注于大规模组织DevOps工程实践方面的研究，在代码版本管理策略、持续集成、自动化部署等领域有着深刻理解和实践经验，同时研究酌专业领域还包括自动化测试、服务虚拟化、自动化监控等。

### 推荐序

未来的企业都是软件企业，是面向互联网、物联网、大数据和人工智能的企业，软件作为信息系统的核心部分一直面临着专业化交付的问题，如何才能像工厂生产零部件和整机一样可以流水线作业、批量化生产和交付，是IT从业人员一直追求的目标。

直到最近我们看到DevOps所倡导的开发、测试、运维一体化协同，以及自动化流水线的构建，结合新兴的技术（如微服务、容器等），我们认为这是非常有希望解决规模化组织下的专业化交付问题的。

### 第2章 DevOps思想

近年来流行的 DevOps 软件工程模式，强调生产软件过程中的几个角色（如开发、测试、运维）之间的协作，强调软件生产过程中通过自动化的工具链组成软件加工的流水线，例如自动拉取开发代码版本进行编译构建、测试、部署等。目前看来，DevOps软件工程模式是最接近软件工厂的生产流水线模式。

2013年，dotCloud公司（后更名为Docker）推出Docker项目，在容器技术的基础上引入分层式容器镜像模型、全局及本地容器注册表、精简化REST。

2015年，基于Cloud-Native（云原生）概念的逐步成熟，Google联合其他20家公司宣布成立了开源组织CloudNative Computing Foundation（CNCF）。

了Docker，软件的开发、测试、打包部署过程得以标准化；有了云技术的发展，IaaS层技术帮助软件工厂解决生产要素中的资源供给问题；PaaS层技术的发展帮助软件工厂的劳动者们更加敏捷地组装软件系统并交付使用、持续运维。

尽量采用自动化的手段解决软件生产过程中的工作，如自动部署。“所有部署相关的作业都应该实现自动化”

而实现部署的自动化和简易化，就能够频繁地实施部署，对故障规模进行控制就成为可能。
2.能尽快地获得用户的反馈
部署得越早就能获得越多的用户反馈，尽快让用户体验新开发的功能，并将用户的反馈反映到下一个阶段的开发中。若能形成这样的良性循环，就能确立市场的优势地位。通过频繁地进行部署来回收开发的投资，才可能产生收益。

Docker技术在测试领域的应用，可以体现在以下方面。
（1）快速搭建兼容性测试环境。从

（2）快速搭建复杂分布式测试环境。

（3）持续集成。Docker可以快速创建和撤销容器，在持续集成的环境中，可以频繁和快速地进行部署和验证工作。

### 第3章 DevOps体系的建立

1.滚动部署
滚动部署是指通过逐个替换应用的所有实例，来缓慢发布应用的一个新版本。通常过程如下：在负载调度后有一个版本A的应用实例池，一个版本B的实例部署成功，可以响应请求时，该实例被加入池中。然后版本A的一个实例从池中删除并下线。

2.蓝绿部署
蓝绿部署策略与滚动部署不同，版本B（绿）同等数量地被并排部署在版本A（蓝）旁边。当新版本满足上线条件的测试后，流量在负载均衡层从版本A切换到版本B。
优点：
□ 实时发布、回滚。
□ 避免版本冲突问题，整个应用状态统一进行一次切换。
缺点：
□ 比较昂贵，因为需要双倍的资源。
□ 在释放版本到生产环境之前，整个平台的主流程测试必须执行。
□ 处理有状态的应用很棘手。

金丝雀部署是指逐渐将生产环境流量从版本A切换到版本B。通常流量是按比例分配的，例如90%!的(MISSING)请求流向版本A,10%!的(MISSING)请求流向版本B。
金丝雀的部署方式源自矿井行业的一种做法：金丝雀对瓦斯极敏感，矿井工人携带金丝雀可以及时发现危险。
这个技术大多用于缺少足够测试，或者缺少可靠测试，或者对新版本的稳定性缺乏信心的情况下。

影子部署是指在版本A旁边发布版本B，将版本A进来的请求同时分发到版本B，同时对生产环境流量无影响。这是测试新特征在生产环境流量负载上表现是否良好的一种方式。当满足上线要求后，则触发发布新应用。

SRE（Site Reliability Engineer）起源于Google的7人生产运维小组，SRE是可参考借鉴并纳入DevOps体系内的一项敏捷运维实践。

SRE把运维工作分为应急响应、日常运维、工程研发三大类，其中工具平台会投入更多的精力去构建，从而减轻人工日常运维的压力，提高运维自动化水平。
对于SRE而言，自动化是一种力量倍增器，但不是万能药。对力量的倍增并不能改变力量用在哪的准确性。草率地进行自动化可能在解决某个问题的同时产生其他问题。

### 第8章 容器技术

Docker 镜像（Image）就相当于一个文件系统。

镜像是静态的定义，容器是镜像运行时的实体。容器可以被创建、启动、停止、删除、暂停等。容器的实质是进程，但与直接在宿主执行的进程不同，容器进程运行于属于自己的独立命名空间。因此容器可以拥有自己的root文件系统、自己的网络配置、自己的进程空间，甚至自己的用户ID空间。容器内的进程运行在一个隔离的环境里，就好像是在一个独立于宿主的系统下操作一样。

按照Docker最佳实践的要求，容器不应该向其存储层内写入任何数据，容器存储层要保持无状态化。所有的文件写入操作都应该使用数据卷（Volume），或者绑定宿主目录，在这些位置的读写会跳过容器存储层，直接对宿主（或网络存储）发生读写，其性能和稳定性更高。
数据卷的生存周期独立于容器，容器消亡数据卷不会消亡。因此，使用数据卷后，容器可以随意删除、重新run，数据却不会丢失。

指定启动容器时执行的命令，每个Dockerfile只能有一条CMD命令。如果指定了多条 CMD 命令，只有最后一条命令会被执行。如果用户在启动容器时指定了要运行的命令，则会覆盖CMD指定的命令。

VOLUME["/data"]
创建一个可以从本地或其他容器挂载的挂载点，一般用来存放数据库和需要保持的数据等。

指定运行容器时的用户名或 UID，后续的 RUN 指令也会使用指定用户。当服务不需要管理员权限时，可以通过该命令指定运行用户，并且可以在之前创建所需要的用户，如RUN groupadd-r postgres && useradd-r-g postgres postgres。

Dockerfile的使用建议如下。
□ 通过Dockerfile构建的镜像应当尽可能精简。
□ 尽量不安装非必要的软件包。
□ 一个容器只运行一个单独的实例，将具有耦合度的应用分别安装到不同的容器里面。
□ 慎重引入新的数据层。
□ 将准备安装的软件包按安装的字母顺序排列，这样可以避免重复安装软件包的情况，也有助于进行软件更新。通过添加“\”分隔命令，增加代码的可读性。
□ 尽量选择官方提供的镜像版本作为基础镜像，减小镜像的体积。
□ 将多条RUN命令使用“/”连接起来，这样更易于理解，可以方便维护。
□ 为镜像定义一个比较通用的端口，比如提供HTTP Web服务的镜像最好暴露80端口。
□ 通过–t标记来构建镜像，有助于用户管理每个创建的镜像。

□ 使用指令组合，比如apt-get update应该和apt-get install通过“&&”结合。

容器化主要解决应用在云基础架构上灵活地更新和扩展问题，应用能够容器化上云的部分前提是架构能够支持扩展。应用扩展能力的标志是软件和底层硬件的绑定程度。

不要在应用中写死服务的IP和端口（如数据库IP和端口、服务器接口IP和端口），应该采用域名的方式。环境变量应该以传参的形式传入容器，而不是直接写死在容器中，需要的环境变量可写入系统集成文档中。

Docker容器默认以root运行，随着Docker的成熟，越来越多的安全默认选项变得可用。请求root是危险的，可能无法在所有环境中可用。所以镜像应该使用USER命令来指定容器以一个非root用户来运行。

建议服务间接口调用通过TCP和HTTP进行交互，这样可使用负载均衡器进行有效负载。