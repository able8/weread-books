## 从实践中学习TCP-IP协议
> 大学霸IT达人

### 前言

TCP/IP协议族不仅规范了数据的传输方式，还规定了网络组成方式和运作机制。例如，ARP协议规范了IP和MAC地址的转化方式；DHCP协议规范了主机如何获取IP地址。只有掌握这类协议，才能完整地理解互联网数据传输机制。本书详细地讲解了这类协议，如ARP、DHCP、DNS和ICMP协议。

### 1.1 网络组成

网卡也被称为网络适配器（Network Adapter），是连接计算机和传输介质的接口。网卡主要用来将计算机数据转换为能够通过传输介质传输的信号。

常见的网络电缆有双绞线、光纤、电话线等。

光纤的主要作用是把要传送的数据由电信号转换为光信号进行通信。在光纤的两端分别装有“光猫”进行信号转换。

交换机（Switch）可以将多个网络设备连接起来组成一个局域网。它是一种用于电（光）信号转发的网络设备，用来进行数据交换

路由器（Router）又称网关设备（Gateway），用于连接多个逻辑上分开的网络。所谓逻辑网络是代表一个单独的网络或者一个子网。当数据从一个子网传输到另一个子网中时，可通过路由器的路由功能来完成。它会根据信道的情况自动选择和设定路由，以最佳路径，按前后顺序发送信号。路由器也是用来进行数据转换的。路由器与交换机很容易区分，最大的区别是，路由器上有WAN口和LAN接口，而交换机没有这些接口。

在网络中，网络设备、传输介质、网卡又各有不同，数据在传输过程中也会使用不同的规则进行传输，而这些规则是依靠网络协议完成的。

网络协议为计算机网络中进行数据交换而建立的规则、标准或约定的集合。它规定了通信时信息必须采用的格式和这些格式所代表的意义。网络中存在着许多协议，接收方和发送方使用的协议必须一致，否则一方将无法识别另一方发出的信息。网络协议使网络上各种设备能够相互交换信息。

·网络层：将数据传输到目标地址，主要负责寻找地址和路由选择，网络层还可以实现拥塞控制、网际互联等功能。
·数据链路层：负责物理层面上互连的节点间的通信传输。例如，一个以太网相连的两个节点之间的通信。该层的作用包括：物理地址寻址、数据的成帧、流量控制、数据的检错和重发等。

### 1.3 学习辅助工具——网络工具集netwox

netwox是由lauconstantin开发的一款网络工具集，适用群体为网络管理员和网络黑客。它可以创造任意的TCP、UDP和IP数据报文，以实现网络欺骗。它可以在命令模式下使用，也可以在GUI中使用netwag调用。

### 2.1 网络访问层的构成

该计算机中存在两类网络适配器，分别为Lo和Eth。其中，Lo表示回环接口，它是虚拟网络适配器；Eth为以太网网络适配器。如果同类型设备有多个，会在后面添加数字编号。编号从0开始，表示该类型的网络接口的第一个设备。

### 2.2 网络体系

·点到点协议（PPP）：使用Modem通过电话线进行连接的技术，如通过拨号方式建立的网络连接。

### 2.3 物理地址

由于网络设备对物理地址的处理能力有限，物理地址只在当前局域网内有效。

因此，MAC地址拥有自己的格式。它采用十六进制数表示，共6个字节（48位），长度为48bit。整个地址可以分为前24位和后24位，代表不同的含义。

### 2.4 以太网

以太网结构主要分为总线型和星型两种。
·总线型：是指所有计算机通过一条同轴电缆进行连接。
·星型：是指所有计算机都连接到一个中央网络设备上（如交换机）。

交换机为了方便数据传输，通常会存储每个端口所对应的MAC地址，形成一张表。当交换机收到计算机发来的以太帧时，就会查看帧中的源MAC地址，并查找存储的表。如果表中存在该MAC地址，就直接转发数据。如果没有，则将该MAC地址存入该表中。

当其他计算机向这个MAC地址发送数据时，可以快速决定向哪个端口发送数据。由于该表不可能是无穷大的，所以当达到一定数量时，将不会储存其他新的MAC地址。再有新的主机发来数据帧时，部分交换机将不再查找对应的端口，而是以广播的形式转发给所有的端口。这样，就使其他主机可以接收到该数据帧了。

netwox工具提供编号为75的模块，用来实现以太帧洪水攻击功能。它可以伪造大量的以太网数据包，填满交换机的存储表，使交换机失去正确的转发功能。

### 3.1 IP地址

因为MAC地址不能跨路由接口运行；即使强行实现跨越，使用MAC地址传输数据也是非常麻烦的。这是由于内置在网卡里的固定MAC地址不能在地址空间上引入逻辑结构，使其无法具备真正的地址来表示国家、省、市、区、街道、路、号这类层次。

为了便于寻址，了解目标主机的位置，每个IP地址包括两个标识码（ID），即网络ID和主机ID。

·网络ID：用于识别主机所在的网络，网络ID的位数直接决定了可以分配的网络数量。
·主机ID：用于识别该网络中的主机，主机ID的位数则决定了网络中最大的主机数量。

·A类：IP地址范围为0.0.0.0～127.255.255.255。
·B类：IP地址范围为128.0.0.0～191.255.255.255。

无类域间路由（Classless Inter-Domain Routing, CIDR）可以将路由集中起来，在路由表中更灵活地定义地址。它不区分A类、B类、C类地址，而是使用CIDR前缀的值指定地址中作为网络ID的位数。这个前缀可以位于地址空间的任何位置，让管理者能够以更灵活的方式定义子网，以简便的形式指定地址中网络ID部分和主机ID部分。

例如，205.123.196.183/25中的25表示地址中25位用于网络ID，相应的掩码为255.255.255.128。

### 3.2 IP协议

在一个路由式网络中，源地址主机向目标地址主机发送数据时，IP协议是如何将数据成功发送到目标主机上的呢？由于网络分同网段和不同网段两种情况，

如果源地址主机和目标地址主机在同一网段，目标IP地址被ARP协议解析为MAC地址，然后根据MAC地址，源主机直接把数据包发给目标主机。

（1）网关（一般为路由器）的IP地址被ARP协议解析为MAC地址。根据该MAC地址，源主机将数据包发送到网关。
（2）网关根据数据包中的网段ID寻找目标网络。如果找到，将数据包发送到目标网段；如果没找到，重复步骤（1）将数据包发送到上一级网关。

（3）数据包经过网关被发送到正确的网段中。目标IP地址被ARP协议解析为MAC地址。根据该MAC地址，数据包被发送给目标地址的主机。

IP数据报文由首部和数据两部分组成。首部的前一部分是固定长度，共20字节，是所有IP数据报必须具有的。在首部的固定部分的后面是一些可选字段，其长度是可变的。

IP报头中包含大量的信息，如源IP地址、目的IP地址、数据报长度、IP版本号等。每个信息都被称为一个字段。IP数据报头字段如图3.2所示。

### 3.3 构造IP数据包

IP协议在传输数据包时，经常会进行分片传输。例如，当一个设备准备传输一个IP数据包时，它将首先获取这个数据包的大小，然后获取发送数据包所使用的网络接口的最大传输单元值（MTU）。如果数据包的大小大于MTU，则该数据包将被分片。将一个数据包分片包括下面几步：

### 第4章 ARP协议

地址解析协议（Address Resolution Protocol, ARP）是根据IP地址获取物理地址的一个TCP/IP协议。它通过IP地址向MAC地址的转换，解决网际层和网络访问层的衔接问题

### 4.1 ARP协议概述

由于IP地址和MAC地址定位方式不同，ARP协议成为数据传输的必备协议。主机发送信息前，必须通过ARP协议获取目标IP地址对应的MAC地址，才能正确地发送数据包。本

在网络访问层中，同一局域网中的一台主机要和另一台主机进行通信，需要通过MAC地址进行定位，然后才能进行数据包的发送。而在网络层和传输层中，计算机之间是通过IP地址定位目标主机，对应的数据报文只包含目标主机的IP地址，而没有MAC地址。因此，在发送之前需要根据IP地址获取MAC地址，然后才能将数据包发送到正确的目标主机，而这个获取过程是通过ARP协议完成的。

ARP工作流程分为两个阶段，一个是ARP请求过程，另一个是ARP响应过程。

主机A的IP地址为192.168.1.1，主机B的IP地址为192.168.1.2。主机A与主机B进行通信，需要获取其MAC地址，基本流程如下：
（1）主机A以广播形式向网络中所有主机发送ARP请求，请求包中包含了目标IP地址192.168.1.2。
（2）主机B接收到请求，发现自己就是主机A要找的主机，返回响应。响应包中包含自己的MAC地址。

为了避免重复发送ARP请求，每台主机都有一个ARP高速缓存。当主机得到ARP响应后，将目标主机的IP地址和物理地址存入本机ARP缓存中，并保留一定时间。只要在这个时间范围内，下次请求MAC地址时，直接查询ARP缓存，而无须再发送ARP请求，从而节约了网络资源。

（3）本地网络上的每台主机都接收到ARP请求，并且检查是否与自己的IP地址匹配。如果主机发现请求的IP地址与自己的IP地址不匹配，它将丢弃ARP请求。主机B确定ARP请求中的IP地址与自己的IP地址匹配，则将主机A的IP地址和MAC地址映射添加到本地ARP缓存中。


### 4.2 ARP协议包结构

·操作类型：用来表示这个报文的类型，ARP请求为1, ARP响应为2, RARP请求为3, RARP响应为4。


·可用于检测IP地址冲突。当一台主机发送了免费ARP请求报文后，如果收到了ARP响应报文，则说明网络内已经存在使用该IP地址的主机。
·可用于更新其他主机的ARP缓存表。如果该主机更换了网卡，而其他主机的ARP缓存表仍然保留着原来的MAC地址。这时，可以发送免费的ARP数据包。其他主机收到该数据包后，将更新ARP缓存表，将原来的MAC地址替换为新的MAC地址。


ARP协议是根据目标主机的IP地址获取对应的MAC地址。如果目标主机存在，将返回MAC地址。利用这一点，用户可以基于ARP协议对目标主机进行扫描，来判断目标主机是否启用。

可以模拟计算机定期发送ARP数据包，从而更新其他主机的ARP缓存表。在ARP攻击中，该功能可以达到欺骗的目的，使受害者将数据包发送到错误的MAC地址主机（攻击主机），从而导致数据包被监听

### 第5章 ICMP协议

控制报文协议（Internet Control Message Protocol, ICMP）是TCP/IP协议族的一个子协议。ICMP协议用于在IP主机和路由器之间传递控制消息，描述网络是否通畅、主机是否可达、路由器是否可用等网络状态。

### 5.2 IMCP协议应用——探测主机

ping命令就是借助ICMP传输协议，发出要求回应的Echo (ping) request消息。若远端主机的网络功能没有问题，就会回应Echo (ping) reply信息，因而得知该主机运作正常。因此用户可以通过ping命令来判断目标主机是否启用。

traceroute命令用来检测发出数据包的主机到目标主机之间所经过的网关。它通过设置探测包的TTL（存活时间）值，跟踪数据包到达目标主机所经过的网关，并监听来自网关ICMP的应答。

上述输出信息显示了跟踪到的路由地址信息。记录从序号1开始，每个记录就是一跳，而每一跳表示经过的一个网关。记录给出了每个网关对应的IP地址。例如，经过的第2个网关的IP地址为192.168.0.1。其中，为***的记录表示可能被防火墙拦截的ICMP的返回信息。

### 第6章 传输层和TCP协议

传输层提供端到端的交换数据机制，它不仅对会话层、表示层和应用层这高三层提供可靠的传输服务，还对网络层提供可靠的目的地站点信息。

### 6.1 基础知识

网际层提供了主机之间的逻辑通道，即通过寻址的方式，把数据包从一个主机发到另一个主机上。如果一个主机有多个进程同时在使用网络连接，那么数据包到达主机之后，如何区分它属于哪个进程呢？为了区分数据包所属的进程，就需要使用到传输层。

·为网络应用程序提供接口。
·为端到端连接提供流量控制、差错控制、服务质量等管理服务。
·提供多路复用、多路分解机制。

面向连接就是通信双方在通信时，要事先建立一条通信线路，然后进行通信。其过程分为三个阶段。第一阶段是建立连接。第二阶段是连接成功建立之后，进行数据传输。第三阶段是在数据传输完毕后，释放连接。

为了区分同一个主机上不同应用程序的数据包，传输层提供了端口和套接字概念。

在数据链路层中，通过MAC地址来寻找局域网中的主机；在网际层中，通过IP地址来寻找网络中互连的主机或路由器。在传输层中，需要通过端口进行寻址，来识别同一计算机中同时通信的不同应用程序。

套接字是由主机的IP地址加上主机上的端口号组成的地址。例如，套接字地址101.102.103.104:21，表示指向IP地址为101.102.103.104的计算机的21端口。

在网络上主机与主机之间的通信实质上是主机上运行的应用进程之间的通信。在进行通信时，往往同时运行多个应用程序。为了能够让一个计算机同时支持多个网络程序，并且同时保持与多台计算机进行连接，就需要使用多路复用和多路分解，其含义如下：

### 6.2 TCP协议

传输控制协议（Transmission Control Protocol, TCP）是一种面向连接的、可靠的、基于字节流的传输层通信协议。在TCP协议中，通过三次握手建立连接。通信结束后，还需要断开连接。如果在发送数据包时，没有正确被发送到目的地时，将会重新发送数据包。本节将详细讲解TCP协议的工作机制。

·面向流的处理：TCP以流的方式处理数据。换句话说，TCP可以一个字节一个字节地接收数据，而不是一次接收一个预订格式的数据块。TCP把接收到的数据组成长度不等的段，再传递到网际层。

重新排序：如果数据以错误的顺序到达目的地，TCP模块能够对数据重新排序，来恢复原始数据。
·流量控制：TCP能够确保数据传输不会超过目的计算机接收数据的能力。
·优先级与安全：为TCP连接设置可选的优先级和安全级别。
·适当的关闭：以确保所有的数据被发送或接收以后，再进行关闭连接。

客户端要与服务器端进行通信，服务器端必须开启监听的端口，客户端才能通过端口连接到服务器，然后进行通信

·RST：表示是否重置连接。如果RST=1，说明TCP连接出现了严重错误（如主机崩溃），必须释放连接，然后再重新建立连接。

### 6.3 TCP建立连接

第1次握手建立连接时，客户端向服务器发送SYN报文（SEQ=x, SYN=1），并进入SYN_SENT状态，等待服务器确认，如图6.5所示。

第2次握手实际上是分两部分来完成的，即SYN+ACK（请求和确认）报文。
·服务器收到了客户端的请求，向客户端回复一个确认信息（ACK=x+1）。
·服务器再向客户端发送一个SYN包（SEQ=y）建立连接的请求，此时服务器进入SYN_RECV状态，如图6.6所示。

第3次握手，是客户端收到服务器的回复（SYN+ACK报文）。此时，客户端也要向服务器发送确认包（ACK）。此包发送完毕客户端和服务器进入ESTABLISHED状态，完成3次握手，如图6.7所示。

提示：SEQ表示请求序列号，ACK表示确认序列号，SYN和ACK为标志位

客户端与服务器之间的通信是一个数据传输过程。通信的消息将以数据包形式进行传输。为了更有效地进行通信，TCP协议在数据进行数据传输时，使用滑动窗口机制来同时发送多个数据包。当数据包丢失时，TCP协议利用数据重发功能重新发送数据包。因接收端接收数据包的能力不同，TCP流控制会根据接收端的能力发送适当数量的数据包。

这个最大字节数被称为最大消息长度（Maximum Segment Size, MSS）。当要发送的数据超过该值，就需要将数据分为多个包，依次发送。该操作被称为数据分片。

MSS是TCP数据包每次能够传输的最大数据量。通常，最大值为1460字节。如果发送的数据包大小大于MSS值，数据包将会被分片传输

·如果窗口过大，发送端发送大量的数据包，而接收端处理不了这么多的数据包，这样，就会堵塞链路。如果丢弃这些本应该接收的数据包，又会触发重发机制

### 6.5 TCP断开连接

客户端向服务器端发送断开TCP连接请求的[FIN, ACK]报文，在报文中随机生成一个序列号SEQ=x，表示要断开TCP连接

TCP端口扫描也是构造的是TCP连接中的第1次握手包[SYN]包。如果端口开放，将返回第二次握手包[SYN, ACK]；如果端口未开放，将返回[RST, ACK]包。

当目标主机禁止ping时，就无法通过ICMP请求包进行路由跟踪。这时可以借助TCP协议实施跟踪。

TCP协议通过滑动窗口方式，可以充分利用网络性能传输数据。所以，利用TCP传输机制，可以检测网络性能。

### 7.1 UDP协议作用

而UDP协议正好避免了这些过程，它是一种没有复杂控制，提供面向无连接的通信服务协议。UDP协议具备以下特点：
·没有各种连接：在传输数据前不需要建立连接，也避免了后续的断开连接。
·不重新排序：对到达顺序混乱的数据包不进行重新排序。
·没有确认：发送数据包无须等待对方确认。因此，使用UDP协议可以随时发送数据，但无法保证数据能否成功被目标主机接收

### 第8章 DHCP协议

动态主机配置协议（Dynamic Host Configuration Protocol, DHCP）是基于UDP协议工作的网络配置协议。该协议主要用于集中管理和分配IP地址，帮助网络内的主机获取IP地址、网关和DNS服务器地址。DHCP服务是基于该协议的服务。本节将详细讲解DHCP协议和DHCP服务工作原理。

### 8.1 地址分配

在动态分配方式中，如果DHCP服务器不在线或出现故障等情况时，客户机就无法获取地址。这时，有些系统将会通过零配置技术为自己分配一个私有的地址，范围为169.254.0.0~169.254.255.255。

### 8.2 DHCP工作方式

DHCP服务器使用的是UDP 67端口，DHCP客户端使用的是UDP 68端口。本节将详细讲解DHCP工作方式的4个阶段，即发现阶段、提供阶段、选择阶段和确认阶段。

DHCP客户端向所有DHCP服务器的UDP 67端口发送广播数据包以获取IP地址租约，这个数据包被称为DHCP Discover消息。任何收到这个包的DHCP服务器都可以响应这个请求

DHCP客户端收到地址信息后，会选择第一个到达的租约地址信息。然后发起DHCP Request广播消息，告诉所有DHCP服务器，自己已经做出选择，接受了第一个DHCP服务器的地址。

### 第9章 DNS协议

域名系统（Domain Name System, DNS）是将域名转化为IP地址的网络协议。当用户在浏览器中输入域名后，浏览器会向DNS服务器发送DNS请求，获取指定域名的IP地址。DNS服务器收到请求包后，会发送响应包，返回对应的IP地址。浏览器根据响应包中的IP地址，访问对应的网站。本章将详细讲解DNS协议的构成。

### 9.1 域名

在TCP/IP网络中，计算机要进行通信首先需要从DHCP服务器上获取IP地址，然后基于IP地址进行通信。由于IP地址是由一串数字序列组成，所以难以记忆。并且，计算机的IP地址往往不是固定的，是经常变化的。因此，直接使用IP地址进行通信有很多不便之处。为了避免这些不便，可以为每台计算机赋予唯一的名称，即域名。计算机之间可以使用域名进行通信。

### 第10章 Telnet协议

使用者在自己的电脑上使用Telnet程序连接到服务器。然后，在Telnet程序中输入命令，这些命令将会在服务器上运行，就像直接在服务器的控制台上输入一样。

### 10.2 使用Telnet服务

行模式是指每输入一行信息并按回车键换行时，再将这行信息发送给服务器。在该模式下，服务器不会进行回显。下面介绍行模式的通信过程。

### 第12章 WHOIS协议

WHOIS是用来查询域名或IP所有者信息的传输协议。它可以用来查询域名是否已经被注册，以及注册者的详细信息

### 12.2 获取WHOIS服务器

WHOIS服务器通常由域名注册商和分销商搭建。在域名注册的时候，注册人通常将信息提交给域名注册商或其分销商。因此，用户可以从域名注册商和分销商的WHOIS服务器获取域名的相关注册信息。

### 第13章 FTP协议

文件传输协议（File Transfer Protocol, FTP）是一种提供网络之间共享文件的协议。它可以在计算机之间可靠、高效地传送文件。在传输时，传输双方的操作系统、磁盘文件系统类型可以不同。

### 13.1 FTP协议概述

·数据连接：每当一个文件在客户端与服务器之间进行传输时，就会创建数据连接。
·该连接主要用来进行文件传输。

在使用FTP进行文件传输时，针对不同的文件类型，FTP提供了两种文件传输模式，分别为ASCII和二进制。这两种模式支持的文件如下：
·ASCII：用于传输简单的文本文件，为默认类型。
·二进制：用于传输程序文件、字处理文档、可执行文件或图片。

### 14.1 TFTP协议概述

TFTP基于UDP协议进行文件传输。与FTP协议不同的是，TFTP传输文件时不需要用户进行登录。它只能从文件服务器上下载或上传文件，不能列出目录。